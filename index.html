<!-- HyperRush Chat App | 2026 | MIT License -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5962/5962463.png">
    <title>HyperRush Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root{--bg:#fff;--surface:#fff;--border:#e2e2e7;--text-main:#1c1c1e;--text-mute:#636366;--accent:#007aff;--danger:#ff3b30;--success:#34c759;--warning:#ff9500;--pad:32px}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Plus Jakarta Sans',sans-serif;-webkit-tap-highlight-color:transparent}
        ::-webkit-scrollbar{width:0;height:0}
        body{height:100dvh;background:#f2f2f7;color:var(--text-main);display:flex;justify-content:center;align-items:center;overflow:hidden}
        #app{width:100%;max-width:440px;height:100%;position:relative;display:flex;flex-direction:column;background:var(--bg);box-shadow:0 0 50px rgb(0 0 0 / .1);overflow:hidden}
        .screen{position:absolute;inset:0;display:none;flex-direction:column;padding:var(--pad);background:var(--bg);will-change:transform,opacity;padding-top:calc(var(--pad) + 10px);transition:transform 0.35s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.35s ease}
        .screen.active{display:flex;animation:instantFade 0.1s ease-out}
        .screen.slide-left{transform:translateX(-100%);opacity:0}.screen.slide-right{transform:translateX(100%);opacity:0}
        @keyframes instantFade{from{opacity:0;transform:scale(0.99)}to{opacity:1;transform:scale(1)}}
        .center-content{justify-content:center;align-items:center;text-align:center}
        
        /* HEADER LAYOUT - FLEX LOGIC */
        .header{
            display:flex; 
            align-items:center; 
            justify-content:space-between; 
            gap:12px; /* Zorgt voor vaste marge tussen titel en icons */
            padding-bottom:20px; 
            border-bottom:1px solid var(--border); 
            margin-bottom:32px; 
            flex-shrink:0; 
            padding-top:8px
        }

        .online-indicator{display:inline-flex;align-items:center;gap:6px;background:rgba(0,0,0,.05);padding:4px 10px;border-radius:8px;font-size:11px;font-weight:800;line-height:1;align-self:center;color:var(--success)!important;flex-shrink:0}
        .dot{width:6px;height:6px;background:var(--success)!important;border-radius:50%;animation:pulse 2s ease-in-out infinite}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(0.9)}}
        
        .title{font-size:26px;font-weight:800;letter-spacing:-.8px;color:#000;margin-bottom:4px;display:flex;align-items:center;justify-content:center;gap:10px;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:1;min-width:0}
        .subtitle{color:var(--text-mute);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:32px;display:block}
        .input-field{width:100%;background:#f2f2f7;border:1px solid transparent;border-radius:12px;padding:16px;color:var(--text-main);font-size:16px;outline:none;margin-bottom:16px;transition:.1s}
        .input-field:focus{border-color:var(--accent);background:#fff}
        .input-field:disabled{opacity:0.6;cursor:not-allowed}
        .btn{width:100%;height:56px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text-main);font-weight:700;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:.1s}
        .btn-accent{background:var(--text-main);color:#fff;border:none}
        .btn:active{transform:scale(.96);opacity:.8}
        .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        #toast-container{position:absolute;top:40px;left:50%;transform:translateX(-50%);z-index:3200;width:85%;pointer-events:none;display:flex;flex-direction:column;align-items:center}
        .toast-item{background:rgba(28,28,30,0.95);backdrop-filter:blur(22px);color:#fff;padding:14px 22px;border-radius:80px;font-weight:600;font-size:13px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.2);animation:slideUp 0.25s cubic-bezier(0.2,1,0.3,1);pointer-events:auto;cursor:pointer;width:100%;margin-bottom:8px}
        @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
        #offline-screen,#block-overlay,#capacity-overlay{position:absolute;inset:0;background:var(--bg);z-index:6000;display:none;flex-direction:column;align-items:center;justify-content:center;padding:var(--pad);text-align:center}
        #offline-screen.active,#block-overlay.active,#capacity-overlay.active{display:flex}
        #loader-overlay{position:absolute;inset:0;background:rgba(255,255,255,.98);backdrop-filter:blur(12px);z-index:3500;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px}
        #loader-overlay:not(.active){display:none}
        .spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .5s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loader-text{font-size:13px;font-weight:700;color:var(--text-mute);margin-top:4px;text-align:center}
        .room-card{padding:20px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:space-between;cursor:pointer;border:1px solid var(--border);margin-bottom:12px;transition:.1s;width:100%}
        .room-card:active{transform:scale(.98);background:#f9f9f9}
        .room-name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700;margin-right:10px}
        .room-icon{flex-shrink:0;display:flex;align-items:center;gap:5px}
        #chat-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding:4px;position:relative}
        .date-divider{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:center;margin:10px 0}
        .date-label{width:25%;margin:0 auto;background:rgba(255,255,255,.9);backdrop-filter:blur(4px);padding:6px 0;border-radius:20px;font-size:11px;font-weight:800;color:var(--text-mute);border:1px solid var(--border);box-shadow:0 2px 10px rgba(0,0,0,.05);text-transform:uppercase;letter-spacing:.5px;text-align:center}
        .msg{width:fit-content;max-width:85%;padding:10px 14px;border-radius:16px;background:#f2f2f7;font-size:15px;line-height:1.4;display:flex;flex-direction:column;white-space:pre-wrap;word-break:break-word;position:relative}
        .msg.me{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:2px}
        .msg-user{font-size:10px;font-weight:800;color:var(--accent);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;display:flex;align-items:center;gap:6px;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .msg.me .msg-user{color:rgba(255,255,255,.7)}
        .msg-time{font-size:9px;opacity:.6;text-align:right;margin-top:4px}
        .switch{position:relative;display:inline-block;width:44px;height:24px}.switch input{opacity:0;width:0;height:0}
        .slider{position:absolute;cursor:pointer;inset:0;background-color:#ccc;transition:.2s;border-radius:24px}
        .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:#fff;transition:.2s;border-radius:50%}
        input:checked+.slider{background-color:var(--accent)}input:checked+.slider:before{transform:translateX(20px)}
        .clickable:active{opacity:.5;transform:scale(.9)}
        #overlay-container{position:absolute;inset:0;background:rgba(0,0,0,0.4);backdrop-filter:blur(12px);z-index:5000;display:none;align-items:center;justify-content:center;padding:var(--pad)}
        #overlay-container.active{display:flex}
        .panel-card{background:var(--bg);width:100%;max-width:380px;border-radius:24px;padding:24px;box-shadow:0 30px 60px rgba(0,0,0,0.3);animation:panelSlide .4s cubic-bezier(.16,1,.3,1);max-height:90vh;overflow-y:auto}
        @keyframes panelSlide{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
        .panel-row{display:flex;align-items:center;gap:15px;margin-bottom:12px;padding:14px;background:#f2f2f7;border-radius:14px;cursor:pointer;transition:.2s}
        .panel-row:hover{background:#e5e5ea}
        .p-info{display:flex;flex-direction:column;flex:1;min-width:0}.p-label{font-size:11px;font-weight:800;color:var(--text-mute);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
        .p-value{font-size:14px;font-weight:600;color:var(--text-main);word-break:break-all}
        .view-content{display:none}.view-content.active{display:block}
        .guide-box{background:#f2f2f7;padding:14px;border-radius:14px;margin-bottom:12px;font-size:13px;line-height:1.5}
        .guide-box b{color:var(--accent);display:block;margin-bottom:4px;font-size:11px;text-transform:uppercase}
        
        /* Rate Limiting UI */
        .rate-limited { opacity: 0.5; pointer-events: none; transition: opacity 0.2s; }
        
        .guest-replies-bar{display:flex;gap:10px;overflow-x:auto;padding:8px 0;width:100%;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory}
        .guest-replies-bar::-webkit-scrollbar{display:none}
        .reply-block{flex:0 0 auto;padding:12px 20px;background:#f2f2f7;border:1px solid var(--border);border-radius:20px;font-weight:600;font-size:14px;white-space:nowrap;scroll-snap-align:start;cursor:pointer;transition:0.1s}
        .reply-block:active{transform:scale(0.95);background:var(--accent);color:#fff;border-color:var(--accent)}
        
        .guest-pill{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:12px;background:rgba(0,122,255,0.1);color:var(--accent);font-size:9px;font-weight:800;text-transform:uppercase;line-height:1;margin-left:6px;letter-spacing:0.3px}
        .msg.me .guest-pill{background:rgba(255,255,255,0.15);color:#fff}
        .bottom-hint{position:absolute;bottom:30px;left:0;right:0;text-align:center;font-size:12px;font-weight:700;color:var(--text-mute);display:flex;align-items:center;justify-content:center;gap:8px;opacity:0;animation:fadeInHint 1s ease 2s forwards;pointer-events:auto;cursor:pointer}
        @keyframes fadeInHint{to{opacity:0.6}}
        
        /* Header Layout Logic */
        .header-action-group{
            display:flex;
            gap:14px;
            align-items:center;
            flex-shrink:0; /* Icons never shrink */
        }
        .chat-header-title-wrapper{
            display:flex;
            align-items:center;
            gap:12px;
            flex:1; /* Takes available space */
            min-width:0; /* Allows shrinking */
        }
        
        /* Specific Title styling for Chat Header to allow ellipsis */
        .chat-header-title-wrapper .title {
            display: block; /* Override flex for text-overflow */
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 18px;
            margin: 0;
            text-align: left;
        }

        .input-wrapper{position:relative;width:100%;margin-bottom:16px}
        .input-wrapper .input-field{margin-bottom:0;padding-right:44px}
        .input-lock-icon{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:var(--text-mute);pointer-events:none}
        .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
        .stat-box{text-align:center;padding:16px;background:#f2f2f7;border-radius:14px}
        .stat-value{font-size:24px;font-weight:800;color:var(--accent);margin-bottom:4px}
        .stat-label{font-size:10px;font-weight:700;color:var(--text-mute);text-transform:uppercase}
        .chat-link{color:inherit;text-decoration:underline;text-decoration-color:rgba(255,255,255,0.4);transition:color 0.2s}
        .msg:not(.me) .chat-link{color:var(--accent);text-decoration-color:rgba(0,122,255,0.3)}
        .chat-link:hover{opacity:0.8}
        .history-loader{text-align:center;padding:10px;color:var(--text-mute);font-size:12px;font-weight:600}
        .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 20px;color:var(--text-mute);width:100%}
        .empty-state-icon{width:48px;height:48px;color:#d1d1d6;margin-bottom:16px}
        .empty-state-title{font-size:15px;font-weight:700;color:var(--text-main);margin-bottom:4px}
        .empty-state-sub{font-size:13px;font-weight:500}
        #chat-empty-state{position:absolute;inset:0;pointer-events:none;z-index:5;background:var(--bg)}
    </style>
</head>
<body>
    <div id="app">
        <div id="capacity-overlay">
            <i data-lucide="users" style="width:48px;height:48px;margin-bottom:24px;color:var(--danger)"></i>
            <h1 class="title">Network Full</h1>
            <p class="subtitle" style="margin-bottom:48px">Maximum capacity reached.</p>
            <button class="btn btn-accent" onclick="window.retryConnection()">Retry</button>
        </div>
        <div id="overlay-container">
            <div class="panel-card">
                <div id="view-hub" class="view-content active">
                    <div style="text-align:center;margin-bottom:24px">
                        <h2 style="font-size:22px;font-weight:800;letter-spacing:-0.5px">Intelligence Hub</h2>
                        <p style="font-size:11px;color:var(--text-mute);font-weight:700;text-transform:uppercase">System Resources</p>
                    </div>
                    <div class="panel-row" onclick="window.prepareMyAccount()">
                        <i data-lucide="shield-check" style="color:var(--text-main)"></i>
                        <div class="p-info"><span style="font-weight:700;font-size:14px">My Account</span><span style="font-size:11px;color:var(--text-mute)">Secure credentials</span></div>
                    </div>
                    <div class="panel-row" onclick="window.showOverlayView('network')">
                        <i data-lucide="activity"></i>
                        <div class="p-info"><span style="font-weight:700;font-size:14px">Protocols</span><span style="font-size:11px;color:var(--text-mute)">Network state</span></div>
                    </div>
                    <div class="panel-row" onclick="window.showOverlayView('guide')">
                        <i data-lucide="book-open"></i>
                        <div class="p-info"><span style="font-weight:700;font-size:14px">Manual</span><span style="font-size:11px;color:var(--text-mute)">Usage guide</span></div>
                    </div>
                    <button class="btn btn-accent" style="height:52px;margin-top:12px;width:100%" onclick="window.closeOverlay()">Close Hub</button>
                </div>
                <div id="view-my-account" class="view-content">
                    <h3 style="margin-bottom:20px;font-weight:800;font-size:18px">My Account</h3>
                    <div style="display:flex;flex-direction:column;gap:10px">
                        <div class="p-info" style="padding:12px;background:#f2f2f7;border-radius:12px"><span class="p-label">Identity</span><span class="p-value" id="my-acc-name">---</span></div>
                        <div class="p-info" style="padding:12px;background:#f2f2f7;border-radius:12px"><span class="p-label">Unique ID</span><span class="p-value" id="my-acc-id" style="font-family:monospace;font-size:11px">---</span></div>
                        <div class="p-info" style="padding:12px;background:#f2f2f7;border-radius:12px"><span class="p-label">Mail Node</span><span class="p-value" id="my-acc-email">---</span></div>
                        <div class="p-info" style="padding:12px;background:#f2f2f7;border-radius:12px"><span class="p-label">Account Type</span><span class="p-value" id="my-acc-type">---</span></div>
                    </div>
                    <button class="btn" style="height:48px;margin-top:24px;width:100%;border:none;background:#f2f2f7" onclick="window.showOverlayView('hub')">Back</button>
                </div>
                <div id="view-quick-view-user" class="view-content">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
                        <div style="width:44px;height:44px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px" id="qv-user-avatar">?</div>
                        <div style="display:flex;flex-direction:column;min-width:0"><span id="qv-user-name" style="font-weight:800;font-size:18px;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">---</span><span id="qv-status" style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px">---</span></div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:10px">
                        <div class="p-info" style="padding:14px;background:#f2f2f7;border-radius:14px"><span class="p-label">Full Name</span><span class="p-value" id="qv-full-name">---</span></div>
                        <div class="p-info" style="padding:14px;background:#f2f2f7;border-radius:14px"><span class="p-label">System ID</span><span class="p-value" id="qv-user-id" style="font-family:monospace;font-size:11px">---</span></div>
                        <div class="p-info" style="padding:14px;background:#f2f2f7;border-radius:14px"><span class="p-label">Created At</span><span class="p-value" id="qv-user-date">---</span></div>
                    </div>
                    <button class="btn btn-accent" style="height:52px;margin-top:24px;width:100%" onclick="window.closeOverlay()">Dismiss</button>
                </div>
                <div id="view-network" class="view-content">
                    <h3 style="margin-bottom:20px;font-weight:800;font-size:18px">Network Status</h3>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="hub-online-count">--</div>
                            <div class="stat-label">Users Online</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="hub-uptime">00:00</div>
                            <div class="stat-label">Session Uptime</div>
                        </div>
                    </div>
                    <button class="btn" style="height:48px;margin-top:16px;width:100%;border:none;background:#f2f2f7" onclick="window.showOverlayView('hub')">Back</button>
                </div>
                <div id="view-guide" class="view-content">
                    <h3 style="margin-bottom:20px;font-weight:800;font-size:18px">Extended Manual</h3>
                    <div style="max-height:320px;overflow-y:auto;padding-right:4px">
                        <div class="guide-box"><b>SignIn & Register</b>Use a valid email. The 6-digit code expires after 10 minutes. Passwords must be at least 8 characters.</div>
                        <div class="guide-box"><b>Guest Mode</b>Guests cannot create rooms. They can only choose from predefined messages. Name cannot be changed once set.</div>
                        <div class="guide-box"><b>Private Rooms</b>Hidden from list. Requires a password to join.</div>
                        <div class="guide-box"><b>Privacy & Data</b>Messages are end-to-end encrypted. Email addresses are private.</div>
                    </div>
                    <button class="btn" style="height:48px;margin-top:16px;width:100%;border:none;background:#f2f2f7" onclick="window.showOverlayView('hub')">Back</button>
                </div>
                <div id="view-guest-info" class="view-content">
                    <h3 style="margin-bottom:20px;font-weight:800;font-size:18px">Guest Limitations</h3>
                    <div style="display:flex;flex-direction:column;gap:10px">
                        <div class="p-info" style="padding:14px;background:#f2f2f7;border-radius:14px;border-left:4px solid var(--danger)"><span style="font-weight:700;font-size:14px;color:var(--danger)">Room Creation</span><span style="font-size:12px;color:var(--text-mute)">Guests cannot create new rooms.</span></div>
                        <div class="p-info" style="padding:14px;background:#f2f2f7;border-radius:14px;border-left:4px solid var(--danger)"><span style="font-weight:700;font-size:14px;color:var(--danger)">Custom Messages</span><span style="font-size:12px;color:var(--text-mute)">You can only send selected replies.</span></div>
                    </div>
                    <button class="btn btn-accent" style="height:52px;margin-top:24px;width:100%" onclick="window.closeOverlay()">Understood</button>
                </div>
                <div id="view-guest-warn" class="view-content">
                    <h3 style="margin-bottom:20px;font-weight:800;font-size:18px">Guest Confirmation</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;font-size:13px;line-height:1.5;color:var(--text-mute);margin-bottom:20px">
                        <div class="p-info" style="padding:14px;background:#f2f2f7;border-radius:14px">You are about to create a <b style="color:var(--text-main)">Guest Account</b>.</div>
                        <div class="p-info" style="padding:14px;background:#f2f2f7;border-radius:14px;border-left:4px solid var(--danger)">Your name will be locked forever for this session.</div>
                    </div>
                    <button id="btn-confirm-guest" class="btn btn-accent" style="height:52px;width:100%" onclick="window.confirmGuestLoginAction(event)">I Understand, Continue</button>
                    <button id="btn-cancel-guest" class="btn" style="height:48px;margin-top:12px;width:100%;border:none;background:#f2f2f7" onclick="window.closeOverlay()">Cancel</button>
                </div>
            </div>
        </div>
        <div id="block-overlay">
            <i data-lucide="copy" style="width:48px;height:48px;margin-bottom:24px;color:var(--warning)"></i>
            <h1 class="title">Active Session</h1>
            <p class="subtitle" style="margin-bottom:48px">HRN Chat is open in another tab.</p>
            <button class="btn btn-accent" onclick="window.forceClaimMaster()">Use Here</button>
            <button class="btn" style="margin-top:12px;border:none;background:#f2f2f7" onclick="window.closeTabAttempt()">Close Tab</button>
        </div>
        <div id="offline-screen">
            <i data-lucide="wifi-off" style="width:48px;height:48px;margin-bottom:24px;color:var(--text-main);opacity:0.9"></i>
            <h1 class="title">No Signal</h1>
            <p class="subtitle" style="margin-bottom:48px">Waiting for a secure link...</p>
        </div>
        <div id="loader-overlay" class="active">
            <div class="spinner"></div>
            <span id="loader-text" class="loader-text">Initializing...</span>
        </div>
        <div id="toast-container"></div>
        <div id="scr-start" class="screen active center-content">
            <div class="start-icon-container" style="transform:translateY(-20px);margin-bottom:20px"><i data-lucide="shield" style="width:36px;height:36px;stroke-width:1.5;color:var(--accent)"></i></div>
            <h1 class="title">HRN Chat</h1>
            <p class="subtitle">Secure Network 2026</p>
            <button class="btn btn-accent auth-btn" onclick="window.nav('scr-login')" style="margin-bottom:16px">Sign In</button>
            <button class="btn auth-btn" onclick="window.nav('scr-register')">Create Account</button>
            <div id="guest-swipe-hint" class="bottom-hint" onclick="window.nav('scr-guest', 'left')"><i data-lucide="chevron-left" style="width:16px;height:16px"></i><span>Swipe for Guest Access</span></div>
        </div>
        <div id="scr-guest" class="screen center-content">
            <i data-lucide="user" style="width:32px;height:32px;color:var(--accent);margin-bottom:16px"></i>
            <h1 class="title">Guest Access</h1>
            <p class="subtitle">Persistent Session</p>
            <div class="input-wrapper">
                <input id="g-name" class="input-field" placeholder="Enter Name (Permanent)">
                <i data-lucide="lock" class="input-lock-icon" style="display:none;width:18px;height:18px;"></i>
            </div>
            <button class="btn btn-accent" onclick="window.handleGuestLogin(event)">Enter Lobby</button>
            <div id="guest-back-hint" class="bottom-hint" onclick="window.nav('scr-start', 'right')"><i data-lucide="chevron-left" style="width:16px;height:16px"></i><span>Back to Home</span></div>
        </div>
        <div id="scr-login" class="screen center-content">
            <h1 class="title">Sign In</h1><p class="subtitle">Access Secure Room</p>
            <input id="l-email" class="input-field" type="email" placeholder="Email Address">
            <input id="l-pass" type="password" class="input-field" placeholder="Password">
            <button class="btn btn-accent auth-btn" onclick="window.handleLogin(event)">Access</button>
            <button class="btn" style="border:none;margin-top:12px" onclick="window.nav('scr-start')">Back</button>
        </div>
        <div id="scr-register" class="screen center-content">
            <h1 class="title">Sign Up</h1><p class="subtitle">Join the Network</p>
            <input id="r-name" class="input-field" placeholder="Full Name">
            <input id="r-email" class="input-field" type="email" placeholder="Email Address">
            <input id="r-pass" class="input-field" type="password" placeholder="Password (min. 8 chars)">
            <button class="btn btn-accent auth-btn" onclick="window.handleRegister(event)">Verify</button>
            <button class="btn" style="border:none;margin-top:12px" onclick="window.nav('scr-start')">Back</button>
        </div>
        <div id="scr-verify" class="screen center-content">
            <h1 class="title">Verify</h1><p class="subtitle">Confirm Identity</p>
            <input id="v-code" class="input-field" style="text-align:center;font-size:24px" placeholder="000000">
            <button class="btn btn-accent" onclick="window.handleVerify(event)">Confirm</button>
            <div id="v-timer" style="margin-top:20px;font-weight:800;color:var(--accent)">10:00</div>
        </div>
        <div id="scr-lobby" class="screen">
            <div class="header">
                <div style="display:flex;align-items:center;gap:10px;min-width:0;flex:1"><h1 class="title" style="font-size:22px;margin:0">Rooms</h1><span class="online-indicator" style="padding:2px 8px;font-size:10px"><div class="dot"></div><span class="live-count">--</span></span></div>
                <div class="header-action-group">
                    <span class="clickable" onclick="window.openHub()"><i data-lucide="info" style="width:22px;height:22px"></i></span>
                    <span class="clickable" id="icon-plus-lobby" onclick="window.nav('scr-create')"><i data-lucide="plus" style="width:22px;height:22px"></i></span>
                    <span class="clickable" onclick="window.handleLogout(event)"><i data-lucide="log-out" style="width:22px;height:22px"></i></span>
                </div>
            </div>
            <input id="search-bar" class="input-field" placeholder="Filter secure rooms..." oninput="window.filterRooms()">
            <div id="room-list" style="flex:1;overflow-y:auto"></div>
            <div style="display:flex;gap:12px;margin-top:20px"><input id="join-id" class="input-field" style="margin:0;flex:1" placeholder="Direct ID"><button class="btn btn-accent" style="width:80px" onclick="window.joinPrivate()">Join</button></div>
        </div>
        <div id="scr-chat" class="screen">
            <div class="header" style="margin-bottom:16px">
                <div class="chat-header-title-wrapper">
                    <span class="clickable" onclick="window.leaveChat()" style="flex-shrink:0"><i data-lucide="chevron-left" style="width:24px;height:24px"></i></span>
                    <h2 id="chat-title" class="title">---</h2>
                </div>
                <div class="header-action-group">
                    <span class="clickable" id="guest-info-chat" style="display:none" onclick="window.showGuestInfo()"><i data-lucide="info" style="width:22px;height:22px"></i></span>
                    <span class="clickable" id="copy-btn-wrapper" onclick="window.copyId()"><i data-lucide="copy" id="icon-copy-chat" style="width:22px;height:22px"></i><i data-lucide="check" id="icon-check-chat" style="width:22px;height:22px;display:none;color:var(--success)"></i></span>
                </div>
            </div>
            <div id="chat-messages" style="position:relative">
                <div id="chat-empty-state" class="empty-state">
                    <i data-lucide="message-circle" class="empty-state-icon"></i>
                    <div class="empty-state-title">No messages yet</div>
                    <div class="empty-state-sub">Be the first to say something.</div>
                </div>
            </div>
            <div id="chat-input-area" style="display:flex;gap:12px;padding-top:16px">
                <textarea id="chat-input" class="input-field" style="margin:0;flex:1;height:52px;resize:none" placeholder="Secure message..."></textarea>
                <div id="guest-replies" class="guest-replies-bar" style="display:none">
                    <div class="reply-block" onclick="window.sendGuestReply(event, 'Hello!')">Hello!</div>
                    <div class="reply-block" onclick="window.sendGuestReply(event, 'How is it going?')">How is it going?</div>
                    <div class="reply-block" onclick="window.sendGuestReply(event, 'Good to be here.')">Good to be here.</div>
                    <div class="reply-block" onclick="window.sendGuestReply(event, 'I agree.')">I agree.</div>
                </div>
                <button id="send-btn" class="btn btn-accent" style="width:52px;height:52px" onclick="window.sendMsg(event)"><i data-lucide="arrow-up" style="width:20px;height:20px"></i></button>
            </div>
        </div>
        <div id="scr-create" class="screen center-content">
            <h1 class="title">Create</h1><p class="subtitle">Deploy New Room</p>
            <input id="c-name" class="input-field" placeholder="Room Name">
            <input id="c-pass" class="input-field" type="password" placeholder="Passkey (Required for Private)">
            <div style="display:flex;justify-content:space-between;align-items:center;width:100%;padding:18px;background:#f2f2f7;border-radius:12px;margin-bottom:20px"><span style="font-weight:700">Private Room</span><label class="switch"><input type="checkbox" id="c-private" onchange="window.handlePrivateToggle()"><span class="slider"></span></label></div>
            <button class="btn btn-accent" onclick="window.handleCreate(event)">Deploy</button>
            <button class="btn" style="border:none;margin-top:12px" onclick="window.nav('scr-lobby')">Cancel</button>
        </div>
        <div id="scr-gate" class="screen center-content">
            <h1 class="title">Encrypted</h1><p class="subtitle">Authentication Required</p>
            <input id="gate-pass" type="password" class="input-field" style="text-align:center" placeholder="Passkey">
            <button class="btn btn-accent" onclick="window.submitGate(event)">Decrypt</button>
            <button class="btn" style="border:none;margin-top:12px" onclick="window.nav('scr-lobby')">Abort</button>
        </div>
        <div id="scr-success" class="screen center-content">
            <h1 class="title">Room Created</h1><p class="subtitle">Deployment Successful</p>
            <div id="s-id" class="input-field" style="text-align:center;color:var(--accent);font-weight:800;border:1px dashed var(--accent)" onclick="window.copySId()">---</div>
            <button class="btn btn-accent" onclick="window.enterCreated()">Enter</button>
        </div>
    </div>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        function startChatApp(customConfig = {}) {
            const CONFIG = {
                supabaseUrl: customConfig.supabaseUrl || "https://fahbqdajxnhswevdagdn.supabase.co",
                supabaseKey: customConfig.supabaseKey || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhaGJxZGFqeG5oc3dldmRhZ2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTEyODEsImV4cCI6MjA4NjEyNzI4MX0.UPgPxyaWBULjH4jL8UaSr6bJXTsFWWJRIYodHmXeVTI",
                mailApi: customConfig.mailApi || "https://vercel-serverless-gray-sigma.vercel.app/api/mailAPI",
                maxUsers: customConfig.maxUsers || 475,
                maxMessages: customConfig.maxMessages || 15,
                historyLoadLimit: customConfig.historyLoadLimit || 10,
                rateLimitMs: customConfig.rateLimitMs || 1000,
                presenceHeartbeatMs: customConfig.presenceHeartbeatMs || 10000,
                reconnectDebounceMs: customConfig.reconnectDebounceMs || 3000,
                verificationCodeExpiry: customConfig.verificationCodeExpiry || 600,
            };

            lucide.createIcons();

            const state = {
                user: null,
                currentRoomId: null,
                chatChannel: null,
                presenceChannel: null,
                allRooms: [],
                vTimer: null,
                lastRenderedDateLabel: null,
                lastKnownOnlineCount: null,
                heartbeatInterval: null,
                uptimeInterval: null,
                sessionStartTime: null,
                isPresenceSubscribed: false,
                lastReconnectAttempt: 0,
                roomGuestStatus: {},
                pending: null,
                lastCreated: null,
                lastCreatedPass: null,
                isMasterTab: false,
                tabId: sessionStorage.getItem('hrn_tab_id') || (sessionStorage.setItem('hrn_tab_id', crypto.randomUUID()), sessionStorage.getItem('hrn_tab_id')),
                processingAction: false,
                serverFull: false,
                isLoadingHistory: false,
                oldestMessageTimestamp: null,
                hasMoreHistory: true,
                lastMessageTime: 0,
                isConnecting: false
            };

            const FLAG_LOGOUT = 'hrn_flag_force_logout';
            const FLAG_GUEST_NAME = 'hrn_flag_guest_name';
            const FLAG_GUEST_ID = 'hrn_flag_guest_id';

            let toastQueue = [];
            let toastVisible = false;
            const tabChannel = new BroadcastChannel('hrn_tab_sync');
            const db = createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey, { 
                auth: { persistSession: true, autoRefreshToken: true }, 
                realtime: { params: { eventsPerSecond: 10 } } 
            });

            const esc = t => { const p = document.createElement('p'); p.textContent = t; return p.innerHTML; };
            const $ = id => document.getElementById(id);
            
            const updateOnlineDisplay = (count) => {
                if (typeof count === 'number') state.lastKnownOnlineCount = count;
                const displayCount = (typeof count === 'number') ? count : '--';
                document.querySelectorAll('.live-count').forEach(el => { if(el.innerText !== displayCount) el.innerText = displayCount; });
                const hubCount = $('hub-online-count');
                if (hubCount && hubCount.innerText !== displayCount) hubCount.innerText = displayCount;
            };

            const updateUptime = () => {
                if(!state.sessionStartTime) return;
                const diff = Math.floor((Date.now() - state.sessionStartTime) / 1000);
                const mins = Math.floor(diff / 60).toString().padStart(2, '0');
                const secs = (diff % 60).toString().padStart(2, '0');
                const el = $('hub-uptime');
                if(el) el.innerText = `${mins}:${secs}`;
            };

            const processToastQueue = () => {
                if (toastVisible || toastQueue.length === 0) return;
                toastVisible = true;
                const msg = toastQueue.shift();
                const c = $('toast-container');
                const t = document.createElement('div');
                t.className = 'toast-item'; 
                t.innerText = msg;
                t.onclick = () => { t.style.opacity = '0'; setTimeout(() => { t.remove(); toastVisible = false; processToastQueue(); }, 400); };
                c.appendChild(t);
                setTimeout(() => { if (t.parentNode) { t.style.opacity = '0'; setTimeout(() => { if(t.parentNode) t.remove(); toastVisible = false; processToastQueue(); }, 400); } }, 3000);
            };

            window.toast = m => { toastQueue.push(m); processToastQueue(); };
            window.setLoading = (s, text = null) => { 
                const loader = $('loader-overlay'); 
                const loaderText = $('loader-text'); 
                if(s) loader.classList.add('active');
                else loader.classList.remove('active');
                if(text) loaderText.innerText = text; else loaderText.innerText = "Loading..."; 
            };

            const safeAwait = async (promise) => {
                try { return [await promise, null]; } 
                catch (error) { return [null, error]; }
            };

            const workerCode = `
                self.onmessage = async (e) => {
                    const { type, payload } = e.data;
                    const encoder = new TextEncoder();
                    const decoder = new TextDecoder();
                    try {
                        if (type === 'deriveKey') {
                            const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(payload.password), { name: 'PBKDF2' }, false, ['deriveKey']);
                            const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: encoder.encode(payload.salt), iterations: 300000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);
                            self.cryptoKey = key;
                            self.postMessage({ type: 'keyDerived', success: true });
                        } else if (type === 'encrypt') {
                            if (!self.cryptoKey) throw new Error("Key not derived");
                            const iv = crypto.getRandomValues(new Uint8Array(12));
                            const encoded = encoder.encode(payload.text);
                            const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, self.cryptoKey, encoded);
                            const combined = new Uint8Array(iv.length + ciphertext.byteLength);
                            combined.set(iv, 0); combined.set(new Uint8Array(ciphertext), iv.length);
                            const base64 = btoa(String.fromCharCode(...combined));
                            self.postMessage({ type: 'encrypted', result: base64 });
                        } else if (type === 'decryptHistory') {
                            if (!self.cryptoKey) throw new Error("Key not derived");
                            const results = [];
                            for (const m of payload.messages) {
                                try {
                                    const binary = atob(m.content);
                                    const bytes = new Uint8Array(binary.length);
                                    for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
                                    const iv = bytes.slice(0, 12);
                                    const ciphertext = bytes.slice(12);
                                    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);
                                    const text = decoder.decode(decrypted);
                                    const parts = text.split('|');
                                    results.push({ id: m.id, time: parts[0], text: parts.slice(1).join('|'), user_id: m.user_id, user_name: m.user_name, created_at: m.created_at });
                                } catch (err) { results.push({ id: m.id, error: true }); }
                            }
                            self.postMessage({ type: 'historyDecrypted', results });
                        } else if (type === 'decryptSingle') {
                             if (!self.cryptoKey) throw new Error("Key not derived");
                             try {
                                const binary = atob(payload.content);
                                const bytes = new Uint8Array(binary.length);
                                for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
                                const iv = bytes.slice(0, 12);
                                const ciphertext = bytes.slice(12);
                                const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);
                                const text = decoder.decode(decrypted);
                                const parts = text.split('|');
                                self.postMessage({ type: 'singleDecrypted', result: { time: parts[0], text: parts.slice(1).join('|') } });
                             } catch(e) { self.postMessage({ type: 'singleDecrypted', error: e.message }); }
                        }
                    } catch (error) { self.postMessage({ type: 'error', message: error.message }); }
                };
            `;
            
            const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
            const cryptoWorker = new Worker(URL.createObjectURL(workerBlob));
            const pendingCallbacks = {};

            cryptoWorker.onmessage = (e) => {
                const { type } = e.data;
                if (pendingCallbacks[type]) {
                    pendingCallbacks[type](e.data);
                    delete pendingCallbacks[type];
                }
            };

            const generateSalt = () => {
                const arr = new Uint8Array(16);
                crypto.getRandomValues(arr);
                return Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
            };

            const sha256 = async (text) => {
                const buffer = new TextEncoder().encode(text);
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            };

            const deriveKey = (pass, salt) => new Promise((resolve, reject) => {
                pendingCallbacks['keyDerived'] = (data) => { if(data.success) resolve(true); else reject("Key derivation failed"); };
                cryptoWorker.postMessage({ type: 'deriveKey', payload: { password: pass, salt: salt } });
            });

            const encryptMessage = (text) => new Promise((resolve, reject) => {
                pendingCallbacks['encrypted'] = (data) => { if(data.result) resolve(data.result); else reject("Encryption failed"); };
                const time = new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
                cryptoWorker.postMessage({ type: 'encrypt', payload: { text: time + "|" + text } });
            });

            const cleanupChannels = async () => {
                if (state.presenceChannel) {
                    try { await db.removeChannel(state.presenceChannel); } catch(e) {}
                    state.presenceChannel = null;
                    state.isPresenceSubscribed = false;
                }
                if (state.chatChannel) {
                    try { await db.removeChannel(state.chatChannel); } catch(e) {}
                    state.chatChannel = null;
                }
            };

            const initPresence = async (force = false) => {
                if (!state.isMasterTab || !state.user) return;
                
                const now = Date.now();
                if (!force && state.isConnecting) return;
                if (!force && (now - state.lastReconnectAttempt < CONFIG.reconnectDebounceMs)) return;
                
                state.lastReconnectAttempt = now;
                state.isConnecting = true;
                state.isPresenceSubscribed = false;

                if(state.presenceChannel) {
                    try { await db.removeChannel(state.presenceChannel); } catch(e) {}
                }

                updateOnlineDisplay(null);
                
                const myId = state.user.id;
                state.presenceChannel = db.channel('online-users', { config: { presence: { key: myId } } });
                
                state.presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    if (!state.presenceChannel) return;
                    const presState = state.presenceChannel.presenceState();
                    const allPresences = Object.values(presState).flat();
                    const uniqueUserIds = new Set(allPresences.map(p => p.user_id));
                    
                    if (uniqueUserIds.size > CONFIG.maxUsers) {
                        if(!state.serverFull) {
                            state.serverFull = true;
                            $('capacity-overlay').classList.add('active');
                            cleanupChannels();
                        }
                    } else {
                        updateOnlineDisplay(uniqueUserIds.size);
                    }
                })
                .subscribe(async (status, err) => {
                    if (status === 'SUBSCRIBED') {
                        if (!state.presenceChannel) return;
                        state.isPresenceSubscribed = true;
                        state.isConnecting = false;
                        await state.presenceChannel.track({ user_id: myId, online_at: new Date().toISOString() });
                        if (state.heartbeatInterval) clearInterval(state.heartbeatInterval);
                        state.heartbeatInterval = setInterval(async () => {
                            if (state.presenceChannel && state.isMasterTab && !state.serverFull) {
                                await state.presenceChannel.track({ user_id: myId, online_at: new Date().toISOString() });
                            }
                        }, CONFIG.presenceHeartbeatMs);
                    } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        state.isPresenceSubscribed = false;
                        state.isConnecting = false;
                        updateOnlineDisplay(null);
                    }
                });
            };

            const monitorConnection = () => {
                setInterval(() => {
                    if (!navigator.onLine) {
                        $('offline-screen').classList.add('active');
                        state.isPresenceSubscribed = false;
                        updateOnlineDisplay(null);
                        return;
                    }
                    
                    $('offline-screen').classList.remove('active');

                    if (!state.user || !state.isMasterTab) return;
                    if (state.currentRoomId) return; 

                    const wsState = db.realtime.connectionState();
                    if ((wsState === 'disconnected' || wsState === 'stopped') && !state.isConnecting) {
                         initPresence(true);
                    }
                }, 5000);
            };

            window.retryConnection = () => {
                $('capacity-overlay').classList.remove('active');
                state.serverFull = false;
                initPresence(true);
            };
            
            window.handlePrivateToggle = () => {
                const isPrivate = $('c-private').checked;
                const passInput = $('c-pass');
                passInput.placeholder = isPrivate ? "Passkey (Required)" : "Passkey (Optional)";
            };

            window.forceClaimMaster = () => {
                if (!state.isMasterTab) {
                    state.isMasterTab = true;
                    tabChannel.postMessage({ type: 'CLAIM_MASTER', id: state.tabId });
                    $('block-overlay').classList.remove('active');
                    if (localStorage.getItem(FLAG_LOGOUT) !== 'true' && state.user) {
                        initPresence(true);
                    }
                }
            };
            window.closeTabAttempt = () => { window.open('', '_self'); window.close(); };

            tabChannel.onmessage = (ev) => {
                if (ev.data.type === 'CLAIM_MASTER' && ev.data.id !== state.tabId) {
                    if (state.isMasterTab) {
                        cleanupChannels();
                        if (state.heartbeatInterval) clearInterval(state.heartbeatInterval);
                        state.heartbeatInterval = null;
                        state.isPresenceSubscribed = false;
                        state.isMasterTab = false;
                        updateOnlineDisplay(null);
                        const overlay = $('block-overlay');
                        overlay.innerHTML = `
                            <i data-lucide="log-out" style="width:48px;height:48px;margin-bottom:24px;color:var(--danger)"></i>
                            <h1 class="title">Session Moved</h1>
                            <p class="subtitle" style="margin-bottom:48px">You switched to a new tab.</p>
                            <button class="btn btn-accent" onclick="window.forceClaimMaster()">Use Here</button>
                        `;
                        overlay.classList.add('active');
                        lucide.createIcons();
                    }
                }
            };

            window.addEventListener('beforeunload', () => {
                tabChannel.postMessage({ type: 'CLAIM_MASTER', id: state.tabId });
            });

            const checkMaster = () => {
                return new Promise((resolve) => {
                    let masterFound = false;
                    const handler = (ev) => {
                        if (ev.data.type === 'PONG_MASTER') masterFound = true;
                    };
                    tabChannel.addEventListener('message', handler);
                    tabChannel.postMessage({ type: 'PING_MASTER' });
                    setTimeout(() => {
                        tabChannel.removeEventListener('message', handler);
                        resolve(masterFound);
                    }, 300);
                });
            };

            window.showGuestInfo = () => { $('overlay-container').classList.add('active'); window.showOverlayView('guest-info'); lucide.createIcons(); };
            window.openHub = () => { $('overlay-container').classList.add('active'); window.showOverlayView('hub'); lucide.createIcons(); };
            window.closeOverlay = () => $('overlay-container').classList.remove('active');
            
            window.showOverlayView = (viewId) => {
                const panel = document.querySelector('.panel-card');
                if(!panel) return;
                panel.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
                const target = $(`view-${viewId}`);
                if(target) {
                    target.classList.add('active');
                    lucide.createIcons();
                }
            };

            window.prepareMyAccount = () => {
                if(!state.user) return;
                const isGuest = state.user.is_anonymous;
                $('my-acc-name').innerText = state.user.user_metadata?.full_name || "User";
                $('my-acc-id').innerText = state.user.id;
                $('my-acc-email').innerText = isGuest ? "Guest Mode" : (state.user.email || "No email");
                $('my-acc-type').innerText = isGuest ? "Guest Account" : "Full Account";
                $('my-acc-type').style.color = isGuest ? "var(--warning)" : "var(--success)";
                window.showOverlayView('my-account');
            };

            window.inspectUser = async (uid) => {
                if (uid === state.user?.id) return window.prepareMyAccount();
                window.setLoading(true, "Fetching info...");
                const { data, error } = await db.from('profiles').select('id, full_name, updated_at, is_guest').eq('id', uid).single();
                window.setLoading(false);
                if (error || !data) return window.toast("User not found");
                
                $('qv-user-name').innerText = data.full_name;
                $('qv-user-avatar').innerText = data.full_name.charAt(0).toUpperCase();
                $('qv-user-id').innerText = data.id;
                $('qv-full-name').innerText = data.full_name;
                
                const statusEl = $('qv-status');
                statusEl.innerText = data.is_guest ? "Guest" : "Registered"; 
                statusEl.style.color = data.is_guest ? "var(--warning)" : "var(--success)";
                const d = new Date(data.updated_at);
                $('qv-user-date').innerText = d.toLocaleDateString('en-GB');
                window.showOverlayView('quick-view-user');
                $('overlay-container').classList.add('active');
            };

            const prepareGuestScreen = () => {
                const storedName = localStorage.getItem(FLAG_GUEST_NAME);
                const nameInput = $('g-name');
                const lockIcon = document.querySelector('.input-lock-icon');
                if (storedName) { 
                    nameInput.value = storedName; 
                    nameInput.disabled = true; 
                    nameInput.placeholder = "Identity Locked"; 
                    if(lockIcon) lockIcon.style.display = 'block'; 
                } else { 
                    nameInput.value = ''; 
                    nameInput.disabled = false; 
                    nameInput.placeholder = "Enter Name (Permanent)"; 
                    if(lockIcon) lockIcon.style.display = 'none'; 
                }
                lucide.createIcons();
            };

            window.nav = (id, direction = null) => {
                const current = document.querySelector('.screen.active');
                const next = $(id);
                if(!next) return;
                if(id === 'scr-guest') prepareGuestScreen();
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('slide-left', 'slide-right'));
                if(direction === 'left') { 
                    current.classList.add('slide-left'); 
                    next.classList.remove('slide-right'); 
                } else if(direction === 'right') { 
                    current.classList.add('slide-right'); 
                    next.classList.remove('slide-left'); 
                } else {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                }
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                next.classList.add('active');
                lucide.createIcons();
                const createBtn = $('icon-plus-lobby');
                if (createBtn) createBtn.style.display = state.user?.is_anonymous && id === 'scr-lobby' ? 'none' : 'flex';
            };

            window.loadRooms = async () => { 
                if(!state.user) return; 
                window.setLoading(true, "Fetching Rooms...");
                const {data} = await db.from('rooms').select('*').eq('is_private',false).order('created_at',{ascending:false}); 
                state.allRooms = data || []; 
                window.filterRooms(); 
                window.setLoading(false);
            };
            
            window.filterRooms = () => { 
                const q = $('search-bar').value.toLowerCase(); 
                const list = $('room-list');
                const filtered = state.allRooms.filter(r=>r.name.toLowerCase().includes(q));
                
                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i data-lucide="folder" class="empty-state-icon"></i>
                            <div class="empty-state-title">No groups yet</div>
                            <div class="empty-state-sub">Create one to start chatting.</div>
                        </div>
                    `;
                } else {
                    list.innerHTML = filtered.map(r => `
                        <div class="room-card" onclick="window.joinAttempt('${r.id}')">
                            <span class="room-name">${esc(r.name)}</span>
                            <span class="room-icon">
                                <i data-lucide="${r.has_password ? 'lock' : 'chevron-right'}" style="width:18px;height:18px;color:var(--text-mute)"></i>
                            </span>
                        </div>
                    `).join(''); 
                }
                lucide.createIcons(); 
            };

            window.joinAttempt = async (id) => {
                if(state.serverFull) return window.toast("Network is full");
                window.setLoading(true, "Joining Room...");
                const { data, error } = await db.from('rooms').select('*').eq('id', id).single();
                window.setLoading(false);
                if (error || !data) return window.toast("Room not found");
                if (data.has_password) { 
                    state.pending = { id: data.id, name: data.name, salt: data.salt }; 
                    window.nav('scr-gate'); 
                } else { 
                    window.openVault(data.id, data.name, null, data.salt); 
                }
            };

            window.joinPrivate = async () => { 
                if(state.serverFull) return window.toast("Network is full");
                if(!state.user) return window.toast("Login required"); 
                const id = $('join-id').value.trim(); 
                if(!id) return; 
                window.setLoading(true, "Joining Room..."); 
                const {data} = await db.from('rooms').select('*').eq('id',id).single(); 
                window.setLoading(false); 
                if(data) { 
                    if(data.has_password) { 
                        state.pending = { id: data.id, name: data.name, salt: data.salt }; 
                        window.nav('scr-gate'); 
                    } else { 
                        window.openVault(data.id, data.name, null, data.salt); 
                    }
                } else window.toast("Not found"); 
            };

            const getDateLabel = (d) => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const target = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                const diff = Math.round((today - target) / 86400000);
                if (diff === 0) return "Today";
                if (diff === 1) return "Yesterday";
                if (diff < 7) return d.toLocaleDateString('en-GB', { weekday: 'long' });
                return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            };

            const linkify = (text) => {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, (url) => {
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="chat-link">${url}</a>`;
                });
            };

            const checkChatEmpty = () => {
                const container = $('chat-messages');
                const emptyState = $('chat-empty-state');
                const hasMessages = container.querySelector('.msg');
                if(emptyState) emptyState.style.display = hasMessages ? 'none' : 'flex';
            };

            const renderMsg = (m, prepend = false) => {
                let html = "";
                const msgDateObj = new Date(m.created_at);
                const currentLabel = getDateLabel(msgDateObj);
                
                if (!prepend && currentLabel !== state.lastRenderedDateLabel) { 
                    html += `<div class="date-divider"><span class="date-label">${currentLabel}</span></div>`; 
                    state.lastRenderedDateLabel = currentLabel; 
                } else if (prepend) {
                   html += `<div class="date-divider"><span class="date-label">${currentLabel}</span></div>`;
                   state.lastRenderedDateLabel = currentLabel;
                }

                const isUserGuest = state.roomGuestStatus[m.user_id] || false;
                const displayName = isUserGuest ? "Guest" : m.user_name;
                const guestPill = isUserGuest ? '<span class="guest-pill">Guest</span>' : '';
                const processedText = linkify(esc(m.text)).replace(/\*(.*?)\*/g, '<b>$1</b>').replace(/_(.*?)_/g, '<i>$1</i>');
                
                html += `<div class="msg ${m.user_id===state.user?.id?'me':''}" data-time="${m.created_at}">
                    <span class="msg-user" onclick="window.inspectUser('${m.user_id}')">${esc(displayName)} ${guestPill}</span>
                    <div>${processedText}</div>
                    <span class="msg-time">${esc(m.time)}</span>
                </div>`;
                return html;
            };

            const handleScroll = () => {
                const container = $('chat-messages');
                if (!container) return;
                if (container.scrollTop < 50 && !state.isLoadingHistory && state.hasMoreHistory) {
                    loadMoreHistory();
                }
            };

            const fetchGuestStatuses = async (userIds) => {
                if (!userIds || userIds.length === 0) return;
                const uniqueIds = [...new Set(userIds)];
                const { data, error } = await db.from('profiles').select('id, is_guest').in('id', uniqueIds);
                if (data) {
                    data.forEach(p => { state.roomGuestStatus[p.id] = p.is_guest; });
                }
            };

            const loadMoreHistory = async () => {
                if (!state.oldestMessageTimestamp || !state.currentRoomId) return;
                
                state.isLoadingHistory = true;
                const container = $('chat-messages');
                const oldScrollHeight = container.scrollHeight;
                
                container.insertAdjacentHTML('afterbegin', '<div id="history-loader" class="history-loader">Loading...</div>');

                const { data, error } = await db
                    .from('messages')
                    .select('*')
                    .eq('room_id', state.currentRoomId)
                    .lt('created_at', state.oldestMessageTimestamp)
                    .order('created_at', { ascending: false })
                    .limit(CONFIG.historyLoadLimit);

                $('history-loader')?.remove();

                if (error || !data || data.length === 0) {
                    state.hasMoreHistory = false;
                    state.isLoadingHistory = false;
                    return;
                }

                data.reverse();
                
                pendingCallbacks['historyDecrypted'] = async (res) => {
                    const validMsgs = res.results.filter(m => !m.error);
                    if (validMsgs.length > 0) {
                        state.oldestMessageTimestamp = validMsgs[0].created_at;
                        
                        const ids = validMsgs.map(m => m.user_id);
                        await fetchGuestStatuses(ids);
                        
                        const lastBatchDate = getDateLabel(new Date(validMsgs[validMsgs.length - 1].created_at));
                        
                        const firstMsgEl = container.querySelector('.msg');
                        let firstExistingDate = null;
                        if (firstMsgEl) {
                             const firstTime = firstMsgEl.getAttribute('data-time');
                             if(firstTime) firstExistingDate = getDateLabel(new Date(firstTime));
                        }
                        
                        let html = "";
                        let tempLabel = null;
                        
                        validMsgs.forEach((m, index) => {
                            const msgDate = getDateLabel(new Date(m.created_at));
                            
                            if (msgDate !== tempLabel) {
                                if (index === validMsgs.length - 1 && msgDate === firstExistingDate) {
                                } else {
                                    html += `<div class="date-divider"><span class="date-label">${msgDate}</span></div>`;
                                }
                                tempLabel = msgDate;
                            }
                            
                            const isUserGuest = state.roomGuestStatus[m.user_id] || false;
                            const displayName = isUserGuest ? "Guest" : m.user_name;
                            const guestPill = isUserGuest ? '<span class="guest-pill">Guest</span>' : '';
                            const processedText = linkify(esc(m.text)).replace(/\*(.*?)\*/g, '<b>$1</b>').replace(/_(.*?)_/g, '<i>$1</i>');
                            
                            html += `<div class="msg ${m.user_id===state.user?.id?'me':''}" data-time="${m.created_at}">
                                <span class="msg-user" onclick="window.inspectUser('${m.user_id}')">${esc(displayName)} ${guestPill}</span>
                                <div>${processedText}</div>
                                <span class="msg-time">${esc(m.time)}</span>
                            </div>`;
                        });
                        
                        if (lastBatchDate === firstExistingDate) {
                            const firstDivider = container.querySelector('.date-divider');
                            if (firstDivider) firstDivider.remove();
                        }
                        
                        container.insertAdjacentHTML('afterbegin', html);
                        
                        const newScrollHeight = container.scrollHeight;
                        container.scrollTop = newScrollHeight - oldScrollHeight;
                    }
                    state.isLoadingHistory = false;
                };
                cryptoWorker.postMessage({ type: 'decryptHistory', payload: { messages: data } });
            };

            window.openVault = async (id, n, rawPassword, roomSalt) => {
                if (!state.user) return window.toast("Please login first");
                window.setLoading(true, "Deriving Key...");
                if(state.chatChannel) await db.removeChannel(state.chatChannel);
                
                state.currentRoomId = id;
                state.lastRenderedDateLabel = null; 
                state.roomGuestStatus = {}; 
                state.oldestMessageTimestamp = null;
                state.hasMoreHistory = true;
                state.isLoadingHistory = false;
                
                $('chat-title').innerText = n;
                $('chat-messages').innerHTML = '<div id="chat-empty-state" class="empty-state"><i data-lucide="message-circle" class="empty-state-icon"></i><div class="empty-state-title">No messages yet</div><div class="empty-state-sub">Be the first to say something.</div></div>';
                $('chat-messages').onscroll = handleScroll; 
                
                const copyIcon = $('icon-copy-chat'); 
                const checkIcon = $('icon-check-chat');
                if(copyIcon) copyIcon.style.display = 'block'; 
                if(checkIcon) checkIcon.style.display = 'none';
                const keySource = rawPassword ? (rawPassword + id) : id;
                
                try {
                    await deriveKey(keySource, roomSalt);
                } catch(e) {
                    window.setLoading(false);
                    return window.toast("Key derivation failed");
                }

                window.setLoading(true, "Fetching History...");
                const { data } = await db.from('messages').select('*').eq('room_id', id).order('created_at', { ascending: false }).limit(CONFIG.maxMessages);
                
                const isGuest = state.user.is_anonymous;
                const guestInfoBtn = $('guest-info-chat');
                if(guestInfoBtn) guestInfoBtn.style.display = isGuest ? 'flex' : 'none';
                $('chat-input').style.display = isGuest ? 'none' : 'block';
                $('guest-replies').style.display = isGuest ? 'flex' : 'none';
                $('send-btn').style.display = isGuest ? 'none' : 'flex';
                window.nav('scr-chat');

                if (data && data.length > 0) {
                    data.reverse();
                    if (data.length > 0) state.oldestMessageTimestamp = data[0].created_at;
                    window.setLoading(true, "Decrypting...");
                    pendingCallbacks['historyDecrypted'] = async (res) => {
                        const b = $('chat-messages');
                        b.innerHTML = '';
                        const ids = res.results.map(m => m.user_id);
                        await fetchGuestStatuses(ids);

                        res.results.forEach(m => { if(!m.error) b.insertAdjacentHTML('beforeend', renderMsg(m)); });
                        b.scrollTop = b.scrollHeight;
                        checkChatEmpty();
                        window.setLoading(false);
                    };
                    cryptoWorker.postMessage({ type: 'decryptHistory', payload: { messages: data } });
                } else {
                    state.hasMoreHistory = false;
                    checkChatEmpty();
                    window.setLoading(false);
                }

                state.chatChannel = db.channel(`room_chat_${id}`, { config: { broadcast: { self: true } } });
                state.chatChannel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room_id=eq.${id}` }, async (payload) => {
                    const m = payload.new;
                    if (m && state.currentRoomId) {
                        pendingCallbacks['singleDecrypted'] = async (decRes) => {
                            if(decRes.result) {
                                await fetchGuestStatuses([m.user_id]);
                                const msgObj = { ...m, time: decRes.result.time, text: decRes.result.text }; 
                                const b = $('chat-messages'); 
                                b.insertAdjacentHTML('beforeend', renderMsg(msgObj)); 
                                b.scrollTop = b.scrollHeight;
                                checkChatEmpty();
                            }
                        };
                        cryptoWorker.postMessage({ type: 'decryptSingle', payload: { content: m.content } });
                    }
                }).subscribe();
            };

            const applyRateLimit = () => {
                const now = Date.now();
                if (now - state.lastMessageTime < CONFIG.rateLimitMs) {
                    const wait = CONFIG.rateLimitMs - (now - state.lastMessageTime);
                    $('chat-input-area').classList.add('rate-limited');
                    setTimeout(() => {
                        $('chat-input-area').classList.remove('rate-limited');
                    }, wait);
                    return false;
                }
                return true;
            };

            window.sendMsg = async (e) => {
                if (!e || !e.isTrusted) return;
                if (!state.user || !state.currentRoomId) return;
                if (state.processingAction) return;
                if (!applyRateLimit()) return;

                state.processingAction = true;
                const v = $('chat-input').value.trim();
                if(!v) { state.processingAction = false; return; }
                $('chat-input').value = '';
                
                state.lastMessageTime = Date.now();
                
                try { 
                    const enc = await encryptMessage(v);
                    await db.from('messages').insert([{ room_id: state.currentRoomId, user_id: state.user.id, user_name: state.user.user_metadata?.full_name, content: enc }]); 
                } catch(e) { window.toast("Failed to send"); }
                state.processingAction = false;
            };

            window.sendGuestReply = async (e, message) => {
                if (!e || !e.isTrusted) return;
                if (!state.user || !state.currentRoomId) return;
                if (state.processingAction) return;
                if (!applyRateLimit()) return;
                
                state.processingAction = true;
                state.lastMessageTime = Date.now();
                
                try {
                    const enc = await encryptMessage(message);
                    await db.from('messages').insert([{ room_id: state.currentRoomId, user_id: state.user.id, user_name: state.user.user_metadata?.full_name, content: enc }]);
                } catch(err) {}
                state.processingAction = false;
            };

            window.leaveChat = async () => { 
                if(state.chatChannel) await db.removeChannel(state.chatChannel);
                state.chatChannel = null;
                state.currentRoomId = null; 
                state.roomGuestStatus = {}; 
                window.nav('scr-lobby'); 
                window.loadRooms(); 
            };

            window.handleLogin = async (e) => {
                if (!e || !e.isTrusted) return;
                if(state.processingAction) return;
                state.processingAction = true;
                const em = $('l-email').value, p = $('l-pass').value; 
                if(!em || !p) { window.toast("Input missing"); state.processingAction = false; return; } 
                window.setLoading(true, "Signing In..."); 
                localStorage.removeItem(FLAG_LOGOUT);
                const {error} = await db.auth.signInWithPassword({email:em, password:p}); 
                if(error) window.toast(error.message);
                state.processingAction = false;
                window.setLoading(false); 
            };
            
            window.handleRegister = async (e) => { 
                if (!e || !e.isTrusted) return;
                if(state.processingAction) return;
                state.processingAction = true;
                const n=$('r-name').value, em=$('r-email').value.trim().toLowerCase(), p=$('r-pass').value; 
                if(!n || !em || p.length < 8) { window.toast("Check inputs"); state.processingAction = false; return; } 
                window.setLoading(true, "Sending Code..."); 
                
                const [r, err] = await safeAwait(fetch(CONFIG.mailApi, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: "send", email: em }) }));
                
                if(r) {
                    if(r.status === 429) {
                        window.toast("Too many attempts. Wait a minute.");
                        state.processingAction = false;
                        window.setLoading(false);
                        return;
                    }
                    const j = await r.json();
                    if(j.message === "Code sent") { 
                        sessionStorage.setItem('temp_reg', JSON.stringify({n, em, p})); 
                        window.nav('scr-verify'); 
                        startVTimer(); 
                    } else window.toast(j.message || "Mail error"); 
                } else window.toast("Network error");
                state.processingAction = false;
                window.setLoading(false); 
            };
            
            const startVTimer = () => { 
                let left = CONFIG.verificationCodeExpiry; 
                if(state.vTimer) clearInterval(state.vTimer); 
                state.vTimer = setInterval(() => { 
                    left--; 
                    $('v-timer').innerText = `${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`; 
                    if(left<=0) { clearInterval(state.vTimer); window.nav('scr-register'); } 
                }, 1000); 
            };
            
            window.handleVerify = async (e) => {
                if (!e || !e.isTrusted) return;
                if(state.processingAction) return;
                state.processingAction = true;
                const code = $('v-code').value, temp = JSON.parse(sessionStorage.getItem('temp_reg')); 
                if(!temp) { window.toast("Session expired"); state.processingAction = false; return; }
                window.setLoading(true, "Verifying Code..."); 
                
                const r = await fetch(CONFIG.mailApi, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: "verify", email: temp.em, code: code }) });
                
                if(r.status === 429) {
                     window.toast("Too many attempts.");
                     state.processingAction = false;
                     window.setLoading(false);
                     return;
                }

                const j = await r.json();
                
                if(j.message === "Verified") { 
                    localStorage.removeItem(FLAG_LOGOUT);
                    const { error } = await db.auth.signUp({ email: temp.em, password: temp.p, options: { data: { full_name: temp.n } } }); 
                    if(error) window.toast(error.message); 
                } else {
                    window.toast(j.message || "Wrong code");
                }
                
                state.processingAction = false;
                window.setLoading(false); 
            };

            window.handleGuestLogin = async (e) => {
                if (!e || !e.isTrusted) return;
                if(state.processingAction) return;
                const nameInput = $('g-name');
                let name = nameInput.value.trim();
                const lockedName = localStorage.getItem(FLAG_GUEST_NAME);
                if (lockedName) name = lockedName;
                else { if (!name) return window.toast("Please enter a name."); }
                if (!lockedName) { window.openHub(); window.showOverlayView('guest-warn'); } 
                else { await performGuestLogin(name); }
            };
            
            window.confirmGuestLoginAction = async (e) => { 
                if (!e || !e.isTrusted) return;
                const name = $('g-name').value.trim(); if(!name) return; await performGuestLogin(name); 
            };

            const performGuestLogin = async (name) => {
                window.closeOverlay();
                window.setLoading(true, "Initializing...");
                localStorage.removeItem(FLAG_LOGOUT);
                
                const { data: { user: existingUser } } = await db.auth.getUser();
                if (existingUser && existingUser.is_anonymous) {
                    const currentName = existingUser.user_metadata?.full_name;
                    if (!currentName || currentName !== name) { 
                        await db.auth.updateUser({ data: { full_name: name } }); 
                        state.user = existingUser; 
                        state.user.user_metadata = state.user.user_metadata || {}; 
                        state.user.user_metadata.full_name = name; 
                    } else { state.user = existingUser; }
                    
                    await db.from('profiles').upsert({ id: state.user.id, full_name: name, is_guest: true });

                    localStorage.setItem(FLAG_GUEST_ID, state.user.id); 
                    localStorage.setItem(FLAG_GUEST_NAME, name);
                    window.nav('scr-lobby'); window.loadRooms(); window.forceClaimMaster();
                    window.setLoading(false);
                    return;
                }

                const { data, error } = await db.auth.signInAnonymously();
                if (error) { window.toast(error.message); window.setLoading(false); return; }
                if (data.user) {
                    await db.auth.updateUser({ data: { full_name: name } });
                    await db.from('profiles').upsert({ id: data.user.id, full_name: name, is_guest: true });
                    
                    state.user = data.user; state.user.user_metadata = state.user.user_metadata || {}; state.user.user_metadata.full_name = name;
                    localStorage.setItem(FLAG_GUEST_ID, state.user.id); 
                    localStorage.setItem(FLAG_GUEST_NAME, name);
                    window.nav('scr-lobby'); window.loadRooms(); window.forceClaimMaster();
                }
                window.setLoading(false);
            };
            
            window.handleCreate = async (e) => { 
                if (!e || !e.isTrusted) return;
                if(state.serverFull) return window.toast("Network full");
                if(state.user?.is_anonymous) return window.toast("Guests cannot create rooms");
                if(state.processingAction) return;
                state.processingAction = true;
                const n=$('c-name').value, p=$('c-pass').value, isP=$('c-private').checked; 
                
                if(isP && !p) {
                    window.toast("Private rooms require a password");
                    state.processingAction = false;
                    return;
                }
                if(!n) { window.toast("Name required"); state.processingAction = false; return; } 
                
                window.setLoading(true, "Deploying Room..."); 
                const roomSalt = generateSalt();
                const {data, error} = await db.from('rooms').insert([{name:n,has_password:!!p,is_private:isP,salt:roomSalt,created_by:state.user.id}]).select(); 
                
                if(error) { 
                    window.toast("Error: " + error.message); 
                    state.processingAction = false; 
                    window.setLoading(false); 
                    return; 
                }
                
                if(data && data.length > 0) {
                    const newRoom = data[0];
                    if(p) {
                        const accessHash = await sha256(p + roomSalt);
                        await db.rpc('set_room_password', { p_room_id: newRoom.id, p_hash: accessHash });
                    }
                    state.lastCreated=newRoom; 
                    state.lastCreatedPass = p; 
                    $('s-id').innerText=newRoom.id; 
                    window.nav('scr-success'); 
                }
                state.processingAction = false;
                window.setLoading(false);
            };

            window.submitGate = async (e) => { 
                if (!e || !e.isTrusted) return;
                const inputPass = $('gate-pass').value; 
                const inputHash = await sha256(inputPass + state.pending.salt); 
                window.setLoading(true, "Verifying Access...");
                const { data, error } = await db.rpc('verify_room_password', { p_room_id: state.pending.id, p_hash: inputHash });
                window.setLoading(false);
                if(data === true) window.openVault(state.pending.id, state.pending.name, inputPass, state.pending.salt); 
                else window.toast("Access Denied"); 
            };
            
            window.handleLogout = async (e) => {
                if (!e || !e.isTrusted) return;
                window.setLoading(true, "Switching Account..."); 
                await cleanupChannels();
                if (state.heartbeatInterval) clearInterval(state.heartbeatInterval);
                if (state.uptimeInterval) clearInterval(state.uptimeInterval);

                if (state.user && state.user.is_anonymous) {
                    localStorage.setItem(FLAG_GUEST_ID, state.user.id);
                    localStorage.setItem(FLAG_GUEST_NAME, state.user.user_metadata?.full_name);
                    
                    state.user = null;
                    state.isMasterTab = false;
                    localStorage.setItem(FLAG_LOGOUT, 'true');
                    window.nav('scr-start'); 
                    window.toast("Session saved.");
                } else {
                    localStorage.setItem(FLAG_LOGOUT, 'true');
                    state.user = null;
                    localStorage.removeItem(FLAG_GUEST_ID); 
                    localStorage.removeItem(FLAG_GUEST_NAME);
                    await db.auth.signOut(); 
                    window.nav('scr-start'); 
                }
                window.setLoading(false); 
            };
            
            window.copyId = () => { navigator.clipboard.writeText(state.currentRoomId); const copyIcon = $('icon-copy-chat'); const checkIcon = $('icon-check-chat'); copyIcon.style.display = 'none'; checkIcon.style.display = 'block'; setTimeout(() => { copyIcon.style.display = 'block'; checkIcon.style.display = 'none'; }, 2000); };
            window.copySId = () => { navigator.clipboard.writeText(state.lastCreated.id); window.toast("ID Copied"); };
            window.enterCreated = () => { const pass = state.lastCreatedPass; window.openVault(state.lastCreated.id, state.lastCreated.name, pass, state.lastCreated.salt); state.lastCreatedPass = null; };
            
            let touchStartX = 0, touchEndX = 0;
            document.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, false);
            document.addEventListener('touchend', e => { 
                touchEndX = e.changedTouches[0].screenX; 
                const active = document.querySelector('.screen.active'); 
                if(!active) return; 
                const diff = touchEndX - touchStartX; 
                if(active.id === 'scr-start' && diff < -50) window.nav('scr-guest', 'left'); 
                else if(active.id === 'scr-guest' && diff > 50) window.nav('scr-start', 'right'); 
            }, false);
            
            window.addEventListener('online', () => { 
                $('offline-screen').classList.remove('active');
                window.toast("Back online"); 
                if(state.user && state.isMasterTab) initPresence(true); 
            });
            
            window.addEventListener('offline', () => { 
                $('offline-screen').classList.add('active');
                updateOnlineDisplay(null); 
                window.toast("Connection lost"); 
            });

            db.auth.onAuthStateChange(async (ev, ses) => {
                const isFlaggedLogout = localStorage.getItem(FLAG_LOGOUT) === 'true';
                
                if (isFlaggedLogout) {
                    state.user = null;
                    if(ses?.user && ses.user.is_anonymous) {
                    }
                    return;
                }

                state.user = ses?.user;
                const createBtn = $('icon-plus-lobby');
                const activeScreenId = document.querySelector('.screen.active')?.id;
                if (createBtn) createBtn.style.display = state.user?.is_anonymous && activeScreenId === 'scr-lobby' ? 'none' : 'flex';
                if (ev === 'SIGNED_IN') {
                    if(state.user) {
                        localStorage.setItem(FLAG_GUEST_ID, state.user.id);
                        if(state.user.user_metadata?.full_name) localStorage.setItem(FLAG_GUEST_NAME, state.user.user_metadata.full_name);
                        
                        const authScreens = ['scr-start', 'scr-login', 'scr-register', 'scr-verify'];
                        if (authScreens.includes(activeScreenId)) {
                            window.nav('scr-lobby'); 
                            window.loadRooms(); 
                            window.forceClaimMaster();
                        }
                    }
                }
                if (ev === 'SIGNED_OUT') { 
                    if (state.heartbeatInterval) clearInterval(state.heartbeatInterval); 
                    if (state.uptimeInterval) clearInterval(state.uptimeInterval);
                    await cleanupChannels();
                    localStorage.removeItem(FLAG_GUEST_ID); 
                    localStorage.removeItem(FLAG_GUEST_NAME);
                    localStorage.removeItem(FLAG_LOGOUT); 
                    window.nav('scr-start'); 
                }
            });

            const init = async () => {
                if (!navigator.onLine) $('offline-screen').classList.add('active');
                
                if (localStorage.getItem(FLAG_LOGOUT) === 'true') {
                    state.user = null;
                    window.nav('scr-start');
                    window.setLoading(false);
                    monitorConnection();
                    return;
                }

                const { data: { session } } = await db.auth.getSession();
                
                if (session) {
                    state.user = session.user;
                    localStorage.setItem(FLAG_GUEST_ID, state.user.id);
                    if(state.user.user_metadata?.full_name) localStorage.setItem(FLAG_GUEST_NAME, state.user.user_metadata.full_name);
                    
                    const masterExists = await checkMaster();
                    if (masterExists) {
                         const overlay = $('block-overlay');
                         overlay.classList.add('active');
                         lucide.createIcons();
                        window.nav('scr-lobby'); 
                        window.loadRooms(); 
                    } else {
                        window.forceClaimMaster();
                        window.nav('scr-lobby'); 
                        window.loadRooms(); 
                    }
                    
                    state.sessionStartTime = Date.now();
                    if(state.uptimeInterval) clearInterval(state.uptimeInterval);
                    state.uptimeInterval = setInterval(updateUptime, 1000);
                } else {
                    $('guest-swipe-hint').style.display = 'flex';
                }
                lucide.createIcons();
                window.setLoading(false);
                monitorConnection();
            };

            init();
        }

        startChatApp({
            maxUsers: 475,
            maxMessages: 15,
            rateLimitMs: 1000,
            historyLoadLimit: 10
        });
    </script>
</body>
</html>
