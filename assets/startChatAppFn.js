import{createClient}from'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';export function startChatApp(e={}){const t={supabaseUrl:e.supabaseUrl||"https://fahbqdajxnhswevdagdn.supabase.co",supabaseKey:e.supabaseKey||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhaGJxZGFqeG5oc3dldmRhZ2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTEyODEsImV4cCI6MjA4NjEyNzI4MX0.UPgPxyaWBULjH4jL8UaSr6bJXTsFWWJRIYodHmXeVTI",mailApi:e.mailApi||"https://vercel-serverless-gray-sigma.vercel.app/api/mailAPI",maxUsers:e.maxUsers||475,maxMessages:e.maxMessages||15,historyLoadLimit:e.historyLoadLimit||10,rateLimitMs:e.rateLimitMs||1000,presenceHeartbeatMs:e.presenceHeartbeatMs||10000,reconnectDebounceMs:e.reconnectDebounceMs||3000,verificationCodeExpiry:e.verificationCodeExpiry||600};lucide.createIcons();const a={user:null,currentRoomId:null,chatChannel:null,presenceChannel:null,allRooms:[],vTimer:null,lastRenderedDateLabel:null,lastKnownOnlineCount:null,heartbeatInterval:null,uptimeInterval:null,sessionStartTime:null,isPresenceSubscribed:!1,lastReconnectAttempt:0,roomGuestStatus:{},pending:null,lastCreated:null,lastCreatedPass:null,isMasterTab:!1,tabId:sessionStorage.getItem("hrn_tab_id")||sessionStorage.setItem("hrn_tab_id",crypto.randomUUID()),processingAction:!1,serverFull:!1,isLoadingHistory:!1,oldestMessageTimestamp:null,hasMoreHistory:!0,lastMessageTime:0,isConnecting:!1,isChatChannelReady:!1,currentRoomAccessType:null},r="hrn_flag_force_logout",o="hrn_flag_guest_name",n="hrn_flag_guest_id";let i=[],l=!1;const s=new BroadcastChannel("hrn_tab_sync"),c=createClient(t.supabaseUrl,t.supabaseKey,{auth:{persistSession:!0,autoRefreshToken:!1},realtime:{params:{eventsPerSecond:10}}}),d=e=>{const t=document.createElement("p");return t.textContent=e,t.innerHTML},u=e=>document.getElementById(e),p=e=>{if("number"==typeof e)a.lastKnownOnlineCount=e;const t="number"==typeof e?e:"--";document.querySelectorAll(".live-count").forEach(e=>{e.innerText!==t.toString()&&(e.innerText=t)});const r=u("hub-online-count");r&&r.innerText!==t.toString()&&(r.innerText=t)},m=()=>{if(!a.sessionStartTime)return;const e=Math.floor((Date.now()-a.sessionStartTime)/1e3),t=Math.floor(e/60).toString().padStart(2,"0"),r=(e%60).toString().padStart(2,"0"),o=u("hub-uptime");o&&(o.innerText=`${t}:${r}`)},f=()=>{if(l||0===i.length)return;l=!0;const e=i.shift(),t=u("toast-container"),r=document.createElement("div");r.className="toast-item",r.innerText=e,r.onclick=()=>{r.style.opacity="0",setTimeout(()=>{r.remove(),l=!1,f()},400)},t.appendChild(r),setTimeout(()=>{r.parentNode&&(r.style.opacity="0",setTimeout(()=>{r.parentNode&&r.remove(),l=!1,f()},400))},3e3)};window.toast=e=>{i.push(e),f()},window.setLoading=(e,t=null)=>{const r=u("loader-overlay"),o=u("loader-text");e?r.classList.add("active"):r.classList.remove("active"),o&&(o.innerText=t||"Loading...")},g=async e=>{try{return[await e,null]}catch(t){return[null,t]}};const h=`self.onmessage=async e=>{const{type:t,payload:r}=e.data,n=new TextEncoder,i=new TextDecoder;try{if("deriveKey"===t){const e=await crypto.subtle.importKey("raw",n.encode(r.password),{name:"PBKDF2"},!1,["deriveKey"]),o=await crypto.subtle.deriveKey({name:"PBKDF2",salt:n.encode(r.salt),iterations:3e5,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);self.cryptoKey=o,self.postMessage({type:"keyDerived",success:!0})}else if("encrypt"===t){if(!self.cryptoKey)throw new Error("Key not derived");const e=crypto.getRandomValues(new Uint8Array(12)),t=n.encode(r.text),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},self.cryptoKey,t),a=new Uint8Array(e.length+o.byteLength);a.set(e,0),a.set(new Uint8Array(o),e.length);const l=btoa(String.fromCharCode(...a));self.postMessage({type:"encrypted",result:l})}else if("decryptHistory"===t){if(!self.cryptoKey)throw new Error("Key not derived");const e=[];for(const t of r.messages)try{const r=atob(t.content),o=new Uint8Array(r.length);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);const n=o.slice(0,12),a=o.slice(12),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:n},self.cryptoKey,a),s=i.decode(l),c=s.split("|");e.push({id:t.id,time:c[0],text:c.slice(1).join("|"),user_id:t.user_id,user_name:t.user_name,created_at:t.created_at})}catch(e){e.push({id:t.id,error:!0})}self.postMessage({type:"historyDecrypted",results:e})}else if("decryptSingle"===t){if(!self.cryptoKey)throw new Error("Key not derived");try{const e=atob(r.content),t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);const o=t.slice(0,12),n=t.slice(12),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},self.cryptoKey,n),l=i.decode(a),s=l.split("|");self.postMessage({type:"singleDecrypted",result:{time:s[0],text:s.slice(1).join("|")}})}catch(e){self.postMessage({type:"singleDecrypted",error:e.message})}}}catch(e){self.postMessage({type:"error",message:e.message})}};`;const b=new Blob([h],{type:"application/javascript"}),v=new Worker(URL.createObjectURL(b)),y={};v.onmessage=e=>{const{type:t}=e.data;y[t]&&(y[t](e.data),delete y[t])};const w=()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")},k=async e=>{const t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),o=Array.from(new Uint8Array(r));return o.map(e=>e.toString(16).padStart(2,"0")).join("")},x=(e,t)=>new Promise((r,o)=>{y.keyDerived=a=>{a.success?r(!0):o("Key derivation failed")},v.postMessage({type:"deriveKey",payload:{password:e,salt:t}})}),j=e=>new Promise((t,r)=>{y.encrypted=a=>{a.result?t(a.result):r("Encryption failed")};const o=(new Date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});v.postMessage({type:"encrypt",payload:{text:o+"|"+e}})});const _=async()=>{a.presenceChannel&&(a.presenceChannel.unsubscribe(),a.presenceChannel=null,a.isPresenceSubscribed=!1),a.chatChannel&&(a.chatChannel.unsubscribe(),a.chatChannel=null)};const q=async()=>{if(!a.presenceChannel)return;const e=a.presenceChannel.presenceState(),t=Object.values(e).flat(),r=new Set(t.map(e=>e.user_id));p(r.size),r.size>t.maxUsers? a.serverFull||(a.serverFull=!0,u("capacity-overlay").classList.add("active"),_()):a.serverFull=!1};const A=async(e=!1)=>{if(!a.isMasterTab||!a.user)return;const t=Date.now();if(!e&&a.isConnecting)return;if(!e&&t-a.lastReconnectAttempt<CONFIG.reconnectDebounceMs)return;a.lastReconnectAttempt=t,a.isConnecting=!0,a.isPresenceSubscribed=!1,a.presenceChannel&&(a.presenceChannel.unsubscribe(),a.presenceChannel=null),p(null);const r=a.user.id;a.presenceChannel=c.channel("online-users",{config:{presence:{key:r}}}),a.presenceChannel.on("presence",{event:"sync"},()=>{a.presenceChannel&&q()}).subscribe(async(e,t)=>{if("SUBSCRIBED"===e){if(!a.presenceChannel)return;a.isPresenceSubscribed=!0,a.isConnecting=!1,q(),await a.presenceChannel.track({user_id:r,online_at:(new Date).toISOString()}),q(),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.heartbeatInterval=setInterval(async()=>{a.presenceChannel&&a.isMasterTab&&!a.serverFull&&await a.presenceChannel.track({user_id:r,online_at:(new Date).toISOString()})},CONFIG.presenceHeartbeatMs),setTimeout(()=>{null===a.lastKnownOnlineCount&&a.isPresenceSubscribed&&!a.serverFull&&q()},2e3)}else("CLOSED"===e||"CHANNEL_ERROR"===e||"TIMED_OUT"===e)&&(a.isPresenceSubscribed=!1,a.isConnecting=!1,p(null))})};const S=()=>{setInterval(()=>{navigator.onLine?($("offline-screen").classList.remove("active"),a.user&&a.isMasterTab&&!a.currentRoomId&&"disconnected"!==c.realtime.connectionState()&&"stopped"!==c.realtime.connectionState()||!a.isConnecting&&A(!0),null===a.lastKnownOnlineCount&&a.isPresenceSubscribed&&!a.isConnecting&&!a.serverFull&&setTimeout(()=>{null===a.lastKnownOnlineCount&&a.isPresenceSubscribed&&!a.isConnecting&&!a.serverFull&&q()},1e3)):($("offline-screen").classList.add("active"),a.isPresenceSubscribed=!1,p(null))},5e3)};window.retryConnection=()=>{u("capacity-overlay").classList.remove("active"),a.serverFull=!1,A(!0)},window.handlePrivateToggle=()=>{const e=u("c-private").checked;u("c-pass").placeholder=e?"Passkey (Required)":"Passkey (Optional)"},window.forceClaimMaster=()=>{a.isMasterTab||(a.isMasterTab=!0,s.postMessage({type:"CLAIM_MASTER",id:a.tabId}),u("block-overlay").classList.remove("active"),localStorage.getItem(r)!=="true"&&a.user&&A(!0))},window.closeTabAttempt=()=>{window.open("","_self"),window.close()},s.onmessage=e=>{"CLAIM_MASTER"===e.data.type&&e.data.id!==a.tabId&&a.isMasterTab&&(_(),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.heartbeatInterval=null,a.isPresenceSubscribed=!1,a.isMasterTab=!1,p(null),u("block-overlay").innerHTML=`<i data-lucide="log-out" style="width:48px;height:48px;margin-bottom:24px;color:var(--danger)"></i><h1 class="title">Session Moved</h1><p class="subtitle" style="margin-bottom:48px">You switched to a new tab.</p><button class="btn btn-accent" onclick="window.forceClaimMaster()">Use Here</button>`,u("block-overlay").classList.add("active"),lucide.createIcons()),"PING_MASTER"===e.data.type&&a.isMasterTab&&s.postMessage({type:"PONG_MASTER"})},window.addEventListener("beforeunload",()=>s.postMessage({type:"CLAIM_MASTER",id:a.tabId}));const O=()=>new Promise(e=>{let t=!1;const r=r=>{ "PONG_MASTER"===r.data.type&&(t=!0)};s.addEventListener("message",r),s.postMessage({type:"PING_MASTER"}),setTimeout(()=>{s.removeEventListener("message",r),e(t)},300)});window.showGuestInfo=()=>{u("overlay-container").classList.add("active"),window.showOverlayView("guest-info"),lucide.createIcons()},window.openHub=()=>{u("overlay-container").classList.add("active"),window.showOverlayView("hub"),lucide.createIcons()},window.closeOverlay=()=>u("overlay-container").classList.remove("active"),window.showOverlayView=e=>{const t=document.querySelector(".panel-card");t&& (t.querySelectorAll(".view-content").forEach(e=>e.classList.remove("active")),u(`view-${e}`)?.classList.add("active"),lucide.createIcons())},window.prepareMyAccount=()=>{if(!a.user)return;const e=a.user.is_anonymous;u("my-acc-name").innerText=a.user.user_metadata?.full_name||"User",u("my-acc-id").innerText=a.user.id,u("my-acc-email").innerText=e?"Guest Mode":a.user.email||"No email",u("my-acc-type").innerText=e?"Guest Account":"Full Account",u("my-acc-type").style.color=e?"var(--warning)":"var(--success)",window.showOverlayView("my-account")},window.inspectUser=async e=>{if(e===a.user?.id)return window.prepareMyAccount();window.setLoading(!0,"Fetching info...");const{data:t,error:r}=await c.from("profiles").select("id, full_name, updated_at, is_guest").eq("id",e).single();window.setLoading(!1),r||!t?window.toast("User not found"):(u("qv-user-name").innerText=t.full_name,u("qv-user-avatar").innerText=t.full_name.charAt(0).toUpperCase(),u("qv-user-id").innerText=t.id,u("qv-full-name").innerText=t.full_name,u("qv-status").innerText=t.is_guest?"Guest":"Registered",u("qv-status").style.color=t.is_guest?"var(--warning)":"var(--success)");const o=new Date(t.updated_at);u("qv-user-date").innerText=o.toLocaleDateString("en-GB"),window.showOverlayView("quick-view-user"),u("overlay-container").classList.add("active")},E=()=>{const e=localStorage.getItem(o),t=u("g-name"),r=document.querySelector(".input-lock-icon");e?(t.value=e,t.disabled=!0,t.placeholder="Identity Locked",r&&r.style.display="block"):(t.value="",t.disabled=!1,t.placeholder="Enter Name (Permanent)",r&&r.style.display="none"),lucide.createIcons()},C=(e,t=null)=>{const r=document.querySelector(".screen.active"),o=u(e);if(!o)return;e==="scr-guest"&&E(),document.querySelectorAll(".screen").forEach(e=>e.classList.remove("slide-left","slide-right")),t?"left"===t?(r.classList.add("slide-left"),o.classList.remove("slide-right")):"right"===t&&(r.classList.add("slide-right"),o.classList.remove("slide-left")):document.querySelectorAll(".screen").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".screen").forEach(e=>e.classList.remove("active")),o.classList.add("active"),lucide.createIcons();const n=u("icon-plus-lobby");n&&(n.style.display=a.user?.is_anonymous&&"scr-lobby"===e?"none":"flex")},N=async()=>{if(!a.user)return;window.setLoading(!0,"Fetching accessible rooms...");const{data:e,error:t}=await c.from("rooms").select("*").order("created_at",{ascending:!1});if(t)return window.toast("Failed to load rooms"),void window.setLoading(!1);const r=[];for(const t of e||[]){const{data:e}=await c.rpc("can_access_room",{p_room_id:t.id});e&&r.push(t)}a.allRooms=r,window.filterRooms(),window.setLoading(!1)},L=()=>{const e=u("search-bar").value.toLowerCase(),t=u("room-list"),r=a.allRooms.filter(t=>t.name.toLowerCase().includes(e));0===r.length?t.innerHTML=`<div class="empty-state"><i data-lucide="folder" class="empty-state-icon"></i><div class="empty-state-title">No groups yet</div><div class="empty-state-sub">Create one or get invited.</div></div>`:t.innerHTML=r.map(e=>`<div class="room-card" onclick="window.joinAttempt('${e.id}')"><span class="room-name">${d(e.name)}</span><span class="room-icon"><i data-lucide="${e.has_password?"lock":"chevron-right"}" style="width:18px;height:18px;color:var(--text-mute)"></i></span></div>`).join(""),lucide.createIcons()};window.joinAttempt=async e=>{if(a.serverFull)return window.toast("Network is full");window.setLoading(!0,"Checking access...");const{data:t}=await c.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),void window.toast("Access denied — you are not on the allowed list");const{data:r,error:o}=await c.from("rooms").select("*").eq("id",e).single();if(window.setLoading(!1),o||!r)return void window.toast("Room not found");a.pending={id:r.id,name:r.name,salt:r.salt},r.allowed_users.includes("*")?a.currentRoomAccessType="open":a.currentRoomAccessType="restricted",r.has_password?window.nav("scr-gate"):window.openVault(r.id,r.name,null,r.salt)},window.joinPrivate=async()=>{if(a.serverFull)return window.toast("Network is full");if(!a.user)return window.toast("Login required");const e=u("join-id").value.trim();if(!e)return;window.setLoading(!0,"Checking access...");const{data:t}=await c.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),void window.toast("Access denied — not allowed");const{data:r}=await c.from("rooms").select("*").eq("id",e).single();window.setLoading(!1),r?(a.pending={id:r.id,name:r.name,salt:r.salt},r.allowed_users.includes("*")?a.currentRoomAccessType="open":a.currentRoomAccessType="restricted",r.has_password?window.nav("scr-gate"):window.openVault(r.id,r.name,null,r.salt)):window.toast("Not found")};const T=e=>{const t=new Date,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(e.getFullYear(),e.getMonth(),e.getDate()),n=Math.round((r-o)/864e5);return 0===n?"Today":1===n?"Yesterday":n<7?e.toLocaleDateString("en-GB",{weekday:"long"}):e.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})},I=e=>{let t=d(e);return t=t.replace(/(https?:\/\/[^\s]+)/g,e=>{const r=e.replace(/[<>"']/g,"");return`<a href="${r}" target="_blank" rel="noopener noreferrer" class="chat-link">${r}</a>`}),t},R=()=>{const e=u("chat-messages"),t=u("chat-empty-state"),r=e.querySelector(".msg");t&&(t.style.display=r?"none":"flex")};const M=(e,t=!1)=>{let r="";const o=new Date(e.created_at),n=T(o);if(!t&&n!==a.lastRenderedDateLabel?r+=`<div class="date-divider"><span class="date-label">${n}</span></div>`,a.lastRenderedDateLabel=n:t&&(r+=`<div class="date-divider"><span class="date-label">${n}</span></div>`,a.lastRenderedDateLabel=n),a.roomGuestStatus[e.user_id]){const t=a.roomGuestStatus[e.user_id];r+=`<div class="msg ${e.user_id===a.user?.id?"me":""}" data-time="${e.created_at}"><span class="msg-user" onclick="window.inspectUser('${e.user_id}')">${d(e.user_name)} <span class="guest-pill">Guest</span></span><div>${I(e.text)}</div><span class="msg-time">${d(e.time)}</span></div>`}else r+=`<div class="msg ${e.user_id===a.user?.id?"me":""}" data-time="${e.created_at}"><span class="msg-user" onclick="window.inspectUser('${e.user_id}')">${d(e.user_name)}</span><div>${I(e.text)}</div><span class="msg-time">${d(e.time)}</span></div>`;return r};const P=()=>{const e=u("chat-messages");e&&e.scrollTop<50&&!a.isLoadingHistory&&a.hasMoreHistory&&H()};const H=async()=>{if(!a.oldestMessageTimestamp||!a.currentRoomId)return;a.isLoadingHistory=!0;const e=u("chat-messages"),t=e.scrollHeight;e.insertAdjacentHTML("afterbegin",'<div id="history-loader" class="history-loader">Loading...</div>');const{data:r,error:o}=await c.from("messages").select("*").eq("room_id",a.currentRoomId).lt("created_at",a.oldestMessageTimestamp).order("created_at",{ascending:!1}).limit(CONFIG.historyLoadLimit);u("history-loader")?.remove(),o||!r||0===r.length?(a.hasMoreHistory=!1,a.isLoadingHistory=!1): (r.reverse(),y.historyDecrypted=async e=>{const t=e.results.filter(e=>!e.error);if(t.length>0){a.oldestMessageTimestamp=t[0].created_at;const e=t.map(e=>e.user_id);await(async e=>{if(!e||0===e.length)return;const t=[...new Set(e)],{data:r}=await c.from("profiles").select("id, full_name, is_guest").in("id",t);r&&r.forEach(e=>{a.roomGuestStatus[e.id]=e.is_guest})})(e);const r=T(new Date(t[t.length-1].created_at)),o=e.querySelector(".msg"),n=o?T(new Date(o.getAttribute("data-time"))):null;let i="",l=null;t.forEach((e,t)=>{const o=T(new Date(e.created_at));o!==l&&(t===t.length-1&&o===n||(i+=`<div class="date-divider"><span class="date-label">${o}</span></div>`),l=o);const s=a.roomGuestStatus[e.user_id]?" <span class='guest-pill'>Guest</span>":"";i+=`<div class="msg ${e.user_id===a.user?.id?"me":""}" data-time="${e.created_at}"><span class="msg-user" onclick="window.inspectUser('${e.user_id}')">${d(e.user_name)}${s}</span><div>${I(e.text)}</div><span class="msg-time">${d(e.time)}</span></div>`}),r===n&&e.querySelector(".date-divider")?.remove(),e.insertAdjacentHTML("afterbegin",i);const s=e.scrollHeight;e.scrollTop=s-t,e.scrollHeight; a.isLoadingHistory=!1}})},v.postMessage({type:"decryptHistory",payload:{messages:r}}))};window.openVault=async(e,t,r,o)=>{if(!a.user)return window.toast("Please login first");window.setLoading(!0,"Deriving Key..."),a.chatChannel&&a.chatChannel.unsubscribe(),a.currentRoomId=e,a.lastRenderedDateLabel=null,a.roomGuestStatus={},a.oldestMessageTimestamp=null,a.hasMoreHistory=!0,a.isLoadingHistory=!1,u("chat-title").innerText=t,u("chat-messages").innerHTML='<div id="chat-empty-state" class="empty-state"><i data-lucide="message-circle" class="empty-state-icon"></i><div class="empty-state-title">No messages yet</div><div class="empty-state-sub">Be the first to say something.</div></div>',u("chat-messages").onscroll=P;const n=u("icon-copy-chat"),i=u("icon-check-chat");n&&(n.style.display="block"),i&&(i.style.display="none");const l=r?r+e:e;try{await x(l,o)}catch(e){return window.setLoading(!1),void window.toast("Key derivation failed")}window.setLoading(!0,"Fetching History...");const{data:s}=await c.from("messages").select("*").eq("room_id",e).order("created_at",{ascending:!1}).limit(CONFIG.maxMessages);const d=a.user.is_anonymous;u("guest-info-chat").style.display=d?"flex":"none",u("chat-input").style.display=d?"none":"block",u("guest-replies").style.display=d?"flex":"none",u("send-btn").style.display=d?"none":"flex",window.nav("scr-chat"),s&&s.length>0?(s.reverse(),s.length>0&&(a.oldestMessageTimestamp=s[0].created_at),window.setLoading(!0,"Decrypting..."),y.historyDecrypted=async e=>{const t=u("chat-messages");t.innerHTML="";const r=e.results.map(e=>e.user_id);await(async e=>{if(!e||0===e.length)return;const t=[...new Set(e)],{data:r}=await c.from("profiles").select("id, full_name, is_guest").in("id",t);r&&r.forEach(e=>{a.roomGuestStatus[e.id]=e.is_guest})})(r),e.results.forEach(e=>{e.error||t.insertAdjacentHTML("beforeend",M(e))}),t.scrollTop=t.scrollHeight,R(),window.setLoading(!1)}): (a.hasMoreHistory=!1,R(),window.setLoading(!1)),a.chatChannel=c.channel(`room_chat_${e}`,{config:{broadcast:{self:!0}}}),a.chatChannel.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${e}`},async e=>{const t=e.new;t&&a.currentRoomId&&(y.singleDecrypted=async e=>{if(e.result){await(async e=>{if(!e||0===e.length)return;const t=[...new Set(e)],{data:r}=await c.from("profiles").select("id, full_name, is_guest").in("id",t);r&&r.forEach(e=>{a.roomGuestStatus[e.id]=e.is_guest})})([t.user_id]);const r={...t,time:e.result.time,text:e.result.text};u("chat-messages").insertAdjacentHTML("beforeend",M(r)),u("chat-messages").scrollTop=u("chat-messages").scrollHeight,R()}}),v.postMessage({type:"decryptSingle",payload:{content:t.content}}))}).subscribe(e=>{"SUBSCRIBED"===e?a.isChatChannelReady=!0:("CLOSED"===e||"CHANNEL_ERROR"===e||"TIMED_OUT"===e)&&(a.isChatChannelReady=!1)})};const D=()=>{const e=Date.now();return e-a.lastMessageTime<CONFIG.rateLimitMs?(u("chat-input-area").classList.add("rate-limited"),setTimeout(()=>u("chat-input-area").classList.remove("rate-limited"),CONFIG.rateLimitMs-(e-a.lastMessageTime)),!1):!0};window.sendMsg=async e=>{if(!e||!e.isTrusted)return;if(!a.user||!a.currentRoomId)return;if(a.processingAction)return;if(!a.isChatChannelReady)return void window.toast("Connection not ready yet – please wait a moment");if(!D())return;a.processingAction=!0;const t=u("chat-input").value.trim();if(!t)return void(a.processingAction=!1);u("chat-input").value="",a.lastMessageTime=Date.now();try{const e=await j(t);await c.from("messages").insert([{room_id:a.currentRoomId,user_id:a.user.id,user_name:a.user.user_metadata?.full_name,content:e}])}catch(e){window.toast("Failed to send")}a.processingAction=!1},window.sendGuestReply=async(e,t)=>{if(!e||!e.isTrusted)return;if(!a.user||!a.currentRoomId)return;if(a.processingAction)return;if(!a.isChatChannelReady)return void window.toast("Connection not ready yet – please wait a moment");if(!D())return;a.processingAction=!0,a.lastMessageTime=Date.now();try{const e=await j(t);await c.from("messages").insert([{room_id:a.currentRoomId,user_id:a.user.id,user_name:a.user.user_metadata?.full_name,content:e}])}catch(e){}a.processingAction=!1},window.leaveChat=async()=>{window.setLoading(!0,"Leaving Room..."),a.chatChannel&&a.chatChannel.unsubscribe(),a.chatChannel=null,a.currentRoomId=null,a.roomGuestStatus={},a.currentRoomAccessType=null,window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.handleLogin=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t=u("l-email").value,r=u("l-pass").value;if(!t||!r)return window.toast("Input missing"),void(a.processingAction=!1);window.setLoading(!0,"Signing In..."),localStorage.removeItem(r);const{error:o}=await c.auth.signInWithPassword({email:t,password:r});o?(window.toast(o.message),window.setLoading(!1)):await A(!0),a.processingAction=!1},window.handleRegister=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t=u("r-name").value,r=u("r-email").value.trim().toLowerCase(),o=u("r-pass").value;if(!t||!r||o.length<8)return window.toast("Check inputs"),void(a.processingAction=!1);window.setLoading(!0,"Sending Code...");const[n,i]=await g(fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send",email:r})}));if(n){if(429===n.status)return window.toast("Too many attempts. Wait a minute."),a.processingAction=!1,void window.setLoading(!1);const e=await n.json();"Code sent"===e.message?(sessionStorage.setItem("temp_reg",JSON.stringify({n:n,r:r,p:o})),window.nav("scr-verify"),(()=>{let e=CONFIG.verificationCodeExpiry;a.vTimer&&clearInterval(a.vTimer),a.vTimer=setInterval(()=>{e--,u("v-timer").innerText=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`,e<=0&&(clearInterval(a.vTimer),window.nav("scr-register"))},1e3)})(),window.setLoading(!1)): (window.toast(e.message||"Mail error"),window.setLoading(!1))}else window.toast("Network error"),window.setLoading(!1),a.processingAction=!1},window.handleVerify=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t=u("v-code").value,r=JSON.parse(sessionStorage.getItem("temp_reg"));if(!r)return window.toast("Session expired"),void(a.processingAction=!1);window.setLoading(!0,"Verifying Code...");const o=await fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"verify",email:r.r,code:t})});429===o.status?(window.toast("Too many attempts."),a.processingAction=!1,window.setLoading(!1)):(o=await o.json(),"Verified"===o.message?(localStorage.removeItem(r),await c.auth.signUp({email:r.r,password:r.p,options:{data:{full_name:r.n}}}).then(async({error:e})=>{e?(window.toast(e.message),window.setLoading(!1)):await A(!0)})): (window.toast(o.message||"Wrong code"),window.setLoading(!1)),a.processingAction=!1)},window.handleGuestLogin=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;const t=u("g-name").value.trim(),r=localStorage.getItem(o);let n=r||t;if(!n)return window.toast("Please enter a name.");r? (await(()=>{window.closeOverlay(),window.setLoading(!0,"Initializing..."),localStorage.removeItem(r);const{data:{user:e}}=await c.auth.getUser();let t;if(e&&e.is_anonymous){const r=e.user_metadata?.full_name;r&&r!==n? (await c.auth.updateUser({data:{full_name:n}}),t=e,t.user_metadata=t.user_metadata||{},t.user_metadata.full_name=n):t=e}else{const{data:{user:r},error:o}=await c.auth.signInAnonymously();if(o)return window.toast(o.message||"Anonymous login failed"),void window.setLoading(!1);t=r,await new Promise(e=>setTimeout(e,1e3)),await c.auth.refreshSession();const n=await c.auth.getSession();t=n.data.session?.user||r}await c.auth.updateUser({data:{full_name:n}}),await c.from("profiles").upsert({id:t.id,full_name:n,is_guest:!0}),a.user=t,a.user.user_metadata=a.user.user_metadata||{},a.user.user_metadata.full_name=n,localStorage.setItem(n,t.id),localStorage.setItem(o,n),window.nav("scr-lobby"),window.loadRooms(),await new Promise(e=>setTimeout(e,800)),window.forceClaimMaster(),window.setLoading(!1),await A(!0)})()): (window.openHub(),window.showOverlayView("guest-warn"))},window.confirmGuestLoginAction=async e=>{if(!e||!e.isTrusted)return;const t=u("g-name").value.trim();t&&await(async e=>{window.closeOverlay(),window.setLoading(!0,"Initializing..."),localStorage.removeItem(r);const{data:{user:t}}=await c.auth.getUser();let o;if(t&&t.is_anonymous){const r=t.user_metadata?.full_name;r&&r!==e? (await c.auth.updateUser({data:{full_name:e}}),o=t,o.user_metadata=o.user_metadata||{},o.user_metadata.full_name=e):o=t}else{const{data:{user:r},error:n}=await c.auth.signInAnonymously();if(n)return window.toast(n.message||"Anonymous login failed"),void window.setLoading(!1);o=r,await new Promise(e=>setTimeout(e,1e3)),await c.auth.refreshSession();const i=await c.auth.getSession();o=i.data.session?.user||r}await c.auth.updateUser({data:{full_name:e}}),await c.from("profiles").upsert({id:o.id,full_name:e,is_guest:!0}),a.user=o,a.user.user_metadata=a.user.user_metadata||{},a.user.user_metadata.full_name=e,localStorage.setItem(n,o.id),localStorage.setItem(r,e),window.nav("scr-lobby"),window.loadRooms(),await new Promise(e=>setTimeout(e,800)),window.forceClaimMaster(),window.setLoading(!1),await A(!0)})(t)},window.handleCreate=async e=>{if(!e||!e.isTrusted)return;if(a.serverFull)return window.toast("Network full");if(a.user?.is_anonymous)return window.toast("Guests cannot create rooms");if(a.processingAction)return;a.processingAction=!0;const t=u("c-name").value.trim(),r=u("c-pass").value,o=u("c-private").checked,n=u("c-allowed").value.trim();if(o&&!r)return window.toast("Private rooms require a password"),void(a.processingAction=!1);if(!t)return window.toast("Name required"),void(a.processingAction=!1);let i=["*"];if(n)if("*"===n.trim())i=["*"];else{i=n.split(",").map(e=>e.trim()).filter(e=>e.length>0),i.includes(a.user.id)||i.push(a.user.id)}window.setLoading(!0,"Deploying Room...");const l=w(),{data:s,error:d}=await c.from("rooms").insert([{name:t,has_password:!!r,is_private:o,salt:l,created_by:a.user.id,allowed_users:i}]).select();if(d)return window.toast("Error: "+d.message),a.processingAction=!1,void window.setLoading(!1);s&&s.length>0&&(r&&await k(r+l).then(async e=>await c.rpc("set_room_password",{p_room_id:s[0].id,p_hash:e})),a.lastCreated=s[0],a.lastCreatedPass=r,u("s-id").innerText=s[0].id,window.nav("scr-success")),a.processingAction=!1,window.setLoading(!1)},window.submitGate=async e=>{if(!e||!e.isTrusted)return;const t=u("gate-pass").value,r=await k(t+a.pending.salt);window.setLoading(!0,"Verifying Access...");const{data:o,error:n}=await c.rpc("verify_room_password",{p_room_id:a.pending.id,p_hash:r});window.setLoading(!1),o===!0?window.openVault(a.pending.id,a.pending.name,t,a.pending.salt):window.toast("Access Denied")},window.handleLogout=async e=>{if(!e||!e.isTrusted)return;window.setLoading(!0,"Switching Account..."),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.uptimeInterval&&clearInterval(a.uptimeInterval),a.uptimeInterval=null,a.sessionStartTime=null,a.presenceChannel&&a.presenceChannel.unsubscribe(),a.chatChannel&&a.chatChannel.unsubscribe(),a.user&&a.user.is_anonymous?(localStorage.setItem(n,a.user.id),localStorage.setItem(o,a.user.user_metadata?.full_name),a.user=null,a.isMasterTab=!1,localStorage.setItem(r,"true"),window.nav("scr-start"),window.toast("Guest session saved.")):(localStorage.setItem(r,"true"),a.user=null,localStorage.removeItem(n),localStorage.removeItem(o),await c.auth.signOut(),window.nav("scr-start")),window.setLoading(!1)},window.copyId=()=>{navigator.clipboard.writeText(a.currentRoomId);const e=u("icon-copy-chat"),t=u("icon-check-chat");e.style.display="none",t.style.display="block",setTimeout(()=>{e.style.display="block",t.style.display="none"},2e3)},window.copySId=()=>{navigator.clipboard.writeText(a.lastCreated.id),window.toast("ID Copied")},window.enterCreated=()=>{const e=a.lastCreatedPass;window.openVault(a.lastCreated.id,a.lastCreated.name,e,a.lastCreated.salt),a.lastCreatedPass=null};let z=0,F=0;document.addEventListener("touchstart",e=>z=e.changedTouches[0].screenX,!1),document.addEventListener("touchend",e=>{F=e.changedTouches[0].screenX;const t=document.querySelector(".screen.active");if(!t)return;const r=F-z;"scr-start"===t.id&&r<-50?window.nav("scr-guest","left"):"scr-guest"===t.id&&r>50&&window.nav("scr-start","right")},!1),window.addEventListener("online",()=>{u("offline-screen").classList.remove("active"),window.toast("Back online"),a.user&&a.isMasterTab&&A(!0)}),window.addEventListener("offline",()=>{u("offline-screen").classList.add("active"),p(null),window.toast("Connection lost")}),c.auth.onAuthStateChange(async(e,t)=>{const r=localStorage.getItem(r)==="true";if(r)return void(a.user=null);a.user=t?.user;const o=u("icon-plus-lobby"),n=document.querySelector(".screen.active")?.id;o&&(o.style.display=a.user?.is_anonymous&&"scr-lobby"===n?"none":"flex"),"SIGNED_IN"===e&&a.user&&(localStorage.setItem(n,a.user.id),a.user.user_metadata?.full_name&&localStorage.setItem(o,a.user.user_metadata.full_name),a.sessionStartTime=Date.now(),a.uptimeInterval&&clearInterval(a.uptimeInterval),a.uptimeInterval=setInterval(m,1e3),["scr-start","scr-login","scr-register","scr-verify"].includes(n)&&(window.nav("scr-lobby"),window.loadRooms(),window.forceClaimMaster())),"SIGNED_OUT"===e&&(a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.uptimeInterval&&clearInterval(a.uptimeInterval),a.uptimeInterval=null,a.sessionStartTime=null,a.presenceChannel&&a.presenceChannel.unsubscribe(),a.chatChannel&&a.chatChannel.unsubscribe(),localStorage.removeItem(n),localStorage.removeItem(o),localStorage.removeItem(r),window.nav("scr-start"))});const J=async()=>{if(!navigator.onLine)return void u("offline-screen").classList.add("active");if(localStorage.getItem(r)==="true")return a.user=null,window.nav("scr-start"),void window.setLoading(!1);const[e,t]=await g(c.auth.getSession());if(t)return console.error("Failed to get session:",t),window.toast("Failed to get session"),window.nav("scr-start"),void window.setLoading(!1);const o=e.data.session;o?(a.user=o.user,localStorage.setItem(n,a.user.id),a.user.user_metadata?.full_name&&localStorage.setItem(o,a.user.user_metadata.full_name),(await O())?(u("block-overlay").classList.add("active"),lucide.createIcons(),window.nav("scr-lobby"),window.loadRooms()):(window.forceClaimMaster(),window.nav("scr-lobby"),window.loadRooms()),a.sessionStartTime=Date.now(),a.uptimeInterval&&clearInterval(a.uptimeInterval),a.uptimeInterval=setInterval(m,1e3),await A(!0)):u("guest-swipe-hint").style.display="flex",lucide.createIcons(),window.setLoading(!1),S()};J()}
