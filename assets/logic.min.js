// GH: HyperRushNet | 2026 | MIT License | logic.min.js
import{createClient}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";export function startChatApp(e={}){const t={supabaseUrl:e.supabaseUrl||"https://jnhsuniduzvhkpexorqk.supabase.co",supabaseKey:e.supabaseKey||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuaHN1bmlkdXp2aGtwZXhvcnFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NjAxMDYsImV4cCI6MjA4NzEzNjEwNn0.9I5bbqskCgksUaNWYlFFo0-6Odht28pOMdxTGZECahY",mailApi:e.mailApi||"https://vercel-serverless-gray-sigma.vercel.app/api/mailAPI",maxUsers:e.maxUsers,maxMessages:e.maxMessages||15,historyLoadLimit:e.historyLoadLimit||10,rateLimitMs:e.rateLimitMs||1e3,presenceHeartbeatMs:e.presenceHeartbeatMs||1e4,reconnectDebounceMs:e.reconnectDebounceMs||3e3,verificationCodeExpiry:e.verificationCodeExpiry||600},n=["https://cdn-icons-png.flaticon.com/512/6997/6997676.png","https://cdn-icons-png.flaticon.com/512/236/236831.png","https://cdn-icons-png.freepik.com/256/6997/6997667.png?semt=ais_white_label","https://cdn-icons-png.flaticon.com/512/6997/6997668.png","https://img.freepik.com/free-photo/sunset-time-tropical-beach-sea-with-coconut-palm-tree_74190-1075.jpg?semt=ais_user_personalization&w=740&q=80","https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTECqduTKufgQgmfy7ZUMpWOrFXNyHpNWQvPA&s"];lucide.createIcons();const a={user:null,currentRoomId:null,chatChannel:null,presenceChannel:null,allRooms:[],vTimer:null,lastRenderedDateLabel:null,lastKnownOnlineCount:null,heartbeatInterval:null,uptimeInterval:null,sessionStartTime:null,isPresenceSubscribed:!1,lastReconnectAttempt:0,pending:null,lastCreated:null,lastCreatedPass:null,isMasterTab:!1,tabId:sessionStorage.getItem("hrn_tab_id")||(sessionStorage.setItem("hrn_tab_id",crypto.randomUUID()),sessionStorage.getItem("hrn_tab_id")),processingAction:!1,serverFull:!1,isLoadingHistory:!1,oldestMessageTimestamp:null,hasMoreHistory:!0,lastMessageTime:0,isConnecting:!1,isChatChannelReady:!1,currentRoomAccessType:null,currentRoomData:null,selectedAllowedUsers:[],currentPickerContext:null,lastLobbyRefresh:0,removePasswordFlag:!1,longPressTimer:null,currentStep:{create:1,edit:1,reg:1},selectedAvatar:null,createType:"group",currentRoomPassword:null,reconnectTimer:null,isReconnecting:!1,deleteConfirmTimeout:null,profileCache:{}},s="hrn_flag_force_logout";let r=[],i=!1;const o=new BroadcastChannel("hrn_tab_sync"),c=createClient(t.supabaseUrl,t.supabaseKey,{auth:{persistSession:!0,autoRefreshToken:!0},realtime:{params:{eventsPerSecond:10}}}),l=e=>{const t=document.createElement("p");return t.textContent=e,t.innerHTML},d=e=>document.getElementById(e),u=e=>{const t=d("chat-avatar-display");t&&(t.classList.remove("status-connected","status-connecting","status-offline"),"connected"===e?t.classList.add("status-connected"):"connecting"===e?t.classList.add("status-connecting"):t.classList.add("status-offline"))},m=()=>{if(i||0===r.length)return;i=!0;const e=r.shift(),t=d("toast-container"),n=document.createElement("div");n.className="toast-item",n.innerText=e,n.onclick=()=>{n.style.opacity="0",setTimeout((()=>{n.remove(),i=!1,m()}),400)},t.appendChild(n),setTimeout((()=>{n.parentNode&&(n.style.opacity="0",setTimeout((()=>{n.parentNode&&n.remove(),i=!1,m()}),400))}),3e3)};window.toast=e=>{r.push(e),m()},window.setLoading=(e,t=null)=>{const n=d("loader-overlay"),a=d("loader-text");e?n.classList.add("active"):n.classList.remove("active"),a.innerText=t||"Loading..."};const p=async e=>{try{return[await e,null]}catch(e){return[null,e]}},w=new Blob(["self.onmessage = async (e) => {\n        const { type, payload } = e.data;\n        const encoder = new TextEncoder();\n        const decoder = new TextDecoder();\n        try {\n            if (type === 'deriveKey') {\n                const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(payload.password), { name: 'PBKDF2' }, false, ['deriveKey']);\n                const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: encoder.encode(payload.salt), iterations: 300000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);\n                self.cryptoKey = key;\n                self.postMessage({ type: 'keyDerived', success: true });\n            } else if (type === 'encrypt') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\");\n                const iv = crypto.getRandomValues(new Uint8Array(12));\n                const encoded = encoder.encode(payload.text);\n                const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, self.cryptoKey, encoded);\n                const combined = new Uint8Array(iv.length + ciphertext.byteLength);\n                combined.set(iv, 0);\n                combined.set(new Uint8Array(ciphertext), iv.length);\n                const base64 = btoa(String.fromCharCode(...combined));\n                self.postMessage({ type: 'encrypted', result: base64 });\n            } else if (type === 'decryptHistory') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\");\n                const results = [];\n                for (const m of payload.messages) {\n                    try {\n                        const binary = atob(m.content);\n                        const bytes = new Uint8Array(binary.length);\n                        for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n                        const iv = bytes.slice(0, 12);\n                        const ciphertext = bytes.slice(12);\n                        const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n                        const text = decoder.decode(decrypted);\n                        const parts = text.split('|');\n                        results.push({ id: m.id, time: parts[0], text: parts.slice(1).join('|'), user_id: m.user_id, user_name: m.user_name, created_at: m.created_at });\n                    } catch (err) { results.push({ id: m.id, error: true }); }\n                }\n                self.postMessage({ type: 'historyDecrypted', results });\n            } else if (type === 'decryptSingle') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\");\n                try {\n                    const binary = atob(payload.content);\n                    const bytes = new Uint8Array(binary.length);\n                    for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n                    const iv = bytes.slice(0, 12);\n                    const ciphertext = bytes.slice(12);\n                    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n                    const text = decoder.decode(decrypted);\n                    const parts = text.split('|');\n                    self.postMessage({ type: 'singleDecrypted', result: { time: parts[0], text: parts.slice(1).join('|') } });\n                } catch(e) { self.postMessage({ type: 'singleDecrypted', error: e.message }); }\n            }\n        } catch (error) { self.postMessage({ type: 'error', message: error.message }); }\n    };"],{type:"application/javascript"}),g=new Worker(URL.createObjectURL(w)),v={};g.onmessage=e=>{const{type:t}=e.data;v[t]&&(v[t](e.data),delete v[t])};const y=async e=>{const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")},h=async()=>{a.connectionTimeoutTimer&&(clearTimeout(a.connectionTimeoutTimer),a.connectionTimeoutTimer=null),a.reconnectTimer&&(clearTimeout(a.reconnectTimer),a.reconnectTimer=null),a.heartbeatInterval&&(clearInterval(a.heartbeatInterval),a.heartbeatInterval=null),a.presenceChannel&&(a.presenceChannel.unsubscribe(),a.presenceChannel=null,a.isPresenceSubscribed=!1),a.chatChannel&&(a.chatChannel.unsubscribe(),a.chatChannel=null),u("offline")},f=async()=>{if(!a.presenceChannel)return;const e=a.presenceChannel.presenceState(),n=Object.values(e).flat();new Set(n.map((e=>e.user_id))).size>t.maxUsers?a.serverFull||(a.serverFull=!0,d("capacity-overlay").classList.add("active"),h()):(a.serverFull=!1,d("capacity-overlay").classList.remove("active"))},b=()=>{navigator.onLine&&a.currentRoomId&&a.user&&(a.isReconnecting&&!a.connectionTimeoutTimer||(h(),a.isReconnecting=!0,u("connecting"),a.connectionTimeoutTimer=setTimeout((()=>{console.warn("Connection attempt timed out. Forcing cleanup and retry..."),a.isReconnecting=!1,b()}),1e4),T(a.currentRoomId),_(a.currentRoomId)))},_=e=>{a.chatChannel&&a.chatChannel.unsubscribe();const t=a.currentRoomData?.is_direct;a.chatChannel=c.channel(`room_chat_${e}`,{config:{broadcast:{self:!0}}}),a.chatChannel.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${e}`},(async e=>{const n=e.new;n&&a.currentRoomId&&(v.singleDecrypted=async e=>{if(e.result){const s={...n,time:e.result.time,text:e.result.text},r=d("chat-messages"),i=r.querySelector(".msg:last-of-type");let o=null;i&&(o={user_id:i.classList.contains("me")?a.user.id:"other",created_at:i.dataset.time}),r.insertAdjacentHTML("beforeend",D(s,o,t)),r.scrollTop=r.scrollHeight,M()}},g.postMessage({type:"decryptSingle",payload:{content:n.content}}))})).subscribe((e=>{a.isChatChannelReady="SUBSCRIBED"===e,"SUBSCRIBED"===e?(a.connectionTimeoutTimer&&(clearTimeout(a.connectionTimeoutTimer),a.connectionTimeoutTimer=null),a.isReconnecting=!1,a.reconnectTimer&&clearTimeout(a.reconnectTimer),u("connected")):"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||(a.connectionTimeoutTimer&&(clearTimeout(a.connectionTimeoutTimer),a.connectionTimeoutTimer=null),navigator.onLine&&!a.serverFull&&(a.isChatChannelReady=!1,a.isReconnecting||(a.isReconnecting=!0,u("connecting"),a.reconnectTimer=setTimeout(b,1e3))))}))},T=async e=>{if(!a.user)return;a.presenceChannel&&a.presenceChannel.unsubscribe();const n=a.user.id;a.presenceChannel=c.channel(`room_presence:${e}`,{config:{presence:{key:n}}}),a.presenceChannel.on("presence",{event:"sync"},(()=>{a.presenceChannel&&f()})).subscribe((async(e,s)=>{if("SUBSCRIBED"===e){if(!a.presenceChannel)return;a.isPresenceSubscribed=!0,a.isReconnecting=!1,f(),await a.presenceChannel.track({user_id:n,online_at:(new Date).toISOString()}),f(),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.heartbeatInterval=setInterval((async()=>{a.presenceChannel&&!a.serverFull&&await a.presenceChannel.track({user_id:n,online_at:(new Date).toISOString()})}),t.presenceHeartbeatMs)}else"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||(a.isPresenceSubscribed=!1,!navigator.onLine||a.serverFull||a.isReconnecting||(a.isReconnecting=!0,u("connecting"),a.reconnectTimer=setTimeout(b,1e3)))}))},L=()=>{window.addEventListener("online",(()=>{d("offline-screen").classList.remove("active"),u("connecting"),b()})),window.addEventListener("offline",(()=>{d("offline-screen").classList.add("active"),u("offline"),a.connectionTimeoutTimer&&clearTimeout(a.connectionTimeoutTimer),a.reconnectTimer&&clearTimeout(a.reconnectTimer),a.isReconnecting=!1})),setInterval((()=>{navigator.onLine||d("offline-screen").classList.contains("active")||d("offline-screen").classList.add("active")}),2e3),document.addEventListener("visibilitychange",(async()=>{"visible"===document.visibilityState&&a.currentRoomId&&navigator.onLine&&!a.serverFull&&(a.isChatChannelReady?a.presenceChannel&&a.user&&(await a.presenceChannel.track({user_id:a.user.id,online_at:(new Date).toISOString()}),f()):b())}))};window.retryConnection=()=>{d("capacity-overlay").classList.remove("active"),a.serverFull=!1,a.currentRoomId&&T(a.currentRoomId)};const x=e=>{const t=d(`${e}-access-summary`);if(!t)return;const n=a.selectedAllowedUsers.length,s=0===n?"Public Room":`${n} User${n>1?"s":""}`;t.innerHTML=`<span class="c-main">${s}</span><i data-lucide="chevron-right" class="w-16 h-16"></i>`,lucide.createIcons()},C=e=>{const t=a.currentStep[e],n=d(`${e}-step-indicator`);n&&(n.querySelectorAll(".step-dot").forEach(((e,n)=>{n<t?e.classList.add("active"):e.classList.remove("active")})),d(`${e}-step-1`).classList.toggle("active",1===t),d(`${e}-step-2`).classList.toggle("active",2===t),"reg"===e&&(d("reg-step-1").classList.toggle("active",1===t),d("reg-step-2").classList.toggle("active",2===t),2===t&&I()),lucide.createIcons())},I=()=>{const e=d("avatar-grid");!e||e.children.length>0||(e.innerHTML=n.map(((e,t)=>`<div class="avatar-option ${a.selectedAvatar===e?"selected":""}" onclick="window.selectAvatar('${e}', this)"><img src="${e}" alt="Avatar"></div>`)).join(""))};window.selectAvatar=(e,t)=>{a.selectedAvatar=e,d("r-avatar-url").value="",document.querySelectorAll(".avatar-option").forEach((e=>e.classList.remove("selected"))),t.classList.add("selected")},window.selectCreateType=e=>{a.createType=e,document.querySelectorAll(".type-card").forEach((e=>e.classList.remove("selected"))),d(`type-${e}`).classList.add("selected")},window.nextRegStep=()=>{const e=d("r-name").value,t=d("r-email").value,n=d("r-pass").value;if(!e||!t||n.length<8)return window.toast("Complete fields (min 8 chars password)");a.currentStep.reg=2,C("reg")},window.prevRegStep=()=>{a.currentStep.reg=1,C("reg")},window.nextCreateStep=()=>{a.currentStep.create=2,C("create"),"direct"===a.createType?(d("create-group-fields").classList.add("dn"),d("create-direct-fields").classList.remove("dn"),d("create-access-summary").classList.add("dn"),d("create-step2-title").innerText="Direct Message",d("create-step2-sub").innerText="Who are you messaging?"):(d("create-group-fields").classList.remove("dn"),d("create-direct-fields").classList.add("dn"),d("create-access-summary").classList.remove("dn"),d("create-step2-title").innerText="Setup",d("create-step2-sub").innerText="Details"),x("create")},window.prevCreateStep=()=>{a.currentStep.create=1,C("create")},window.nextEditStep=()=>{if(!d("edit-room-name").value.trim())return window.toast("Name required");a.currentStep.edit=2,C("edit"),x("edit")},window.prevEditStep=()=>{a.currentStep.edit=1,C("edit")},window.openAccessManager=async e=>{if(a.currentPickerContext=e,"edit-room"===e&&0===a.selectedAllowedUsers.length&&a.currentRoomData){const e=a.currentRoomData.allowed_users;if(e&&!e.includes("*")){const{data:t}=await c.from("profiles").select("id, full_name, avatar_url").in("id",e);a.selectedAllowedUsers=e.map((e=>{const n=t?.find((t=>t.id===e));return{id:e,name:n?.full_name||"Unknown",avatar:n?.avatar_url}}))}}A(),d("overlay-container").classList.add("active"),window.showOverlayView("access-manager"),d("picker-id-input").value="",d("picker-id-input").focus()},window.closeAccessManager=()=>{"edit-room"===a.currentPickerContext?window.showOverlayView("room-settings"):window.closeOverlay(),x(a.currentPickerContext)};const A=()=>{const e=d("picker-selected-list"),t=a.selectedAllowedUsers;if(0===t.length)return e.innerHTML='<div style="color:var(--text-mute);padding:20px 0;font-size:12px;text-align:center">No users selected.</div>',void(d("picker-count").innerText="0");d("picker-count").innerText=t.length,e.innerHTML=t.map((e=>`\n        <div class="picker-user-card" style="display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">\n        <div style="width:28px;height:28px;border-radius:50%;background:#f2f2f7;overflow:hidden;margin-right:8px;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800;font-size:11px">${e.avatar?`<img src="${e.avatar}" style="width:100%;height:100%;object-fit:cover">`:e.name.charAt(0)}</div>\n        <div style="flex:1;min-width:0"><div style="font-weight:700;font-size:12px">${l(e.name)} ${e.id===a.user.id?'<span style="color:var(--text-mute);font-weight:500">(You)</span>':""}</div><div style="font-size:9px;color:var(--text-mute);font-family:monospace">${e.id}</div></div>\n        <button class="picker-remove-btn" style="background:transparent;border:none;color:var(--danger);cursor:pointer;padding:8px" onclick="window.removePickerUser('${e.id}')"><i data-lucide="x" style="width:14px;height:14px"></i></button>\n        </div>`)).join(""),lucide.createIcons()};window.removePickerUser=e=>{a.selectedAllowedUsers=a.selectedAllowedUsers.filter((t=>t.id!==e)),A()},window.addUserById=async()=>{const e=d("picker-id-input"),t=e.value.trim();if(!t)return window.toast("Enter ID");if(a.selectedAllowedUsers.find((e=>e.id===t)))return window.toast("User already added");window.setLoading(!0,"Fetching...");const{data:n,error:s}=await c.from("profiles").select("id, full_name, avatar_url").eq("id",t).single();if(window.setLoading(!1),s||!n)return window.toast("User not found");a.selectedAllowedUsers.push({id:n.id,name:n.full_name,avatar:n.avatar_url}),A(),e.value="",window.toast("Added")},window.forceClaimMaster=()=>{a.isMasterTab||(a.isMasterTab=!0,o.postMessage({type:"CLAIM_MASTER",id:a.tabId}),d("block-overlay").classList.remove("active"))},o.onmessage=e=>{if("CLAIM_MASTER"===e.data.type&&e.data.id!==a.tabId&&a.isMasterTab){h(),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.heartbeatInterval=null,a.isPresenceSubscribed=!1,a.isMasterTab=!1,u("offline");const e=d("block-overlay");e.innerHTML='<i data-lucide="log-out" style="width:48px;height:48px;margin-bottom:24px;color:var(--danger)"></i><h1 class="title">Session Moved</h1><p class="subtitle" style="margin-bottom:48px">You switched to a new tab.</p><button class="btn btn-accent" onclick="window.forceClaimMaster()">Use Here</button>',e.classList.add("active"),lucide.createIcons()}"PING_MASTER"===e.data.type&&a.isMasterTab&&o.postMessage({type:"PONG_MASTER"})},window.addEventListener("beforeunload",(()=>o.postMessage({type:"CLAIM_MASTER",id:a.tabId})));window.closeOverlay=()=>d("overlay-container").classList.remove("active"),window.showOverlayView=e=>{const t=document.querySelector(".panel-card");if(!t)return;t.querySelectorAll(".view-content").forEach((e=>e.classList.remove("active")));const n=d(`view-${e}`);n&&(n.classList.add("active"),lucide.createIcons())},window.prepareAccountPage=async()=>{if(!a.user)return;const{data:e}=await c.from("profiles").select("avatar_url, full_name").eq("id",a.user.id).single(),t=e?.full_name||a.user.user_metadata?.full_name||"User",n=e?.avatar_url||a.user.user_metadata?.avatar_url;d("acc-page-name").innerText=t,d("acc-page-type").innerText="Full Account",d("acc-page-id").innerText=a.user.id;const s=d("acc-page-avatar");n?s.innerHTML=`<img src="${n}">`:s.innerText=t.charAt(0),d("acc-email-wrapper").style.display="block",d("acc-page-email").innerText=a.user.email||"Not set",lucide.createIcons()},window.copyAccountId=()=>{a.user&&(navigator.clipboard.writeText(a.user.id),window.toast("ID Copied"))},window.copyInfoId=()=>{a.currentRoomId&&(navigator.clipboard.writeText(a.currentRoomId),window.toast("Room ID Copied"))};const R=async()=>{if(!a.user)return;const e=d("lobby-avatar-btn");if(!e)return;let t=a.user.user_metadata?.avatar_url,n=a.user.user_metadata?.full_name;if(!t||!n){const{data:e}=await c.from("profiles").select("avatar_url, full_name").eq("id",a.user.id).single();e&&(t=e.avatar_url,n=e.full_name)}t?e.innerHTML=`<img src="${t}">`:e.innerText=(n||"U").charAt(0)},S=e=>{const t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(e.getFullYear(),e.getMonth(),e.getDate()),s=Math.round((n-a)/864e5);return 0===s?"Today":1===s?"Yesterday":s<7?e.toLocaleDateString("en-GB",{weekday:"long"}):e.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})},M=()=>{const e=d("chat-messages"),t=d("chat-empty-state"),n=e.querySelector(".msg");t&&(t.style.display=n?"none":"flex")},D=(e,t,n)=>{let s="";const r=new Date(e.created_at),i=S(r),o=!t||t.user_id!==e.user_id||S(new Date(t.created_at))!==i;o&&i!==a.lastRenderedDateLabel&&(s+=`<div class="date-divider"><span class="date-label">${i}</span></div>`,a.lastRenderedDateLabel=i);const c=((e,t=20)=>e?e.length>t?e.substring(0,t)+"...":e:"")(e.user_name||"User",18),d=(e=>{let t=l(e);return t=t.replace(/(https?:\/\/[^\s]+)/g,(e=>{const t=e.replace(/[<>"']/g,"");return`<a href="${t}" target="_blank" rel="noopener noreferrer" class="chat-link">${t}</a>`})),t})(e.text),u=o?"group-start":"msg-continuation",m=e.user_id===a.user?.id?"me":"not-me",p=r.toLocaleString("en-GB",{dateStyle:"full",timeStyle:"short"}),w=`<b>${l(e.user_name||"User")}</b><br>${p}`;return s+=`<div class="msg ${m} ${u}" data-time="${e.created_at}" data-tooltip="${l(w)}" oncontextmenu="event.preventDefault(); showTooltip(event, this.dataset.tooltip)" ontouchstart="window.startMsgTimer(event, this)" ontouchend="window.clearMsgTimer()" ontouchmove="window.clearMsgTimer()">${o&&!n?`<div class="msg-header"><span class="msg-user">${l(c)}</span></div>`:""}<div>${d}</div><span class="msg-time">${l(e.time)}</span></div>`,s};window.startMsgTimer=(e,t)=>{a.longPressTimer=setTimeout((()=>((e,t)=>{const n=d("context-tooltip");n.innerHTML=t,n.classList.add("active");let a=e.clientX||e.touches?.[0]?.clientX,s=e.clientY||e.touches?.[0]?.clientY;n.style.left=`${a}px`,n.style.top=s-40+"px",n.offsetLeft<10&&(n.style.left="10px"),n.offsetTop<10&&(n.style.top=`${s+10}px`)})(e,t.dataset.tooltip)),500)},window.clearMsgTimer=()=>{a.longPressTimer&&clearTimeout(a.longPressTimer),a.longPressTimer=null},document.addEventListener("click",(()=>d("context-tooltip").classList.remove("active")));const U=()=>{const e=d("chat-messages");e&&e.scrollTop<50&&!a.isLoadingHistory&&a.hasMoreHistory&&E()},E=async()=>{if(!a.oldestMessageTimestamp||!a.currentRoomId)return;a.isLoadingHistory=!0;const e=d("chat-messages"),n=e.scrollHeight;e.insertAdjacentHTML("afterbegin",'<div id="history-loader" style="text-align:center;padding:10px;font-size:11px;color:var(--text-mute)">Loading...</div>');const{data:s,error:r}=await c.from("messages").select("*").eq("room_id",a.currentRoomId).lt("created_at",a.oldestMessageTimestamp).order("created_at",{ascending:!1}).limit(t.historyLoadLimit);if(d("history-loader")?.remove(),r||!s||0===s.length)return a.hasMoreHistory=!1,void(a.isLoadingHistory=!1);s.reverse(),v.historyDecrypted=async t=>{const s=t.results.filter((e=>!e.error));if(s.length>0){a.oldestMessageTimestamp=s[0].created_at;let t="",r=null;s.forEach((e=>{t+=D(e,r,a.currentRoomData?.is_direct),r=e})),e.insertAdjacentHTML("afterbegin",t),e.scrollTop=e.scrollHeight-n}a.isLoadingHistory=!1},g.postMessage({type:"decryptHistory",payload:{messages:s}})};window.openRoomInfo=async()=>{if(!a.currentRoomData)return;window.setLoading(!0,"Loading info...");const e=a.currentRoomData,t=d("info-delete-btn"),n=d("info-creator-row");t.style.display="none",t.innerText="Delete Chat",t.classList.remove("active"),a.deleteConfirmTimeout&&clearTimeout(a.deleteConfirmTimeout),d("info-id").innerText=e.id;const s=new Date(e.created_at),r=String(s.getDate()).padStart(2,"0"),i=String(s.getMonth()+1).padStart(2,"0"),o=s.getFullYear();if(d("info-date").innerText=`${r}/${i}/${o}`,e.is_direct){d("info-type").innerText="Direct Message",n.style.display="none";const s=e.allowed_users?.find((e=>e!==a.user.id));if(s){let e=a.profileCache[s];if(!e){const{data:t}=await c.from("profiles").select("full_name, avatar_url").eq("id",s).single();e=t,t&&(a.profileCache[s]=t)}d("info-name").innerText=e?.full_name||"User";const t=d("info-avatar");e?.avatar_url?t.innerHTML=`<img src="${e.avatar_url}">`:t.innerText=(e?.full_name||"U").charAt(0)}else d("info-name").innerText="Chat",d("info-avatar").innerText="?";t.style.display="flex"}else{d("info-type").innerText="Group Chat",d("info-name").innerText=e.name;const s=d("info-avatar");if(e.avatar_url?s.innerHTML=`<img src="${e.avatar_url}">`:s.innerText=e.name.charAt(0),n.style.display="flex",e.created_by){let t=a.profileCache[e.created_by];if(!t){const{data:n}=await c.from("profiles").select("full_name").eq("id",e.created_by).single();t=n,n&&(a.profileCache[e.created_by]=n)}d("info-creator").innerText=t?.full_name||"Unknown"}else d("info-creator").innerText="Unknown";e.created_by===a.user.id&&(t.style.display="flex")}window.setLoading(!1),d("overlay-container").classList.add("active"),window.showOverlayView("room-info"),lucide.createIcons()},window.initiateDeleteRoom=()=>{const e=d("info-delete-btn");e.classList.contains("active")?window.deleteRoom():(e.classList.add("active"),e.innerText="Tap again to confirm",a.deleteConfirmTimeout=setTimeout((()=>{e.classList.remove("active"),e.innerText="Delete Chat"}),3e3))},window.openRoomSettings=async()=>{if(window.closeOverlay(),!a.currentRoomId||!a.currentRoomData||a.currentRoomData.created_by!==a.user.id)return window.toast("Not owner");window.setLoading(!0,"Loading...");const e=a.currentRoomData;a.currentStep.edit=1,C("edit"),d("edit-room-name").value=e.name,d("edit-room-visible").checked=e.is_visible,d("edit-room-pass").value="";const t=d("pass-status-label"),n=d("btn-remove-pass");e.has_password?(t.innerText="Active",t.style.color="var(--success)",n.style.display="block"):(t.innerText="Not Set",t.style.color="var(--text-mute)",n.style.display="none"),a.removePasswordFlag=!1,a.selectedAllowedUsers=[];const s=e.allowed_users;if(s&&!s.includes("*")){const{data:e}=await c.from("profiles").select("id, full_name, avatar_url").in("id",s);a.selectedAllowedUsers=s.map((t=>{const n=e?.find((e=>e.id===t));return{id:t,name:n?.full_name||"Unknown",avatar:n?.avatar_url}}))}d("overlay-container").classList.add("active"),window.showOverlayView("room-settings"),window.setLoading(!1)},window.prepareRemovePassword=()=>{a.removePasswordFlag=!0,d("pass-status-label").innerText="Will be removed",d("pass-status-label").style.color="var(--danger)",d("edit-room-pass").value="",d("edit-room-pass").disabled=!0},window.saveRoomSettings=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t=d("edit-room-name").value.trim(),n=d("edit-room-visible").checked,s=d("edit-room-pass").value;let r=a.selectedAllowedUsers.length>0?a.selectedAllowedUsers.map((e=>e.id)):["*"];if(r.includes(a.user.id)||r.push(a.user.id),!t)return window.toast("Name required"),void(a.processingAction=!1);a.currentRoomData;const i=s.length>0,o=a.removePasswordFlag;window.setLoading(!0,"Saving...");const l={name:t,is_visible:n,allowed_users:r};o?l.has_password=!1:i&&(l.has_password=!0);const{error:u}=await c.from("rooms").update(l).eq("id",a.currentRoomId);if(u)return window.toast("Failed: "+u.message),window.setLoading(!1),void(a.processingAction=!1);if(o)await c.rpc("set_room_password",{p_room_id:a.currentRoomId,p_hash:null}),a.currentRoomData.has_password=!1;else if(i){const e=a.currentRoomData.salt,t=await y(s+e);await c.rpc("set_room_password",{p_room_id:a.currentRoomId,p_hash:t}),a.currentRoomData.has_password=!0}const{data:m}=await c.from("rooms").select("*").eq("id",a.currentRoomId).single();a.currentRoomData=m,d("chat-title").innerText=m.name,window.toast("Saved"),window.closeOverlay(),a.processingAction=!1,window.setLoading(!1)},window.deleteRoom=async()=>{if(!a.currentRoomId)return;window.setLoading(!0,"Deleting...");const{error:e}=await c.from("rooms").delete().eq("id",a.currentRoomId);if(e)return window.toast("Failed: "+e.message),void window.setLoading(!1);window.toast("Deleted"),a.currentRoomId=null,a.currentRoomData=null,window.closeOverlay(),window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.openVault=async(e,n,s,r)=>{if(!a.user)return window.toast("Please login first");window.setLoading(!0,"Decrypting..."),a.currentRoomPassword=s,a.chatChannel&&a.chatChannel.unsubscribe(),a.currentRoomId=e,a.lastRenderedDateLabel=null,a.oldestMessageTimestamp=null,a.hasMoreHistory=!0,a.isLoadingHistory=!1,d("chat-messages").innerHTML='<div id="chat-empty-state" style="inset:0;z-index:5;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;width:100%"><i data-lucide="message-circle" style="width:40px;height:40px;color:#d1d1d6;margin-bottom:12px"></i><div style="font-size:14px;font-weight:700;color:var(--text-main)">No messages yet</div></div>',d("chat-messages").onscroll=U;const i=s?s+e:e;try{await(o=i,l=r,new Promise(((e,t)=>{v.keyDerived=n=>{n.success?e(!0):t("Key derivation failed")},g.postMessage({type:"deriveKey",payload:{password:o,salt:l}})})))}catch(e){return window.setLoading(!1),window.toast("Key derivation failed")}var o,l;const{data:m}=await c.from("rooms").select("*").eq("id",e).single();a.currentRoomData=m;const p=m.is_direct;let w=n,y=m.avatar_url;if(p){const e=m.allowed_users?.find((e=>e!==a.user.id));if(e){let t=a.profileCache[e];if(!t){const{data:n}=await c.from("profiles").select("full_name, avatar_url").eq("id",e).single();t=n,n&&(a.profileCache[e]=n)}t&&(w=t.full_name,y=t.avatar_url)}}d("chat-title").innerText=w;const h=d("chat-avatar-display");y?h.innerHTML=`<img src="${y}">`:h.innerText=w.charAt(0).toUpperCase();const f=d("info-edit-btn");p||m.created_by!==a.user.id?f.style.display="none":f.style.display="flex",lucide.createIcons(),window.setLoading(!0,"Fetching History...");const{data:b}=await c.from("messages").select("*").eq("room_id",e).order("created_at",{ascending:!1}).limit(t.maxMessages);d("chat-input").style.display="block",d("send-btn").style.display="flex",window.nav("scr-chat"),u("connecting"),b&&b.length>0?(b.reverse(),b.length>0&&(a.oldestMessageTimestamp=b[0].created_at),window.setLoading(!0,"Decrypting..."),v.historyDecrypted=async e=>{const t=d("chat-messages");t.innerHTML="";let n=null;e.results.forEach((e=>{e.error||(t.insertAdjacentHTML("beforeend",D(e,n,p)),n=e)})),t.scrollTop=t.scrollHeight,M(),window.setLoading(!1)},g.postMessage({type:"decryptHistory",payload:{messages:b}})):(a.hasMoreHistory=!1,M(),window.setLoading(!1)),_(e),T(e)};window.sendMsg=async e=>{if(!e||!e.isTrusted)return;if(!a.user||!a.currentRoomId||a.processingAction||!a.isChatChannelReady)return;if(!(()=>{const e=Date.now();if(e-a.lastMessageTime<t.rateLimitMs){const n=t.rateLimitMs-(e-a.lastMessageTime);return d("chat-input-area").classList.add("rate-limited"),setTimeout((()=>d("chat-input-area").classList.remove("rate-limited")),n),!1}return!0})())return;a.processingAction=!0;const n=d("chat-input").value.trim();if(n){d("chat-input").value="",a.lastMessageTime=Date.now();try{const e=await(s=n,new Promise(((e,t)=>{v.encrypted=n=>{n.result?e(n.result):t("Encryption failed")};const n=(new Date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});g.postMessage({type:"encrypt",payload:{text:n+"|"+s}})})));await c.from("messages").insert([{room_id:a.currentRoomId,user_id:a.user.id,user_name:a.user.user_metadata?.full_name,content:e}])}catch(e){window.toast("Failed to send")}var s;a.processingAction=!1}else a.processingAction=!1},window.leaveChat=async()=>{window.setLoading(!0,"Leaving..."),a.chatChannel&&a.chatChannel.unsubscribe(),a.chatChannel=null,a.currentRoomId=null,a.currentRoomData=null,a.presenceChannel&&a.presenceChannel.unsubscribe(),a.presenceChannel=null,a.isPresenceSubscribed=!1,a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.heartbeatInterval=null,u("offline"),d("info-edit-btn")&&(d("info-edit-btn").style.display="none"),window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.handleLogin=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t=d("l-email").value,n=d("l-pass").value;if(!t||!n)return window.toast("Input missing"),void(a.processingAction=!1);window.setLoading(!0,"Signing In..."),localStorage.removeItem(s);const{error:r}=await c.auth.signInWithPassword({email:t,password:n});r?(window.toast(r.message),window.setLoading(!1)):(window.nav("scr-lobby"),window.loadRooms()),a.processingAction=!1},window.handleRegister=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const n=d("r-name").value,s=d("r-email").value.trim().toLowerCase(),r=d("r-pass").value,i=d("r-avatar-url").value.trim()||a.selectedAvatar;if(!n||!s||r.length<8)return window.toast("Check inputs"),void(a.processingAction=!1);window.setLoading(!0,"Sending Code...");const[o,c]=await p(fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send",email:s})}));if(o){if(429===o.status)return window.toast("Rate limited"),a.processingAction=!1,void window.setLoading(!1);const e=await o.json();"Code sent"===e.message?(sessionStorage.setItem("temp_reg",JSON.stringify({n:n,em:s,p:r,avatar:i})),window.nav("scr-verify"),k(),window.setLoading(!1)):(window.toast(e.message||"Error"),window.setLoading(!1))}else window.toast("Network error"),window.setLoading(!1);a.processingAction=!1};const k=()=>{let e=t.verificationCodeExpiry;a.vTimer&&clearInterval(a.vTimer),a.vTimer=setInterval((()=>{e--,d("v-timer").innerText=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`,e<=0&&(clearInterval(a.vTimer),window.nav("scr-register"))}),1e3)};window.handleVerify=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const n=d("v-code").value,r=JSON.parse(sessionStorage.getItem("temp_reg"));if(!r)return window.toast("Session expired"),void(a.processingAction=!1);window.setLoading(!0,"Verifying...");const i=await fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"verify",email:r.em,code:n})});if(429===i.status)return window.toast("Rate limited"),a.processingAction=!1,void window.setLoading(!1);const o=await i.json();if("Verified"===o.message){localStorage.removeItem(s);const{error:e}=await c.auth.signUp({email:r.em,password:r.p,options:{data:{full_name:r.n,avatar_url:r.avatar}}});e?(window.toast(e.message),window.setLoading(!1)):(window.nav("scr-lobby"),window.loadRooms())}else window.toast(o.message||"Wrong code"),window.setLoading(!1);a.processingAction=!1},window.handleCreate=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t="direct"===a.createType;let n,s=!0,r=null,i=null,o=null;if(t){if(r=d("c-target-user").value.trim(),!r)return window.toast("User ID required"),void(a.processingAction=!1);const{data:e,error:t}=await c.from("profiles").select("full_name").eq("id",r).single();if(t||!e)return window.toast("User not found"),void(a.processingAction=!1);n="Direct Message",s=!0}else if(n=d("c-name").value.trim(),i=d("c-avatar").value.trim()||null,o=d("c-pass").value,s=d("c-visible").checked,!n)return window.toast("Name required"),void(a.processingAction=!1);let l=["*"];t?l=[a.user.id,r]:a.selectedAllowedUsers.length>0&&(l=a.selectedAllowedUsers.map((e=>e.id)),l.includes(a.user.id)||l.push(a.user.id)),window.setLoading(!0,"Creating...");const u=(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("")})(),m={name:n,avatar_url:i,has_password:!!o,is_visible:s,salt:u,created_by:a.user.id,allowed_users:l,is_direct:t},{data:p,error:w}=await c.from("rooms").insert([m]).select();if(w)return window.toast("Error: "+w.message),a.processingAction=!1,void window.setLoading(!1);if(p&&p.length>0){const e=p[0];if(o){const t=await y(o+u);await c.rpc("set_room_password",{p_room_id:e.id,p_hash:t})}a.lastCreated=e,a.lastCreatedPass=o,d("s-id").innerText=e.id,window.nav("scr-success"),a.selectedAllowedUsers=[]}a.processingAction=!1,window.setLoading(!1)},window.submitGate=async e=>{if(!e||!e.isTrusted)return;const t=d("gate-pass").value,n=await y(t+a.pending.salt);window.setLoading(!0,"Verifying...");const{data:s}=await c.rpc("verify_room_password",{p_room_id:a.pending.id,p_hash:n});window.setLoading(!1),!0===s?window.openVault(a.pending.id,a.pending.name,t,a.pending.salt):window.toast("Access Denied")},window.handleLogout=async e=>{e&&e.isTrusted&&(window.setLoading(!0,"Leaving..."),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.presenceChannel&&a.presenceChannel.unsubscribe(),a.chatChannel&&a.chatChannel.unsubscribe(),localStorage.setItem(s,"true"),a.user=null,await c.auth.signOut(),window.nav("scr-start"),window.setLoading(!1))},window.copySId=()=>{navigator.clipboard.writeText(a.lastCreated.id),window.toast("ID Copied")},window.enterCreated=()=>{window.openVault(a.lastCreated.id,a.lastCreated.name,a.lastCreatedPass,a.lastCreated.salt),a.lastCreatedPass=null},c.auth.onAuthStateChange((async(e,t)=>{if("true"===localStorage.getItem(s))return void(a.user=null);a.user=t?.user;const n=d("icon-plus-lobby"),r=document.querySelector(".screen.active")?.id;if(n&&(n.style.display="flex"),"SIGNED_IN"===e&&a.user){["scr-start","scr-login","scr-register","scr-verify"].includes(r)&&(window.nav("scr-lobby"),window.loadRooms(),window.forceClaimMaster()),R()}"SIGNED_OUT"===e&&(a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.presenceChannel&&a.presenceChannel.unsubscribe(),a.chatChannel&&a.chatChannel.unsubscribe(),localStorage.removeItem(s),window.nav("scr-start"))})),window.nav=(e,t=null)=>{const n=document.querySelector(".screen.active"),s=d(e);if(!s)return;"scr-create"===e&&(a.currentStep.create=1,a.selectedAllowedUsers=[],a.createType="group",C("create"),d("c-name").value="",d("c-target-user").value="",d("c-pass").value="",d("c-avatar").value="",document.querySelectorAll(".type-card").forEach((e=>e.classList.remove("selected"))),d("type-group").classList.add("selected")),"scr-register"===e&&(a.currentStep.reg=1,C("reg")),"scr-account"===e&&window.prepareAccountPage(),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("slide-left","slide-right"))),"left"===t?(n.classList.add("slide-left"),s.classList.remove("slide-right")):"right"===t?(n.classList.add("slide-right"),s.classList.remove("slide-left")):document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),s.classList.add("active"),lucide.createIcons();const r=d("icon-plus-lobby");r&&(r.style.display="flex"),"scr-lobby"===e&&R()},window.refreshLobby=async()=>{const e=Date.now();if(e-a.lastLobbyRefresh<1e4)return window.toast(`Wait ${Math.ceil((1e4-(e-a.lastLobbyRefresh))/1e3)}s`);a.lastLobbyRefresh=e,window.toast("Refreshing..."),await window.loadRooms()},window.loadRooms=async()=>{if(!a.user)return;window.setLoading(!0,"Fetching...");const{data:e,error:t}=await c.from("rooms").select("*").order("created_at",{ascending:!1});if(t)return window.toast("Failed to load rooms"),void window.setLoading(!1);const n=a.user.id,s=[];for(const t of e)if(t.is_direct&&t.allowed_users){const e=t.allowed_users.find((e=>e!==n));if(e)if(a.profileCache[e])s.push({...t,display_name:a.profileCache[e].full_name,display_avatar:a.profileCache[e].avatar_url});else{const{data:n}=await c.from("profiles").select("full_name, avatar_url").eq("id",e).single();n?(a.profileCache[e]=n,s.push({...t,display_name:n.full_name,display_avatar:n.avatar_url})):s.push({...t,display_name:"User",display_avatar:null})}else s.push({...t,display_name:"User",display_avatar:null})}else s.push({...t,display_name:t.name,display_avatar:t.avatar_url});a.allRooms=s,window.filterRooms(),window.setLoading(!1),R()},window.filterRooms=()=>{const e=d("search-bar").value.toLowerCase(),t=d("room-list"),n=(a.user,a.allRooms.filter((t=>{if(!t.is_direct&&!t.is_visible)return!1;return!!(t.display_name||t.name||"").toLowerCase().includes(e)})));0===n.length?t.innerHTML='<div style="text-align:center;padding:40px 20px;color:var(--text-mute)"><i data-lucide="folder" style="width:40px;height:40px;margin-bottom:12px;color:#d1d1d6"></i><div style="font-size:14px;font-weight:700;color:var(--text-main)">No groups yet</div></div>':t.innerHTML=n.map((e=>`\n            <div class="room-card" onclick="window.joinAttempt('${e.id}')">\n            <div class="chat-avatar" style="width:36px;height:36px;margin-right:10px;font-size:13px">${e.display_avatar?`<img src="${e.display_avatar}">`:(e.display_name||"G").charAt(0)}</div>\n            <span class="room-name">${l(e.display_name)}</span>\n            <span class="room-icon">${e.is_direct?'<i data-lucide="user" style="width:14px;height:14px"></i>':""}${e.has_password?'<i data-lucide="lock" style="width:14px;height:14px"></i>':""}</span>\n            </div>`)).join(""),lucide.createIcons()},window.joinAttempt=async e=>{window.setLoading(!0,"Checking...");const{data:t}=await c.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),window.toast("Access denied");const{data:n,error:s}=await c.from("rooms").select("*").eq("id",e).single();if(window.setLoading(!1),s||!n)return window.toast("Not found");a.pending={id:n.id,name:n.name,salt:n.salt},a.currentRoomData=n,n.has_password?window.nav("scr-gate"):window.openVault(n.id,n.name,null,n.salt)},window.joinPrivate=async()=>{if(!a.user)return window.toast("Login required");const e=d("join-id").value.trim();if(!e)return;window.setLoading(!0,"Checking...");const{data:t}=await c.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),window.toast("Access denied or not found");const{data:n}=await c.from("rooms").select("*").eq("id",e).single();window.setLoading(!1),n?(a.pending={id:n.id,name:n.name,salt:n.salt},a.currentRoomData=n,n.has_password?window.nav("scr-gate"):window.openVault(n.id,n.name,null,n.salt)):window.toast("Not found")};(async()=>{if(!navigator.onLine)return void d("offline-screen").classList.add("active");if("true"===localStorage.getItem(s))return a.user=null,window.nav("scr-start"),window.setLoading(!1),void L();const[e,t]=await p(c.auth.getUser());if(t)return console.error("Session validation failed:",t),await c.auth.signOut(),window.nav("scr-start"),window.setLoading(!1),void L();const n=e?.data?.user;if(n){a.user=n;if(await new Promise((e=>{let t=!1;const n=e=>{"PONG_MASTER"===e.data.type&&(t=!0)};o.addEventListener("message",n),o.postMessage({type:"PING_MASTER"}),setTimeout((()=>{o.removeEventListener("message",n),e(t)}),300)}))){d("block-overlay").classList.add("active"),lucide.createIcons(),window.nav("scr-lobby"),window.loadRooms()}else window.forceClaimMaster(),window.nav("scr-lobby"),window.loadRooms()}lucide.createIcons(),window.setLoading(!1),L()})()}
