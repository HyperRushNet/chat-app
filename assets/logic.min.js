// GH: HyperRushNet | 2026 | MIT License | logic.min.js
import{createClient}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";export function startChatApp(e={}){const t={supabaseUrl:e.supabaseUrl||"https://jnhsuniduzvhkpexorqk.supabase.co",supabaseKey:e.supabaseKey||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuaHN1bmlkdXp2aGtwZXhvcnFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NjAxMDYsImV4cCI6MjA4NzEzNjEwNn0.9I5bbqskCgksUaNWYlFFo0-6Odht28pOMdxTGZECahY",mailApi:e.mailApi||"https://vercel-serverless-gray-sigma.vercel.app/api/mailAPI",maxUsers:e.maxUsers,maxMessages:e.maxMessages||15,historyLoadLimit:e.historyLoadLimit||10,rateLimitMs:e.rateLimitMs||1e3,presenceHeartbeatMs:e.presenceHeartbeatMs||1e4,reconnectDebounceMs:e.reconnectDebounceMs||3e3,verificationCodeExpiry:e.verificationCodeExpiry||600},n=["https://cdn-icons-png.flaticon.com/512/6997/6997676.png","https://cdn-icons-png.flaticon.com/512/236/236831.png","https://cdn-icons-png.freepik.com/256/6997/6997667.png?semt=ais_white_label","https://cdn-icons-png.flaticon.com/512/6997/6997668.png","https://img.freepik.com/free-photo/sunset-time-tropical-beach-sea-with-coconut-palm-tree_74190-1075.jpg?semt=ais_user_personalization&w=740&q=80","https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTECqduTKufgQgmfy7ZUMpWOrFXNyHpNWQvPA&s"];lucide.createIcons();const a={user:null,currentRoomId:null,chatChannel:null,presenceChannel:null,globalPresenceChannel:null,allRooms:[],vTimer:null,lastRenderedDateLabel:null,lastKnownOnlineCount:null,globalOnlineCount:0,heartbeatInterval:null,uptimeInterval:null,sessionStartTime:null,isPresenceSubscribed:!1,lastReconnectAttempt:0,pending:null,lastCreated:null,lastCreatedPass:null,isMasterTab:!1,tabId:sessionStorage.getItem("hrn_tab_id")||(sessionStorage.setItem("hrn_tab_id",crypto.randomUUID()),sessionStorage.getItem("hrn_tab_id")),processingAction:!1,serverFull:!1,isLoadingHistory:!1,oldestMessageTimestamp:null,hasMoreHistory:!0,lastMessageTime:0,isConnecting:!1,isChatChannelReady:!1,currentRoomAccessType:null,currentRoomData:null,selectedAllowedUsers:[],currentPickerContext:null,lastLobbyRefresh:0,removePasswordFlag:!1,longPressTimer:null,currentStep:{create:1,edit:1,reg:1},selectedAvatar:null,createType:"group",currentRoomPassword:null,reconnectTimer:null,isReconnecting:!1,deleteConfirmTimeout:null,profileCache:{},editingMessage:null,contextTarget:null,carouselIndex:0,connectionStrength:"4g"},s="hrn_flag_force_logout";let r=[],i=!1;const o=new BroadcastChannel("hrn_tab_sync"),c=createClient(t.supabaseUrl,t.supabaseKey,{auth:{persistSession:!0,autoRefreshToken:!0},realtime:{params:{eventsPerSecond:10}}}),l=e=>{const t=document.createElement("p");return t.textContent=e,t.innerHTML},d=e=>document.getElementById(e),u=e=>{const t=d("chat-avatar-display");t&&(t.classList.remove("status-connected","status-connecting","status-offline"),"connected"===e?t.classList.add("status-connected"):"connecting"===e?t.classList.add("status-connecting"):t.classList.add("status-offline"))},p=()=>{const e=d("room-user-count"),n=d("info-room-count"),s=d("info-global-count"),r=a.lastKnownOnlineCount||0;e&&(e.innerText=r),n&&(n.innerText=r),s&&(s.innerText=`${a.globalOnlineCount}/${t.maxUsers}`)},m=()=>{if(i||0===r.length)return;i=!0;const e=r.shift(),t=d("toast-container"),n=document.createElement("div");n.className="toast-item",n.innerText=e,n.onclick=()=>{n.style.opacity="0",setTimeout((()=>{n.remove(),i=!1,m()}),400)},t.appendChild(n),setTimeout((()=>{n.parentNode&&(n.style.opacity="0",setTimeout((()=>{n.parentNode&&n.remove(),i=!1,m()}),400))}),3e3)};window.toast=e=>{r.push(e),m()},window.setLoading=(e,t=null)=>{const n=d("loader-overlay"),a=d("loader-text");e?n.classList.add("active"):n.classList.remove("active"),a.innerText=t||"Loading..."};const w=async e=>{try{return[await e,null]}catch(e){return[null,e]}},g=new Blob(["self.onmessage = async (e) => {\n        const { type, payload } = e.data; const encoder = new TextEncoder(); const decoder = new TextDecoder();\n        try {\n            if (type === 'deriveKey') {\n                const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(payload.password), { name: 'PBKDF2' }, false, ['deriveKey']);\n                const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: encoder.encode(payload.salt), iterations: 300000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);\n                self.cryptoKey = key; self.postMessage({ type: 'keyDerived', success: true });\n            } else if (type === 'encrypt') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\"); const iv = crypto.getRandomValues(new Uint8Array(12));\n                const encoded = encoder.encode(payload.text); const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, self.cryptoKey, encoded);\n                const combined = new Uint8Array(iv.length + ciphertext.byteLength); combined.set(iv, 0); combined.set(new Uint8Array(ciphertext), iv.length);\n                const base64 = btoa(String.fromCharCode(...combined)); self.postMessage({ type: 'encrypted', result: base64 });\n            } else if (type === 'decryptHistory') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\"); const results = [];\n                for (const m of payload.messages) {\n                    try {\n                        if (m.content === '/') { results.push({ id: m.id, deleted: true, user_id: m.user_id, user_name: m.user_name, created_at: m.created_at, updated_at: m.updated_at }); continue; }\n                        const binary = atob(m.content); const bytes = new Uint8Array(binary.length);\n                        for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n                        const iv = bytes.slice(0, 12); const ciphertext = bytes.slice(12);\n                        const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n                        const text = decoder.decode(decrypted); const parts = text.split('|');\n                        results.push({ id: m.id, time: parts[0], text: parts.slice(1).join('|'), user_id: m.user_id, user_name: m.user_name, created_at: m.created_at, updated_at: m.updated_at });\n                    } catch (err) { results.push({ id: m.id, error: true }); }\n                } self.postMessage({ type: 'historyDecrypted', results });\n            } else if (type === 'decryptSingle') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\");\n                if (payload.content === '/') { self.postMessage({ type: 'singleDecrypted', result: { deleted: true } }); return; }\n                try {\n                    const binary = atob(payload.content); const bytes = new Uint8Array(binary.length);\n                    for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n                    const iv = bytes.slice(0, 12); const ciphertext = bytes.slice(12);\n                    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n                    const text = decoder.decode(decrypted); const parts = text.split('|');\n                    self.postMessage({ type: 'singleDecrypted', result: { time: parts[0], text: parts.slice(1).join('|') } });\n                } catch(e) { self.postMessage({ type: 'singleDecrypted', error: e.message }); }\n            }\n        } catch (error) { self.postMessage({ type: 'error', message: error.message }); }\n    };"],{type:"application/javascript"}),v=new Worker(URL.createObjectURL(g)),y={};v.onmessage=e=>{const{type:t}=e.data;y[t]&&(y[t](e.data),delete y[t])};const h=async e=>{const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")},f=e=>new Promise(((t,n)=>{y.encrypted=e=>{e.result?t(e.result):n("Encryption failed")};const a=(new Date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});v.postMessage({type:"encrypt",payload:{text:a+"|"+e}})})),b=async()=>{a.connectionTimeoutTimer&&(clearTimeout(a.connectionTimeoutTimer),a.connectionTimeoutTimer=null),a.reconnectTimer&&(clearTimeout(a.reconnectTimer),a.reconnectTimer=null),a.heartbeatInterval&&(clearInterval(a.heartbeatInterval),a.heartbeatInterval=null),a.presenceChannel&&(a.presenceChannel.unsubscribe(),a.presenceChannel=null,a.isPresenceSubscribed=!1),a.chatChannel&&(a.chatChannel.unsubscribe(),a.chatChannel=null),u("offline")},_=async()=>{if(!a.presenceChannel)return;const e=a.presenceChannel.presenceState(),t=Object.values(e).flat(),n=new Set(t.map((e=>e.user_id)));a.lastKnownOnlineCount=n.size,p()},T=async()=>{a.globalPresenceChannel&&a.globalPresenceChannel.unsubscribe(),a.user&&(a.globalPresenceChannel=c.channel("global-presence",{config:{presence:{key:a.user.id}}}),a.globalPresenceChannel.on("presence",{event:"sync"},(()=>{const e=a.globalPresenceChannel.presenceState();a.globalOnlineCount=Object.keys(e).length,p(),a.globalOnlineCount>=t.maxUsers?a.serverFull||(a.serverFull=!0,d("capacity-overlay").classList.add("active"),b()):(a.serverFull=!1,d("capacity-overlay").classList.remove("active"))})).subscribe((async e=>{"SUBSCRIBED"===e&&await a.globalPresenceChannel.track({user_id:a.user.id,online_at:(new Date).toISOString()})})))},L=()=>{if(!navigator.onLine||!a.currentRoomId||!a.user)return;if(a.isReconnecting&&!a.connectionTimeoutTimer)return;b(),a.isReconnecting=!0,u("connecting");const e=(()=>{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(e){const t=e.effectiveType;if("4g"===t)return 5e3;if("3g"===t)return 1e4;if("2g"===t)return 2e4;if("slow-2g"===t)return 3e4}return 8e3})();a.connectionTimeoutTimer=setTimeout((()=>{a.isReconnecting=!1,L()}),e),C(a.currentRoomId),x(a.currentRoomId)},x=e=>{a.chatChannel&&a.chatChannel.unsubscribe();const t=a.currentRoomData?.is_direct;a.chatChannel=c.channel(`room_chat_${e}`,{config:{broadcast:{self:!0}}}),a.chatChannel.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${e}`},(async e=>{const n=e.new;n&&a.currentRoomId&&(y.singleDecrypted=async e=>{if(e.result){const a={...n,...e.result},s=d("chat-messages"),r=s.querySelector(".msg:last-of-type");let i=null;r&&(i={user_id:r.dataset.uid,created_at:r.dataset.time}),s.insertAdjacentHTML("beforeend",H(a,i,t)),s.scrollTop=s.scrollHeight,O(),lucide.createIcons()}},v.postMessage({type:"decryptSingle",payload:{content:n.content}}))})).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`room_id=eq.${e}`},(async e=>{const n=e.new,a=document.querySelector(`.msg[data-id="${n.id}"]`);a&&(y.singleDecrypted=e=>{if("/"===n.content){a.classList.add("msg-deleted");const e=a.querySelector("div:not(.msg-header)");e&&(e.className="deleted-text",e.innerText="Message deleted");const t=a.querySelector(".msg-time");if(t){const e=t.querySelector(".edited-tag");e&&e.remove()}a.dataset.text="",lucide.createIcons()}else if(e.result){const s=a.previousElementSibling;let r=null;s&&s.classList.contains("msg")&&(r={user_id:s.dataset.uid,created_at:s.dataset.time}),a.outerHTML=H({...n,...e.result,updated_at:n.updated_at},r,t),lucide.createIcons()}},v.postMessage({type:"decryptSingle",payload:{content:n.content}}))})).subscribe((e=>{a.isChatChannelReady="SUBSCRIBED"===e,"SUBSCRIBED"===e?(a.connectionTimeoutTimer&&(clearTimeout(a.connectionTimeoutTimer),a.connectionTimeoutTimer=null),a.isReconnecting=!1,a.reconnectTimer&&clearTimeout(a.reconnectTimer),u("connected")):"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||(a.connectionTimeoutTimer&&(clearTimeout(a.connectionTimeoutTimer),a.connectionTimeoutTimer=null),navigator.onLine&&!a.serverFull&&(a.isChatChannelReady=!1,a.isReconnecting||(a.isReconnecting=!0,u("connecting"),a.reconnectTimer=setTimeout(L,1e3))))}))},C=async e=>{if(!a.user)return;a.presenceChannel&&a.presenceChannel.unsubscribe();const n=a.user.id;a.presenceChannel=c.channel(`room_presence:${e}`,{config:{presence:{key:n}}}),a.presenceChannel.on("presence",{event:"sync"},(()=>{a.presenceChannel&&_()})).subscribe((async(e,s)=>{if("SUBSCRIBED"===e){if(!a.presenceChannel)return;a.isPresenceSubscribed=!0,a.isReconnecting=!1,_(),await a.presenceChannel.track({user_id:n,online_at:(new Date).toISOString()}),_(),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.heartbeatInterval=setInterval((async()=>{a.presenceChannel&&!a.serverFull&&await a.presenceChannel.track({user_id:n,online_at:(new Date).toISOString()})}),t.presenceHeartbeatMs)}else"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||(a.isPresenceSubscribed=!1,!navigator.onLine||a.serverFull||a.isReconnecting||(a.isReconnecting=!0,u("connecting"),a.reconnectTimer=setTimeout(L,1e3)))}))},I=()=>{window.addEventListener("online",(()=>{d("offline-screen").classList.remove("active"),u("connecting"),L()})),window.addEventListener("offline",(()=>{d("offline-screen").classList.add("active"),u("offline"),a.connectionTimeoutTimer&&clearTimeout(a.connectionTimeoutTimer),a.reconnectTimer&&clearTimeout(a.reconnectTimer),a.isReconnecting=!1})),setInterval((()=>{navigator.onLine||d("offline-screen").classList.contains("active")||d("offline-screen").classList.add("active")}),2e3),document.addEventListener("visibilitychange",(async()=>{if("visible"===document.visibilityState&&(a.currentRoomId&&navigator.onLine&&!a.serverFull&&(a.isChatChannelReady?a.presenceChannel&&a.user&&(await a.presenceChannel.track({user_id:a.user.id,online_at:(new Date).toISOString()}),_()):L()),!a.user&&!a.isReconnecting)){if(!("true"===localStorage.getItem(s))){const{data:{user:e}}=await c.auth.getUser();e&&(a.user=e,window.nav("scr-lobby"),window.loadRooms(),T(),P())}}}))};window.retryConnection=()=>{d("capacity-overlay").classList.remove("active"),a.serverFull=!1,a.currentRoomId&&C(a.currentRoomId)},a.preventNextClose=!1;const A=(e,t)=>{if(!t||!a.user)return;if(t.classList.contains("msg-deleted"))return;e.preventDefault();const n={id:t.dataset.id,user_id:t.dataset.uid,created_at:t.dataset.time,text:t.dataset.text},s=d("context-menu"),r=d("ctx-edit"),i=d("ctx-delete"),o=d("ctx-copy"),c=n.user_id===a.user.id,l=new Date(n.created_at),u=new Date,p=c&&(u-l)/6e4<15,m=c;r.style.display=p?"flex":"none",i.style.display=m?"flex":"none",o.style.display="flex",a.contextTarget=n;let w=e.clientX||e.touches?.[0]?.clientX,g=e.clientY||e.touches?.[0]?.clientY;s.style.left=`${w}px`,s.style.top=`${g}px`,setTimeout((()=>{const e=s.getBoundingClientRect();e.right>window.innerWidth&&(s.style.left=window.innerWidth-e.width-10+"px"),e.bottom>window.innerHeight&&(s.style.top=window.innerHeight-e.height-10+"px"),s.classList.add("active"),lucide.createIcons()}),10)},S=()=>{d("context-menu").classList.remove("active"),a.contextTarget=null};d("ctx-edit").onclick=()=>{a.contextTarget&&(a.editingMessage=a.contextTarget,d("edit-msg-input").value=a.contextTarget.text,window.showOverlayView("edit-message"),d("overlay-container").classList.add("active"),S(),lucide.createIcons())},d("ctx-copy").onclick=()=>{a.contextTarget&&(navigator.clipboard.writeText(a.contextTarget.text),window.toast("Copied to clipboard"),S())},d("ctx-delete").onclick=async()=>{if(!a.contextTarget||!a.user)return;const e=a.contextTarget.id;S(),window.setLoading(!0,"Deleting...");const{error:t}=await c.from("messages").update({content:"/"}).eq("id",e);t&&window.toast("Failed: "+t.message),window.setLoading(!1)},window.saveEditMessage=async()=>{if(!a.editingMessage)return;const e=d("edit-msg-input").value.trim();if(!e)return window.toast("Message cannot be empty");const t=new Date(a.editingMessage.created_at);if((new Date-t)/6e4>=15)return window.toast("Edit time expired"),window.closeOverlay(),void(a.editingMessage=null);window.setLoading(!0,"Saving...");try{const t=await f(e),{error:n}=await c.from("messages").update({content:t}).eq("id",a.editingMessage.id);n?window.toast("Failed to edit: "+n.message):window.toast("Message updated")}catch(e){window.toast("Encryption failed")}a.editingMessage=null,window.setLoading(!1),window.closeOverlay()},document.addEventListener("click",(e=>{a.preventNextClose?a.preventNextClose=!1:S()}));const R=d("chat-messages");R.addEventListener("touchstart",(e=>{const t=e.target.closest(".msg");t&&(a.longPressTimer=setTimeout((()=>{A(e,t),a.preventNextClose=!0}),500))}),{passive:!0}),R.addEventListener("touchend",(()=>clearTimeout(a.longPressTimer))),R.addEventListener("touchmove",(()=>clearTimeout(a.longPressTimer))),R.addEventListener("contextmenu",(e=>{const t=e.target.closest(".msg");t&&(e.preventDefault(),A(e,t))}));const M=e=>{const t=d(`${e}-access-summary`);if(!t)return;const n=a.selectedAllowedUsers.length,s=0===n?"Public Room":`${n} User${n>1?"s":""}`;t.innerHTML=`<span class="c-main">${s}</span><i data-lucide="chevron-right" class="w-16 h-16"></i>`,lucide.createIcons()},D=e=>{const t=a.currentStep[e],n=d(`${e}-step-indicator`);n&&(n.querySelectorAll(".step-dot").forEach(((e,n)=>{n<t?e.classList.add("active"):e.classList.remove("active")})),"reg"===e?(d("reg-step-1").classList.toggle("active",1===t),d("reg-step-2").classList.toggle("active",2===t),d("reg-step-3").classList.toggle("active",3===t),3===t&&E()):(d(`${e}-step-1`).classList.toggle("active",1===t),d(`${e}-step-2`).classList.toggle("active",2===t)),lucide.createIcons())},E=()=>{a.selectedAvatar||(a.selectedAvatar=n[0]),U()},U=()=>{const e=d("avatar-preview-el");a.selectedAvatar&&(e.innerHTML=`<img src="${a.selectedAvatar}">`),lucide.createIcons()};window.carouselNav=e=>{let t=n.indexOf(a.selectedAvatar);-1===t&&(t=0),t+=e,t<0&&(t=n.length-1),t>=n.length&&(t=0),a.selectedAvatar=n[t],d("r-avatar-url").value="",U()},window.handleAvatarUpload=e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{const t=new Image;t.onload=()=>{const e=document.createElement("canvas");let s=t.width,r=t.height;const i=250;s>r?s>i&&(r*=i/s,s=i):r>i&&(s*=i/r,r=i),e.width=s,e.height=r;e.getContext("2d").drawImage(t,0,0,s,r);const o=e.toDataURL("image/jpeg",.85);a.selectedAvatar=o,n.push(o),d("r-avatar-url").value="",U(),window.toast("Avatar added to carousel")},t.src=e.target.result},e.readAsDataURL(t)}},window.selectCreateType=e=>{a.createType=e,document.querySelectorAll(".type-card").forEach((e=>e.classList.remove("selected"))),d(`type-${e}`).classList.add("selected")},window.nextRegStep=()=>{if(1===a.currentStep.reg){const e=d("r-email").value,t=d("r-pass").value;if(!e||t.length<8)return window.toast("Email and valid password required")}if(2===a.currentStep.reg){if(!d("r-name").value)return window.toast("Name required")}a.currentStep.reg++,D("reg")},window.prevRegStep=()=>{a.currentStep.reg--,D("reg")},window.nextCreateStep=()=>{a.currentStep.create=2,D("create"),"direct"===a.createType?(d("create-group-fields").classList.add("dn"),d("create-direct-fields").classList.remove("dn"),d("create-access-summary").classList.add("dn"),d("create-step2-title").innerText="Direct Message",d("create-step2-sub").innerText="Who are you messaging?"):(d("create-group-fields").classList.remove("dn"),d("create-direct-fields").classList.add("dn"),d("create-access-summary").classList.remove("dn"),d("create-step2-title").innerText="Setup",d("create-step2-sub").innerText="Details"),M("create")},window.prevCreateStep=()=>{a.currentStep.create=1,D("create")},window.nextEditStep=()=>{if(!d("edit-room-name").value.trim())return window.toast("Name required");a.currentStep.edit=2,D("edit"),M("edit")},window.prevEditStep=()=>{a.currentStep.edit=1,D("edit")},window.openAccessManager=async e=>{if(a.currentPickerContext=e,"edit-room"===e&&0===a.selectedAllowedUsers.length&&a.currentRoomData){const e=a.currentRoomData.allowed_users;if(e&&!e.includes("*")){const{data:t}=await c.from("profiles").select("id, full_name, avatar_url").in("id",e);a.selectedAllowedUsers=e.map((e=>{const n=t?.find((t=>t.id===e));return{id:e,name:n?.full_name||"Unknown",avatar:n?.avatar_url}}))}}k(),d("overlay-container").classList.add("active"),window.showOverlayView("access-manager"),d("picker-id-input").value="",d("picker-id-input").focus()},window.closeAccessManager=()=>{"edit-room"===a.currentPickerContext?window.showOverlayView("room-settings"):window.closeOverlay(),M(a.currentPickerContext)};const k=()=>{const e=d("picker-selected-list"),t=a.selectedAllowedUsers;if(0===t.length)return e.innerHTML='<div style="color:var(--text-mute);padding:20px 0;font-size:12px;text-align:center">No users selected.</div>',void(d("picker-count").innerText="0");d("picker-count").innerText=t.length,e.innerHTML=t.map((e=>`<div class="picker-user-card" style="display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)"><div style="width:28px;height:28px;border-radius:50%;background:#f2f2f7;overflow:hidden;margin-right:8px;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800;font-size:11px">${e.avatar?`<img src="${e.avatar}" style="width:100%;height:100%;object-fit:cover">`:e.name.charAt(0)}</div><div style="flex:1;min-width:0"><div style="font-weight:700;font-size:12px">${l(e.name)} ${e.id===a.user.id?'<span style="color:var(--text-mute);font-weight:500">(You)</span>':""}</div><div style="font-size:9px;color:var(--text-mute);font-family:monospace">${e.id}</div></div><button class="picker-remove-btn" style="background:transparent;border:none;color:var(--danger);cursor:pointer;padding:8px" onclick="window.removePickerUser('${e.id}')"><i data-lucide="x" style="width:14px;height:14px"></i></button></div>`)).join(""),lucide.createIcons()};window.removePickerUser=e=>{a.selectedAllowedUsers=a.selectedAllowedUsers.filter((t=>t.id!==e)),k()},window.addUserById=async()=>{const e=d("picker-id-input"),t=e.value.trim();if(!t)return window.toast("Enter ID");if(a.selectedAllowedUsers.find((e=>e.id===t)))return window.toast("User already added");window.setLoading(!0,"Fetching...");const{data:n,error:s}=await c.from("profiles").select("id, full_name, avatar_url").eq("id",t).single();if(window.setLoading(!1),s||!n)return window.toast("User not found");a.selectedAllowedUsers.push({id:n.id,name:n.full_name,avatar:n.avatar_url}),k(),e.value="",window.toast("Added")},window.forceClaimMaster=()=>{a.isMasterTab||(a.isMasterTab=!0,o.postMessage({type:"CLAIM_MASTER",id:a.tabId}),d("block-overlay").classList.remove("active"))},o.onmessage=e=>{if("CLAIM_MASTER"===e.data.type&&e.data.id!==a.tabId&&a.isMasterTab){b(),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.heartbeatInterval=null,a.isPresenceSubscribed=!1,a.isMasterTab=!1,u("offline");const e=d("block-overlay");e.innerHTML='<i data-lucide="log-out" style="width:48px;height:48px;margin-bottom:24px;color:var(--danger)"></i><h1 class="title">Session Moved</h1><p class="subtitle" style="margin-bottom:48px">You switched to a new tab.</p><button class="btn btn-accent" onclick="window.forceClaimMaster()">Use Here</button>',e.classList.add("active"),lucide.createIcons()}"PING_MASTER"===e.data.type&&a.isMasterTab&&o.postMessage({type:"PONG_MASTER"})},window.addEventListener("beforeunload",(()=>o.postMessage({type:"CLAIM_MASTER",id:a.tabId})));window.closeOverlay=()=>d("overlay-container").classList.remove("active"),window.showOverlayView=e=>{const t=document.querySelector(".panel-card");if(!t)return;t.querySelectorAll(".view-content").forEach((e=>e.classList.remove("active")));const n=d(`view-${e}`);n&&(n.classList.add("active"),lucide.createIcons())},window.prepareAccountPage=async()=>{if(!a.user)return;const{data:e}=await c.from("profiles").select("avatar_url, full_name").eq("id",a.user.id).single(),t=e?.full_name||a.user.user_metadata?.full_name||"User",n=e?.avatar_url||a.user.user_metadata?.avatar_url;d("acc-page-name").innerText=t,d("acc-page-type").innerText="Full Account",d("acc-page-id").innerText=a.user.id;const s=d("acc-page-avatar");n?s.innerHTML=`<img src="${n}">`:s.innerText=t.charAt(0),d("acc-email-wrapper").style.display="block",d("acc-page-email").innerText=a.user.email||"Not set",lucide.createIcons()},window.copyAccountId=()=>{a.user&&(navigator.clipboard.writeText(a.user.id),window.toast("ID Copied"))},window.copyInfoId=()=>{a.currentRoomId&&(navigator.clipboard.writeText(a.currentRoomId),window.toast("Room ID Copied"))};const P=async()=>{if(!a.user)return;const e=d("lobby-avatar-btn");if(!e)return;let t=a.user.user_metadata?.avatar_url,n=a.user.user_metadata?.full_name;if(!t||!n){const{data:e}=await c.from("profiles").select("avatar_url, full_name").eq("id",a.user.id).single();e&&(t=e.avatar_url,n=e.full_name)}t?e.innerHTML=`<img src="${t}">`:e.innerText=(n||"U").charAt(0)},$=e=>{const t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(e.getFullYear(),e.getMonth(),e.getDate()),s=Math.round((n-a)/864e5);return 0===s?"Today":1===s?"Yesterday":s<7?e.toLocaleDateString("en-GB",{weekday:"long"}):e.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})},O=()=>{const e=d("chat-messages"),t=d("chat-empty-state"),n=e.querySelector(".msg");t&&(t.style.display=n?"none":"flex")},H=(e,t,n)=>{const s=!0===e.deleted,r=e.updated_at&&!s&&new Date(e.updated_at).getTime()>new Date(e.created_at).getTime()+1e3;let i="";const o=new Date(e.created_at),c=$(o),d=!t||t.user_id!==e.user_id||$(new Date(t.created_at))!==c;d&&c!==a.lastRenderedDateLabel&&(i+=`<div class="date-divider"><span class="date-label">${c}</span></div>`,a.lastRenderedDateLabel=c);const u=((e,t=20)=>e?e.length>t?e.substring(0,t)+"...":e:"")(e.user_name||"User",18),p=d?"group-start":"msg-continuation",m=e.user_id===a.user?.id?"me":"not-me",w=s?"":l(e.text||""),g=`data-id="${e.id}" data-uid="${e.user_id}" data-time="${e.created_at}" data-text="${w}"`,v=e.time||(y=e.created_at,new Date(y).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}));var y;if(i+=`<div class="msg ${m} ${p} ${s?"msg-deleted":""}" ${g}>`,s)i+=`${d&&!n?`<div class="msg-header"><span class="msg-user">${l(u)}</span></div>`:""}<div class="deleted-text">Message deleted</div><span class="msg-time">${v}</span>`;else{const t=(e=>{let t=l(e);return t=t.replace(/(https?:\/\/[^\s]+)/g,(e=>{const t=e.replace(/[<>"']/g,"");return`<a href="${t}" target="_blank" rel="noopener noreferrer" class="chat-link">${t}</a>`})),t})(e.text);i+=`${d&&!n?`<div class="msg-header"><span class="msg-user">${l(u)}</span></div>`:""}<div>${t}</div><span class="msg-time">${v}${r?'<span class="edited-tag">(Edited)</span>':""}</span>`}return i+="</div>",i},N=()=>{const e=d("chat-messages");e&&e.scrollTop<50&&!a.isLoadingHistory&&a.hasMoreHistory&&q()},q=async()=>{if(!a.oldestMessageTimestamp||!a.currentRoomId)return;a.isLoadingHistory=!0;const e=d("chat-messages"),n=e.scrollHeight;e.insertAdjacentHTML("afterbegin",'<div id="history-loader" style="text-align:center;padding:10px;font-size:11px;color:var(--text-mute)">Loading...</div>');const{data:s,error:r}=await c.from("messages").select("*").eq("room_id",a.currentRoomId).lt("created_at",a.oldestMessageTimestamp).order("created_at",{ascending:!1}).limit(t.historyLoadLimit);if(d("history-loader")?.remove(),r||!s||0===s.length)return a.hasMoreHistory=!1,void(a.isLoadingHistory=!1);s.reverse(),y.historyDecrypted=async t=>{const s=t.results.filter((e=>!e.error));if(s.length>0){a.oldestMessageTimestamp=s[0].created_at;let t="",r=null;s.forEach((e=>{t+=H(e,r,a.currentRoomData?.is_direct),r=e})),e.insertAdjacentHTML("afterbegin",t),e.scrollTop=e.scrollHeight-n,lucide.createIcons()}a.isLoadingHistory=!1},v.postMessage({type:"decryptHistory",payload:{messages:s}})};window.openRoomInfo=async()=>{if(!a.currentRoomData)return;window.setLoading(!0,"Loading info...");const e=a.currentRoomData,t=d("info-delete-btn"),n=d("info-creator-row");t.style.display="none",t.innerText="Delete Chat",t.classList.remove("active"),a.deleteConfirmTimeout&&clearTimeout(a.deleteConfirmTimeout),d("info-id").innerText=e.id;const s=new Date(e.created_at);if(d("info-date").innerText=`${String(s.getDate()).padStart(2,"0")}/${String(s.getMonth()+1).padStart(2,"0")}/${s.getFullYear()}`,e.is_direct){d("info-type").innerText="Direct Message",n.style.display="none";const s=e.allowed_users?.find((e=>e!==a.user.id));if(s){let e=a.profileCache[s];if(!e){const{data:t}=await c.from("profiles").select("full_name, avatar_url").eq("id",s).single();e=t,t&&(a.profileCache[s]=t)}d("info-name").innerText=e?.full_name||"User";const t=d("info-avatar");e?.avatar_url?t.innerHTML=`<img src="${e.avatar_url}">`:t.innerText=(e?.full_name||"U").charAt(0)}t.style.display="flex"}else{d("info-type").innerText="Group Chat",d("info-name").innerText=e.name;const s=d("info-avatar");if(e.avatar_url?s.innerHTML=`<img src="${e.avatar_url}">`:s.innerText=e.name.charAt(0),n.style.display="flex",e.created_by){let t=a.profileCache[e.created_by];if(!t){const{data:n}=await c.from("profiles").select("full_name").eq("id",e.created_by).single();t=n,n&&(a.profileCache[e.created_by]=n)}d("info-creator").innerText=t?.full_name||"Unknown"}else d("info-creator").innerText="Unknown";e.created_by===a.user.id&&(t.style.display="flex")}p(),window.setLoading(!1),d("overlay-container").classList.add("active"),window.showOverlayView("room-info"),lucide.createIcons()},window.initiateDeleteRoom=()=>{const e=d("info-delete-btn");e.classList.contains("active")?window.deleteRoom():(e.classList.add("active"),e.innerText="Tap again to confirm",a.deleteConfirmTimeout=setTimeout((()=>{e.classList.remove("active"),e.innerText="Delete Chat"}),3e3))},window.openRoomSettings=async()=>{if(window.closeOverlay(),!a.currentRoomId||!a.currentRoomData||a.currentRoomData.created_by!==a.user.id)return window.toast("Not owner");window.setLoading(!0,"Loading...");const e=a.currentRoomData;a.currentStep.edit=1,D("edit"),d("edit-room-name").value=e.name,d("edit-room-visible").checked=e.is_visible,d("edit-room-pass").value="";const t=d("pass-status-label"),n=d("btn-remove-pass");e.has_password?(t.innerText="Active",t.style.color="var(--success)",n.style.display="block"):(t.innerText="Not Set",t.style.color="var(--text-mute)",n.style.display="none"),a.removePasswordFlag=!1,a.selectedAllowedUsers=[];const s=e.allowed_users;if(s&&!s.includes("*")){const{data:e}=await c.from("profiles").select("id, full_name, avatar_url").in("id",s);a.selectedAllowedUsers=s.map((t=>{const n=e?.find((e=>e.id===t));return{id:t,name:n?.full_name||"Unknown",avatar:n?.avatar_url}}))}d("overlay-container").classList.add("active"),window.showOverlayView("room-settings"),window.setLoading(!1)},window.prepareRemovePassword=()=>{a.removePasswordFlag=!0,d("pass-status-label").innerText="Will be removed",d("pass-status-label").style.color="var(--danger)",d("edit-room-pass").value="",d("edit-room-pass").disabled=!0},window.saveRoomSettings=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t=d("edit-room-name").value.trim(),n=d("edit-room-visible").checked,s=d("edit-room-pass").value;let r=a.selectedAllowedUsers.length>0?a.selectedAllowedUsers.map((e=>e.id)):["*"];if(r.includes(a.user.id)||r.push(a.user.id),!t)return window.toast("Name required"),void(a.processingAction=!1);a.currentRoomData;const i=s.length>0,o=a.removePasswordFlag;window.setLoading(!0,"Saving...");const l={name:t,is_visible:n,allowed_users:r};o?l.has_password=!1:i&&(l.has_password=!0);const{error:u}=await c.from("rooms").update(l).eq("id",a.currentRoomId);if(u)return window.toast("Failed: "+u.message),window.setLoading(!1),void(a.processingAction=!1);if(o)await c.rpc("set_room_password",{p_room_id:a.currentRoomId,p_hash:null}),a.currentRoomData.has_password=!1;else if(i){const e=a.currentRoomData.salt,t=await h(s+e);await c.rpc("set_room_password",{p_room_id:a.currentRoomId,p_hash:t}),a.currentRoomData.has_password=!0}const{data:p}=await c.from("rooms").select("*").eq("id",a.currentRoomId).single();a.currentRoomData=p,d("chat-title").innerText=p.name,window.toast("Saved"),window.closeOverlay(),a.processingAction=!1,window.setLoading(!1)},window.deleteRoom=async()=>{if(!a.currentRoomId)return;window.setLoading(!0,"Deleting...");const{error:e}=await c.from("rooms").delete().eq("id",a.currentRoomId);if(e)return window.toast("Failed: "+e.message),void window.setLoading(!1);window.toast("Deleted"),a.currentRoomId=null,a.currentRoomData=null,window.closeOverlay(),window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.openVault=async(e,n,s,r)=>{if(!a.user)return window.toast("Please login first");window.setLoading(!0,"Decrypting..."),a.currentRoomPassword=s,a.chatChannel&&a.chatChannel.unsubscribe(),a.currentRoomId=e,a.lastRenderedDateLabel=null,a.oldestMessageTimestamp=null,a.hasMoreHistory=!0,a.isLoadingHistory=!1,d("chat-messages").innerHTML="",d("chat-messages").onscroll=N;const i=s?s+e:e;try{await(o=i,l=r,new Promise(((e,t)=>{y.keyDerived=n=>{n.success?e(!0):t("Key derivation failed")},v.postMessage({type:"deriveKey",payload:{password:o,salt:l}})})))}catch(e){return window.setLoading(!1),window.toast("Key derivation failed")}var o,l;const{data:p}=await c.from("rooms").select("*").eq("id",e).single();a.currentRoomData=p;const m=p.is_direct;let w=n,g=p.avatar_url;if(m){const e=p.allowed_users?.find((e=>e!==a.user.id));if(e){let t=a.profileCache[e];if(!t){const{data:n}=await c.from("profiles").select("full_name, avatar_url").eq("id",e).single();t=n,n&&(a.profileCache[e]=n)}t&&(w=t.full_name,g=t.avatar_url)}}d("chat-title").innerText=w;const h=d("chat-avatar-display");g?h.innerHTML=`<img src="${g}">`:h.innerText=w.charAt(0).toUpperCase();const f=d("info-edit-btn");m||p.created_by!==a.user.id?f.style.display="none":f.style.display="flex",lucide.createIcons(),window.setLoading(!0,"Fetching History...");const{data:b}=await c.from("messages").select("*").eq("room_id",e).order("created_at",{ascending:!1}).limit(t.maxMessages);d("chat-input").style.display="block",d("send-btn").style.display="flex",window.nav("scr-chat"),u("connecting"),b&&b.length>0?(b.reverse(),b.length>0&&(a.oldestMessageTimestamp=b[0].created_at),window.setLoading(!0,"Decrypting..."),y.historyDecrypted=async e=>{const t=d("chat-messages");t.innerHTML="";let n=null;e.results.forEach((e=>{e.error||(t.insertAdjacentHTML("beforeend",H(e,n,m)),n=e)})),t.scrollTop=t.scrollHeight,O(),lucide.createIcons(),window.setLoading(!1)},v.postMessage({type:"decryptHistory",payload:{messages:b}})):(a.hasMoreHistory=!1,O(),window.setLoading(!1)),x(e),C(e)};window.sendMsg=async e=>{if(!e||!e.isTrusted)return;if(!a.user||!a.currentRoomId||a.processingAction||!a.isChatChannelReady)return;if(Date.now()-a.lastMessageTime<t.rateLimitMs)return;a.processingAction=!0;const n=d("chat-input").value.trim();if(n){d("chat-input").value="",a.lastMessageTime=Date.now();try{const e=await f(n);await c.from("messages").insert([{room_id:a.currentRoomId,user_id:a.user.id,user_name:a.user.user_metadata?.full_name,content:e}])}catch(e){window.toast("Failed to send")}a.processingAction=!1}else a.processingAction=!1},window.leaveChat=async()=>{window.setLoading(!0,"Leaving..."),a.chatChannel&&a.chatChannel.unsubscribe(),a.chatChannel=null,a.currentRoomId=null,a.currentRoomData=null,a.presenceChannel&&a.presenceChannel.unsubscribe(),a.presenceChannel=null,a.isPresenceSubscribed=!1,a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.heartbeatInterval=null,u("offline"),d("info-edit-btn")&&(d("info-edit-btn").style.display="none"),window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.handleLogin=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t=d("l-email").value,n=d("l-pass").value;if(!t||!n)return window.toast("Input missing"),void(a.processingAction=!1);window.setLoading(!0,"Signing In..."),localStorage.removeItem(s);const{error:r}=await c.auth.signInWithPassword({email:t,password:n});r?(window.toast(r.message),window.setLoading(!1),a.processingAction=!1):a.processingAction=!1},window.handleRegister=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const n=d("r-name").value,s=d("r-email").value.trim().toLowerCase(),r=d("r-pass").value,i=d("r-avatar-url").value.trim()||a.selectedAvatar;if(!n||!s||r.length<8)return window.toast("Check inputs"),void(a.processingAction=!1);window.setLoading(!0,"Sending Code...");try{const[e,o]=await w(fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send",email:s})}));if(!e)throw new Error("Network error");{if(429===e.status)return window.toast("Rate limited"),a.processingAction=!1,void window.setLoading(!1);const t=await e.json();"Code sent"===t.message?(sessionStorage.setItem("temp_reg",JSON.stringify({n:n,em:s,p:r,avatar:i})),window.nav("scr-verify"),F(),window.setLoading(!1)):(window.toast(t.message||"Error"),window.setLoading(!1))}}catch(e){window.toast("API Fallback: Proceeding without code (Dev Mode)"),sessionStorage.setItem("temp_reg",JSON.stringify({n:n,em:s,p:r,avatar:i})),window.nav("scr-verify"),F(),window.setLoading(!1)}a.processingAction=!1};const F=()=>{let e=t.verificationCodeExpiry;a.vTimer&&clearInterval(a.vTimer),a.vTimer=setInterval((()=>{e--,d("v-timer").innerText=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`,e<=0&&(clearInterval(a.vTimer),window.nav("scr-register"))}),1e3)};window.handleVerify=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const n=d("v-code").value,s=JSON.parse(sessionStorage.getItem("temp_reg"));if(!s)return window.toast("Session expired"),void(a.processingAction=!1);window.setLoading(!0,"Verifying...");try{const e=await fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"verify",email:s.em,code:n})});if(429===e.status)return window.toast("Rate limited"),a.processingAction=!1,void window.setLoading(!1);const r=await e.json();"Verified"===r.message?await j(s):(window.toast(r.message||"Wrong code"),window.setLoading(!1))}catch(e){window.toast("API Fallback: Auto-verifying (Dev Mode)"),await j(s)}a.processingAction=!1};const j=async e=>{localStorage.removeItem(s);const{error:t}=await c.auth.signUp({email:e.em,password:e.p,options:{data:{full_name:e.n,avatar_url:e.avatar}}});t&&(window.toast(t.message),window.setLoading(!1))};window.handleCreate=async e=>{if(!e||!e.isTrusted)return;if(a.processingAction)return;a.processingAction=!0;const t="direct"===a.createType;let n,s=!0,r=null,i=null,o=null;if(t){if(r=d("c-target-user").value.trim(),!r)return window.toast("User ID required"),void(a.processingAction=!1);const{data:e,error:t}=await c.from("profiles").select("full_name").eq("id",r).single();if(t||!e)return window.toast("User not found"),void(a.processingAction=!1);n="Direct Message",s=!0}else if(n=d("c-name").value.trim(),i=d("c-avatar").value.trim()||null,o=d("c-pass").value,s=d("c-visible").checked,!n)return window.toast("Name required"),void(a.processingAction=!1);let l=["*"];t?l=[a.user.id,r]:a.selectedAllowedUsers.length>0&&(l=a.selectedAllowedUsers.map((e=>e.id)),l.includes(a.user.id)||l.push(a.user.id)),window.setLoading(!0,"Creating...");const u=(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("")})(),p={name:n,avatar_url:i,has_password:!!o,is_visible:s,salt:u,created_by:a.user.id,allowed_users:l,is_direct:t},{data:m,error:w}=await c.from("rooms").insert([p]).select();if(w)return window.toast("Error: "+w.message),a.processingAction=!1,void window.setLoading(!1);if(m&&m.length>0){const e=m[0];if(o){const t=await h(o+u);await c.rpc("set_room_password",{p_room_id:e.id,p_hash:t})}a.lastCreated=e,a.lastCreatedPass=o,d("s-id").innerText=e.id,window.nav("scr-success"),a.selectedAllowedUsers=[]}a.processingAction=!1,window.setLoading(!1)},window.submitGate=async e=>{if(!e||!e.isTrusted)return;const t=d("gate-pass").value,n=await h(t+a.pending.salt);window.setLoading(!0,"Verifying...");const{data:s}=await c.rpc("verify_room_password",{p_room_id:a.pending.id,p_hash:n});window.setLoading(!1),!0===s?window.openVault(a.pending.id,a.pending.name,t,a.pending.salt):window.toast("Access Denied")},window.handleLogout=async e=>{e&&e.isTrusted&&(window.setLoading(!0,"Leaving..."),a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.presenceChannel&&a.presenceChannel.unsubscribe(),a.chatChannel&&a.chatChannel.unsubscribe(),a.globalPresenceChannel&&a.globalPresenceChannel.unsubscribe(),localStorage.setItem(s,"true"),a.user=null,await c.auth.signOut(),window.nav("scr-start"),window.setLoading(!1))},window.copySId=()=>{navigator.clipboard.writeText(a.lastCreated.id),window.toast("ID Copied")},window.enterCreated=()=>{window.openVault(a.lastCreated.id,a.lastCreated.name,a.lastCreatedPass,a.lastCreated.salt),a.lastCreatedPass=null},c.auth.onAuthStateChange((async(e,t)=>{if("true"===localStorage.getItem(s))return void(a.user=null);a.user=t?.user;const n=d("icon-plus-lobby"),r=document.querySelector(".screen.active")?.id;if(n&&(n.style.display="flex"),"SIGNED_IN"===e&&a.user){["scr-start","scr-login","scr-register","scr-verify"].includes(r)&&(window.nav("scr-lobby"),window.loadRooms(),window.forceClaimMaster()),P(),T()}"SIGNED_OUT"===e&&(a.heartbeatInterval&&clearInterval(a.heartbeatInterval),a.presenceChannel&&a.presenceChannel.unsubscribe(),a.chatChannel&&a.chatChannel.unsubscribe(),a.globalPresenceChannel&&a.globalPresenceChannel.unsubscribe(),localStorage.removeItem(s),window.nav("scr-start"))})),window.nav=(e,t=null)=>{const n=document.querySelector(".screen.active"),s=d(e);if(!s)return;"scr-create"===e&&(a.currentStep.create=1,a.selectedAllowedUsers=[],a.createType="group",D("create"),d("c-name").value="",d("c-target-user").value="",d("c-pass").value="",d("c-avatar").value="",document.querySelectorAll(".type-card").forEach((e=>e.classList.remove("selected"))),d("type-group").classList.add("selected")),"scr-register"===e&&(a.currentStep.reg=1,a.selectedAvatar=null,d("r-name").value="",d("r-email").value="",d("r-pass").value="",d("r-avatar-url").value="",D("reg")),"scr-account"===e&&window.prepareAccountPage(),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("slide-left","slide-right"))),"left"===t?(n.classList.add("slide-left"),s.classList.remove("slide-right")):"right"===t?(n.classList.add("slide-right"),s.classList.remove("slide-left")):document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),s.classList.add("active"),lucide.createIcons();const r=d("icon-plus-lobby");r&&(r.style.display="flex"),"scr-lobby"===e&&P()},window.refreshLobby=async()=>{const e=Date.now();if(e-a.lastLobbyRefresh<1e4)return window.toast(`Wait ${Math.ceil((1e4-(e-a.lastLobbyRefresh))/1e3)}s`);a.lastLobbyRefresh=e,await window.loadRooms()},window.loadRooms=async()=>{if(!a.user)return;window.setLoading(!0,"Fetching...");const{data:e,error:t}=await c.from("rooms").select("*").order("created_at",{ascending:!1});if(t)return window.toast("Failed to load rooms"),void window.setLoading(!1);const n=a.user.id,s=[];for(const t of e)if(t.is_direct&&t.allowed_users){const e=t.allowed_users.find((e=>e!==n));if(e)if(a.profileCache[e])s.push({...t,display_name:a.profileCache[e].full_name,display_avatar:a.profileCache[e].avatar_url});else{const{data:n}=await c.from("profiles").select("full_name, avatar_url").eq("id",e).single();n?(a.profileCache[e]=n,s.push({...t,display_name:n.full_name,display_avatar:n.avatar_url})):s.push({...t,display_name:"User",display_avatar:null})}else s.push({...t,display_name:"User",display_avatar:null})}else s.push({...t,display_name:t.name,display_avatar:t.avatar_url});a.allRooms=s,window.filterRooms(),window.setLoading(!1),P()},window.filterRooms=()=>{const e=d("search-bar").value.toLowerCase(),t=d("room-list"),n=(a.user,a.allRooms.filter((t=>{if(!t.is_direct&&!t.is_visible)return!1;return!!(t.display_name||t.name||"").toLowerCase().includes(e)})));0===n.length?t.innerHTML='<div style="text-align:center;padding:40px 20px;color:var(--text-mute)"><i data-lucide="folder" style="width:40px;height:40px;margin-bottom:12px;color:#d1d1d6"></i><div style="font-size:14px;font-weight:700;color:var(--text-main)">No groups yet</div></div>':t.innerHTML=n.map((e=>`<div class="room-card" onclick="window.joinAttempt('${e.id}')"><div class="chat-avatar" style="width:36px;height:36px;margin-right:10px;font-size:13px">${e.display_avatar?`<img src="${e.display_avatar}">`:(e.display_name||"G").charAt(0)}</div><span class="room-name">${l(e.display_name)}</span><span class="room-icon">${e.is_direct?'<i data-lucide="user" style="width:14px;height:14px"></i>':""}${e.has_password?'<i data-lucide="lock" style="width:14px;height:14px"></i>':""}</span></div>`)).join(""),lucide.createIcons()},window.joinAttempt=async e=>{window.setLoading(!0,"Checking...");const{data:t}=await c.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),window.toast("Access denied");const{data:n,error:s}=await c.from("rooms").select("*").eq("id",e).single();if(window.setLoading(!1),s||!n)return window.toast("Not found");a.pending={id:n.id,name:n.name,salt:n.salt},a.currentRoomData=n,n.has_password?window.nav("scr-gate"):window.openVault(n.id,n.name,null,n.salt)},window.joinPrivate=async()=>{if(!a.user)return window.toast("Login required");const e=d("join-id").value.trim();if(!e)return;window.setLoading(!0,"Checking...");const{data:t}=await c.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),window.toast("Access denied or not found");const{data:n}=await c.from("rooms").select("*").eq("id",e).single();window.setLoading(!1),n?(a.pending={id:n.id,name:n.name,salt:n.salt},a.currentRoomData=n,n.has_password?window.nav("scr-gate"):window.openVault(n.id,n.name,null,n.salt)):window.toast("Not found")};(async()=>{if(!navigator.onLine)return void d("offline-screen").classList.add("active");if("true"===localStorage.getItem(s))return a.user=null,window.nav("scr-start"),window.setLoading(!1),void I();const[e,t]=await w(c.auth.getUser());if(t)return await c.auth.signOut(),window.nav("scr-start"),window.setLoading(!1),void I();const n=e?.data?.user;if(n){a.user=n;if(await new Promise((e=>{let t=!1;const n=e=>{"PONG_MASTER"===e.data.type&&(t=!0)};o.addEventListener("message",n),o.postMessage({type:"PING_MASTER"}),setTimeout((()=>{o.removeEventListener("message",n),e(t)}),300)}))){d("block-overlay").classList.add("active"),lucide.createIcons(),window.nav("scr-lobby"),window.loadRooms()}else window.forceClaimMaster(),window.nav("scr-lobby"),window.loadRooms()}lucide.createIcons(),window.setLoading(!1),I()})()}
