// GH: HyperRushNet | 2026 | MIT License | logic.min.js
import{createClient}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";export function startChatApp(e={}){const t={supabaseUrl:e.supabaseUrl||"https://jnhsuniduzvhkpexorqk.supabase.co",supabaseKey:e.supabaseKey||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuaHN1bmlkdXp2aGtwZXhvcnFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NjAxMDYsImV4cCI6MjA4NzEzNjEwNn0.9I5bbqskCgksUaNWYlFFo0-6Odht28pOMdxTGZECahY",mailApi:e.mailApi||"https://vercel-serverless-gray-sigma.vercel.app/api/mailAPI",maxUsers:e.maxUsers,maxMessages:e.maxMessages||15,historyLoadLimit:e.historyLoadLimit||10,rateLimitMs:e.rateLimitMs||1e3,presenceHeartbeatMs:e.presenceHeartbeatMs||1e4,reconnectDebounceMs:e.reconnectDebounceMs||3e3,verificationCodeExpiry:e.verificationCodeExpiry||600},a=["https://cdn-icons-png.flaticon.com/512/6997/6997676.png","https://cdn-icons-png.flaticon.com/512/236/236831.png","https://cdn-icons-png.freepik.com/256/6997/6997667.png?semt=ais_white_label","https://cdn-icons-png.flaticon.com/512/6997/6997668.png","https://img.freepik.com/free-photo/sunset-time-tropical-beach-sea-with-coconut-palm-tree_74190-1075.jpg?semt=ais_user_personalization&w=740&q=80","https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTECqduTKufgQgmfy7ZUMpWOrFXNyHpNWQvPA&s"];lucide.createIcons();const n={user:null,currentRoomId:null,chatChannel:null,presenceChannel:null,allRooms:[],vTimer:null,lastRenderedDateLabel:null,lastKnownOnlineCount:null,heartbeatInterval:null,uptimeInterval:null,sessionStartTime:null,isPresenceSubscribed:!1,lastReconnectAttempt:0,pending:null,lastCreated:null,lastCreatedPass:null,isMasterTab:!1,tabId:sessionStorage.getItem("hrn_tab_id")||(sessionStorage.setItem("hrn_tab_id",crypto.randomUUID()),sessionStorage.getItem("hrn_tab_id")),processingAction:!1,serverFull:!1,isLoadingHistory:!1,oldestMessageTimestamp:null,hasMoreHistory:!0,lastMessageTime:0,isConnecting:!1,isChatChannelReady:!1,currentRoomAccessType:null,currentRoomData:null,selectedAllowedUsers:[],currentPickerContext:null,lastLobbyRefresh:0,removePasswordFlag:!1,longPressTimer:null,currentStep:{create:1,edit:1,reg:1},selectedAvatar:null,createType:"group",currentRoomPassword:null,reconnectTimer:null,isReconnecting:!1,deleteConfirmTimeout:null,profileCache:{}},s="hrn_flag_force_logout";let r=[],i=!1;const o=new BroadcastChannel("hrn_tab_sync"),c=createClient(t.supabaseUrl,t.supabaseKey,{auth:{persistSession:!0,autoRefreshToken:!0},realtime:{params:{eventsPerSecond:10}}}),l=e=>{const t=document.createElement("p");return t.textContent=e,t.innerHTML},d=e=>document.getElementById(e),u=e=>{const t=d("chat-avatar-display");t&&(t.classList.remove("status-connected","status-connecting","status-offline"),"connected"===e?t.classList.add("status-connected"):"connecting"===e?t.classList.add("status-connecting"):t.classList.add("status-offline"))},p=()=>{if(i||0===r.length)return;i=!0;const e=r.shift(),t=d("toast-container"),a=document.createElement("div");a.className="toast-item",a.innerText=e,a.onclick=()=>{a.style.opacity="0",setTimeout((()=>{a.remove(),i=!1,p()}),400)},t.appendChild(a),setTimeout((()=>{a.parentNode&&(a.style.opacity="0",setTimeout((()=>{a.parentNode&&a.remove(),i=!1,p()}),400))}),3e3)};window.toast=e=>{r.push(e),p()},window.setLoading=(e,t=null)=>{const a=d("loader-overlay"),n=d("loader-text");e?a.classList.add("active"):a.classList.remove("active"),n.innerText=t||"Loading..."};const m=async e=>{try{return[await e,null]}catch(e){return[null,e]}},w=new Blob(["self.onmessage = async (e) => {\n        const { type, payload } = e.data;\n        const encoder = new TextEncoder();\n        const decoder = new TextDecoder();\n        try {\n            if (type === 'deriveKey') {\n                const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(payload.password), { name: 'PBKDF2' }, false, ['deriveKey']);\n                const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: encoder.encode(payload.salt), iterations: 300000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);\n                self.cryptoKey = key;\n                self.postMessage({ type: 'keyDerived', success: true });\n            } else if (type === 'encrypt') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\");\n                const iv = crypto.getRandomValues(new Uint8Array(12));\n                const encoded = encoder.encode(payload.text);\n                const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, self.cryptoKey, encoded);\n                const combined = new Uint8Array(iv.length + ciphertext.byteLength);\n                combined.set(iv, 0);\n                combined.set(new Uint8Array(ciphertext), iv.length);\n                const base64 = btoa(String.fromCharCode(...combined));\n                self.postMessage({ type: 'encrypted', result: base64 });\n            } else if (type === 'decryptHistory') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\");\n                const results = [];\n                for (const m of payload.messages) {\n                    try {\n                        const binary = atob(m.content);\n                        const bytes = new Uint8Array(binary.length);\n                        for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n                        const iv = bytes.slice(0, 12);\n                        const ciphertext = bytes.slice(12);\n                        const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n                        const text = decoder.decode(decrypted);\n                        const parts = text.split('|');\n                        results.push({ id: m.id, time: parts[0], text: parts.slice(1).join('|'), user_id: m.user_id, user_name: m.user_name, created_at: m.created_at });\n                    } catch (err) { results.push({ id: m.id, error: true }); }\n                }\n                self.postMessage({ type: 'historyDecrypted', results });\n            } else if (type === 'decryptSingle') {\n                if (!self.cryptoKey) throw new Error(\"Key not derived\");\n                try {\n                    const binary = atob(payload.content);\n                    const bytes = new Uint8Array(binary.length);\n                    for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n                    const iv = bytes.slice(0, 12);\n                    const ciphertext = bytes.slice(12);\n                    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n                    const text = decoder.decode(decrypted);\n                    const parts = text.split('|');\n                    self.postMessage({ type: 'singleDecrypted', result: { time: parts[0], text: parts.slice(1).join('|') } });\n                } catch(e) { self.postMessage({ type: 'singleDecrypted', error: e.message }); }\n            }\n        } catch (error) { self.postMessage({ type: 'error', message: error.message }); }\n    };"],{type:"application/javascript"}),g=new Worker(URL.createObjectURL(w)),v={};g.onmessage=e=>{const{type:t}=e.data;v[t]&&(v[t](e.data),delete v[t])};const y=async e=>{const t=(new TextEncoder).encode(e),a=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")},f=async()=>{n.reconnectTimer&&(clearTimeout(n.reconnectTimer),n.reconnectTimer=null),n.heartbeatInterval&&(clearInterval(n.heartbeatInterval),n.heartbeatInterval=null),n.presenceChannel&&(n.presenceChannel.unsubscribe(),n.presenceChannel=null,n.isPresenceSubscribed=!1),n.chatChannel&&(n.chatChannel.unsubscribe(),n.chatChannel=null),u("offline")},h=async()=>{if(!n.presenceChannel)return;const e=n.presenceChannel.presenceState(),a=Object.values(e).flat();new Set(a.map((e=>e.user_id))).size>t.maxUsers?n.serverFull||(n.serverFull=!0,d("capacity-overlay").classList.add("active"),f()):(n.serverFull=!1,d("capacity-overlay").classList.remove("active"))},b=()=>{navigator.onLine&&n.currentRoomId&&n.user&&(n.isReconnecting||(u("connecting"),L(n.currentRoomId),_(n.currentRoomId)))},_=e=>{n.chatChannel&&n.chatChannel.unsubscribe();const t=n.currentRoomData?.is_direct;n.chatChannel=c.channel(`room_chat_${e}`,{config:{broadcast:{self:!0}}}),n.chatChannel.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${e}`},(async e=>{const a=e.new;a&&n.currentRoomId&&(v.singleDecrypted=async e=>{if(e.result){const s={...a,time:e.result.time,text:e.result.text},r=d("chat-messages"),i=r.querySelector(".msg:last-of-type");let o=null;i&&(o={user_id:i.classList.contains("me")?n.user.id:"other",created_at:i.dataset.time}),r.insertAdjacentHTML("beforeend",D(s,o,t)),r.scrollTop=r.scrollHeight,M()}},g.postMessage({type:"decryptSingle",payload:{content:a.content}}))})).subscribe((e=>{n.isChatChannelReady="SUBSCRIBED"===e,"SUBSCRIBED"===e?(n.isReconnecting=!1,n.reconnectTimer&&clearTimeout(n.reconnectTimer),u("connected")):"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||navigator.onLine&&!n.serverFull&&(n.isChatChannelReady=!1,n.isReconnecting||(n.isReconnecting=!0,u("connecting"),n.reconnectTimer=setTimeout(b,1e3)))}))},L=async e=>{if(!n.user)return;n.presenceChannel&&n.presenceChannel.unsubscribe();const a=n.user.id;n.presenceChannel=c.channel(`room_presence:${e}`,{config:{presence:{key:a}}}),n.presenceChannel.on("presence",{event:"sync"},(()=>{n.presenceChannel&&h()})).subscribe((async(e,s)=>{if("SUBSCRIBED"===e){if(!n.presenceChannel)return;n.isPresenceSubscribed=!0,n.isReconnecting=!1,h(),await n.presenceChannel.track({user_id:a,online_at:(new Date).toISOString()}),h(),n.heartbeatInterval&&clearInterval(n.heartbeatInterval),n.heartbeatInterval=setInterval((async()=>{n.presenceChannel&&!n.serverFull&&await n.presenceChannel.track({user_id:a,online_at:(new Date).toISOString()})}),t.presenceHeartbeatMs)}else"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||(n.isPresenceSubscribed=!1,!navigator.onLine||n.serverFull||n.isReconnecting||(n.isReconnecting=!0,u("connecting"),n.reconnectTimer=setTimeout(b,1e3)))}))},T=()=>{window.addEventListener("online",(()=>{d("offline-screen").classList.remove("active"),u("connecting"),b()})),window.addEventListener("offline",(()=>{d("offline-screen").classList.add("active"),u("offline"),n.reconnectTimer&&clearTimeout(n.reconnectTimer),n.isReconnecting=!1})),setInterval((()=>{navigator.onLine||d("offline-screen").classList.contains("active")||d("offline-screen").classList.add("active")}),2e3),document.addEventListener("visibilitychange",(async()=>{"visible"===document.visibilityState&&n.currentRoomId&&navigator.onLine&&!n.serverFull&&(n.isChatChannelReady&&n.isPresenceSubscribed?n.presenceChannel&&n.user&&(await n.presenceChannel.track({user_id:n.user.id,online_at:(new Date).toISOString()}),h()):(console.log("Tab actief: Verbinding verbroken, opnieuw verbinden..."),b()))}))};window.retryConnection=()=>{d("capacity-overlay").classList.remove("active"),n.serverFull=!1,n.currentRoomId&&L(n.currentRoomId)};const x=e=>{const t=d(`${e}-access-summary`);if(!t)return;const a=n.selectedAllowedUsers.length,s=0===a?"Public Room":`${a} User${a>1?"s":""}`;t.innerHTML=`<span class="c-main">${s}</span><i data-lucide="chevron-right" class="w-16 h-16"></i>`,lucide.createIcons()},C=e=>{const t=n.currentStep[e],a=d(`${e}-step-indicator`);a&&(a.querySelectorAll(".step-dot").forEach(((e,a)=>{a<t?e.classList.add("active"):e.classList.remove("active")})),d(`${e}-step-1`).classList.toggle("active",1===t),d(`${e}-step-2`).classList.toggle("active",2===t),"reg"===e&&(d("reg-step-1").classList.toggle("active",1===t),d("reg-step-2").classList.toggle("active",2===t),2===t&&I()),lucide.createIcons())},I=()=>{const e=d("avatar-grid");!e||e.children.length>0||(e.innerHTML=a.map(((e,t)=>`<div class="avatar-option ${n.selectedAvatar===e?"selected":""}" onclick="window.selectAvatar('${e}', this)"><img src="${e}" alt="Avatar"></div>`)).join(""))};window.selectAvatar=(e,t)=>{n.selectedAvatar=e,d("r-avatar-url").value="",document.querySelectorAll(".avatar-option").forEach((e=>e.classList.remove("selected"))),t.classList.add("selected")},window.selectCreateType=e=>{n.createType=e,document.querySelectorAll(".type-card").forEach((e=>e.classList.remove("selected"))),d(`type-${e}`).classList.add("selected")},window.nextRegStep=()=>{const e=d("r-name").value,t=d("r-email").value,a=d("r-pass").value;if(!e||!t||a.length<8)return window.toast("Complete fields (min 8 chars password)");n.currentStep.reg=2,C("reg")},window.prevRegStep=()=>{n.currentStep.reg=1,C("reg")},window.nextCreateStep=()=>{n.currentStep.create=2,C("create"),"direct"===n.createType?(d("create-group-fields").classList.add("dn"),d("create-direct-fields").classList.remove("dn"),d("create-access-summary").classList.add("dn"),d("create-step2-title").innerText="Direct Message",d("create-step2-sub").innerText="Who are you messaging?"):(d("create-group-fields").classList.remove("dn"),d("create-direct-fields").classList.add("dn"),d("create-access-summary").classList.remove("dn"),d("create-step2-title").innerText="Setup",d("create-step2-sub").innerText="Details"),x("create")},window.prevCreateStep=()=>{n.currentStep.create=1,C("create")},window.nextEditStep=()=>{if(!d("edit-room-name").value.trim())return window.toast("Name required");n.currentStep.edit=2,C("edit"),x("edit")},window.prevEditStep=()=>{n.currentStep.edit=1,C("edit")},window.openAccessManager=async e=>{if(n.currentPickerContext=e,"edit-room"===e&&0===n.selectedAllowedUsers.length&&n.currentRoomData){const e=n.currentRoomData.allowed_users;if(e&&!e.includes("*")){const{data:t}=await c.from("profiles").select("id, full_name, avatar_url").in("id",e);n.selectedAllowedUsers=e.map((e=>{const a=t?.find((t=>t.id===e));return{id:e,name:a?.full_name||"Unknown",avatar:a?.avatar_url}}))}}A(),d("overlay-container").classList.add("active"),window.showOverlayView("access-manager"),d("picker-id-input").value="",d("picker-id-input").focus()},window.closeAccessManager=()=>{"edit-room"===n.currentPickerContext?window.showOverlayView("room-settings"):window.closeOverlay(),x(n.currentPickerContext)};const A=()=>{const e=d("picker-selected-list"),t=n.selectedAllowedUsers;if(0===t.length)return e.innerHTML='<div style="color:var(--text-mute);padding:20px 0;font-size:12px;text-align:center">No users selected.</div>',void(d("picker-count").innerText="0");d("picker-count").innerText=t.length,e.innerHTML=t.map((e=>`\n        <div class="picker-user-card" style="display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">\n        <div style="width:28px;height:28px;border-radius:50%;background:#f2f2f7;overflow:hidden;margin-right:8px;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800;font-size:11px">${e.avatar?`<img src="${e.avatar}" style="width:100%;height:100%;object-fit:cover">`:e.name.charAt(0)}</div>\n        <div style="flex:1;min-width:0"><div style="font-weight:700;font-size:12px">${l(e.name)} ${e.id===n.user.id?'<span style="color:var(--text-mute);font-weight:500">(You)</span>':""}</div><div style="font-size:9px;color:var(--text-mute);font-family:monospace">${e.id}</div></div>\n        <button class="picker-remove-btn" style="background:transparent;border:none;color:var(--danger);cursor:pointer;padding:8px" onclick="window.removePickerUser('${e.id}')"><i data-lucide="x" style="width:14px;height:14px"></i></button>\n        </div>`)).join(""),lucide.createIcons()};window.removePickerUser=e=>{n.selectedAllowedUsers=n.selectedAllowedUsers.filter((t=>t.id!==e)),A()},window.addUserById=async()=>{const e=d("picker-id-input"),t=e.value.trim();if(!t)return window.toast("Enter ID");if(n.selectedAllowedUsers.find((e=>e.id===t)))return window.toast("User already added");window.setLoading(!0,"Fetching...");const{data:a,error:s}=await c.from("profiles").select("id, full_name, avatar_url").eq("id",t).single();if(window.setLoading(!1),s||!a)return window.toast("User not found");n.selectedAllowedUsers.push({id:a.id,name:a.full_name,avatar:a.avatar_url}),A(),e.value="",window.toast("Added")},window.forceClaimMaster=()=>{n.isMasterTab||(n.isMasterTab=!0,o.postMessage({type:"CLAIM_MASTER",id:n.tabId}),d("block-overlay").classList.remove("active"))},o.onmessage=e=>{if("CLAIM_MASTER"===e.data.type&&e.data.id!==n.tabId&&n.isMasterTab){f(),n.heartbeatInterval&&clearInterval(n.heartbeatInterval),n.heartbeatInterval=null,n.isPresenceSubscribed=!1,n.isMasterTab=!1,u("offline");const e=d("block-overlay");e.innerHTML='<i data-lucide="log-out" style="width:48px;height:48px;margin-bottom:24px;color:var(--danger)"></i><h1 class="title">Session Moved</h1><p class="subtitle" style="margin-bottom:48px">You switched to a new tab.</p><button class="btn btn-accent" onclick="window.forceClaimMaster()">Use Here</button>',e.classList.add("active"),lucide.createIcons()}"PING_MASTER"===e.data.type&&n.isMasterTab&&o.postMessage({type:"PONG_MASTER"})},window.addEventListener("beforeunload",(()=>o.postMessage({type:"CLAIM_MASTER",id:n.tabId})));window.closeOverlay=()=>d("overlay-container").classList.remove("active"),window.showOverlayView=e=>{const t=document.querySelector(".panel-card");if(!t)return;t.querySelectorAll(".view-content").forEach((e=>e.classList.remove("active")));const a=d(`view-${e}`);a&&(a.classList.add("active"),lucide.createIcons())},window.prepareAccountPage=async()=>{if(!n.user)return;const{data:e}=await c.from("profiles").select("avatar_url, full_name").eq("id",n.user.id).single(),t=e?.full_name||n.user.user_metadata?.full_name||"User",a=e?.avatar_url||n.user.user_metadata?.avatar_url;d("acc-page-name").innerText=t,d("acc-page-type").innerText="Full Account",d("acc-page-id").innerText=n.user.id;const s=d("acc-page-avatar");a?s.innerHTML=`<img src="${a}">`:s.innerText=t.charAt(0),d("acc-email-wrapper").style.display="block",d("acc-page-email").innerText=n.user.email||"Not set",lucide.createIcons()},window.copyAccountId=()=>{n.user&&(navigator.clipboard.writeText(n.user.id),window.toast("ID Copied"))},window.copyInfoId=()=>{n.currentRoomId&&(navigator.clipboard.writeText(n.currentRoomId),window.toast("Room ID Copied"))};const S=async()=>{if(!n.user)return;const e=d("lobby-avatar-btn");if(!e)return;let t=n.user.user_metadata?.avatar_url,a=n.user.user_metadata?.full_name;if(!t||!a){const{data:e}=await c.from("profiles").select("avatar_url, full_name").eq("id",n.user.id).single();e&&(t=e.avatar_url,a=e.full_name)}t?e.innerHTML=`<img src="${t}">`:e.innerText=(a||"U").charAt(0)},R=e=>{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()),s=Math.round((a-n)/864e5);return 0===s?"Today":1===s?"Yesterday":s<7?e.toLocaleDateString("en-GB",{weekday:"long"}):e.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})},M=()=>{const e=d("chat-messages"),t=d("chat-empty-state"),a=e.querySelector(".msg");t&&(t.style.display=a?"none":"flex")},D=(e,t,a)=>{let s="";const r=new Date(e.created_at),i=R(r),o=!t||t.user_id!==e.user_id||R(new Date(t.created_at))!==i;o&&i!==n.lastRenderedDateLabel&&(s+=`<div class="date-divider"><span class="date-label">${i}</span></div>`,n.lastRenderedDateLabel=i);const c=((e,t=20)=>e?e.length>t?e.substring(0,t)+"...":e:"")(e.user_name||"User",18),d=(e=>{let t=l(e);return t=t.replace(/(https?:\/\/[^\s]+)/g,(e=>{const t=e.replace(/[<>"']/g,"");return`<a href="${t}" target="_blank" rel="noopener noreferrer" class="chat-link">${t}</a>`})),t})(e.text),u=o?"group-start":"msg-continuation",p=e.user_id===n.user?.id?"me":"not-me",m=r.toLocaleString("en-GB",{dateStyle:"full",timeStyle:"short"}),w=`<b>${l(e.user_name||"User")}</b><br>${m}`;return s+=`<div class="msg ${p} ${u}" data-time="${e.created_at}" data-tooltip="${l(w)}" oncontextmenu="event.preventDefault(); showTooltip(event, this.dataset.tooltip)" ontouchstart="window.startMsgTimer(event, this)" ontouchend="window.clearMsgTimer()" ontouchmove="window.clearMsgTimer()">${o&&!a?`<div class="msg-header"><span class="msg-user">${l(c)}</span></div>`:""}<div>${d}</div><span class="msg-time">${l(e.time)}</span></div>`,s};window.startMsgTimer=(e,t)=>{n.longPressTimer=setTimeout((()=>((e,t)=>{const a=d("context-tooltip");a.innerHTML=t,a.classList.add("active");let n=e.clientX||e.touches?.[0]?.clientX,s=e.clientY||e.touches?.[0]?.clientY;a.style.left=`${n}px`,a.style.top=s-40+"px",a.offsetLeft<10&&(a.style.left="10px"),a.offsetTop<10&&(a.style.top=`${s+10}px`)})(e,t.dataset.tooltip)),500)},window.clearMsgTimer=()=>{n.longPressTimer&&clearTimeout(n.longPressTimer),n.longPressTimer=null},document.addEventListener("click",(()=>d("context-tooltip").classList.remove("active")));const U=()=>{const e=d("chat-messages");e&&e.scrollTop<50&&!n.isLoadingHistory&&n.hasMoreHistory&&k()},k=async()=>{if(!n.oldestMessageTimestamp||!n.currentRoomId)return;n.isLoadingHistory=!0;const e=d("chat-messages"),a=e.scrollHeight;e.insertAdjacentHTML("afterbegin",'<div id="history-loader" style="text-align:center;padding:10px;font-size:11px;color:var(--text-mute)">Loading...</div>');const{data:s,error:r}=await c.from("messages").select("*").eq("room_id",n.currentRoomId).lt("created_at",n.oldestMessageTimestamp).order("created_at",{ascending:!1}).limit(t.historyLoadLimit);if(d("history-loader")?.remove(),r||!s||0===s.length)return n.hasMoreHistory=!1,void(n.isLoadingHistory=!1);s.reverse(),v.historyDecrypted=async t=>{const s=t.results.filter((e=>!e.error));if(s.length>0){n.oldestMessageTimestamp=s[0].created_at;let t="",r=null;s.forEach((e=>{t+=D(e,r,n.currentRoomData?.is_direct),r=e})),e.insertAdjacentHTML("afterbegin",t),e.scrollTop=e.scrollHeight-a}n.isLoadingHistory=!1},g.postMessage({type:"decryptHistory",payload:{messages:s}})};window.openRoomInfo=async()=>{if(!n.currentRoomData)return;window.setLoading(!0,"Loading info...");const e=n.currentRoomData,t=d("info-delete-btn"),a=d("info-creator-row");t.style.display="none",t.innerText="Delete Chat",t.classList.remove("active"),n.deleteConfirmTimeout&&clearTimeout(n.deleteConfirmTimeout),d("info-id").innerText=e.id;const s=new Date(e.created_at),r=String(s.getDate()).padStart(2,"0"),i=String(s.getMonth()+1).padStart(2,"0"),o=s.getFullYear();if(d("info-date").innerText=`${r}/${i}/${o}`,e.is_direct){d("info-type").innerText="Direct Message",a.style.display="none";const s=e.allowed_users?.find((e=>e!==n.user.id));if(s){let e=n.profileCache[s];if(!e){const{data:t}=await c.from("profiles").select("full_name, avatar_url").eq("id",s).single();e=t,t&&(n.profileCache[s]=t)}d("info-name").innerText=e?.full_name||"User";const t=d("info-avatar");e?.avatar_url?t.innerHTML=`<img src="${e.avatar_url}">`:t.innerText=(e?.full_name||"U").charAt(0)}else d("info-name").innerText="Chat",d("info-avatar").innerText="?";t.style.display="flex"}else{d("info-type").innerText="Group Chat",d("info-name").innerText=e.name;const s=d("info-avatar");if(e.avatar_url?s.innerHTML=`<img src="${e.avatar_url}">`:s.innerText=e.name.charAt(0),a.style.display="flex",e.created_by){let t=n.profileCache[e.created_by];if(!t){const{data:a}=await c.from("profiles").select("full_name").eq("id",e.created_by).single();t=a,a&&(n.profileCache[e.created_by]=a)}d("info-creator").innerText=t?.full_name||"Unknown"}else d("info-creator").innerText="Unknown";e.created_by===n.user.id&&(t.style.display="flex")}window.setLoading(!1),d("overlay-container").classList.add("active"),window.showOverlayView("room-info"),lucide.createIcons()},window.initiateDeleteRoom=()=>{const e=d("info-delete-btn");e.classList.contains("active")?window.deleteRoom():(e.classList.add("active"),e.innerText="Tap again to confirm",n.deleteConfirmTimeout=setTimeout((()=>{e.classList.remove("active"),e.innerText="Delete Chat"}),3e3))},window.openRoomSettings=async()=>{if(window.closeOverlay(),!n.currentRoomId||!n.currentRoomData||n.currentRoomData.created_by!==n.user.id)return window.toast("Not owner");window.setLoading(!0,"Loading...");const e=n.currentRoomData;n.currentStep.edit=1,C("edit"),d("edit-room-name").value=e.name,d("edit-room-visible").checked=e.is_visible,d("edit-room-pass").value="";const t=d("pass-status-label"),a=d("btn-remove-pass");e.has_password?(t.innerText="Active",t.style.color="var(--success)",a.style.display="block"):(t.innerText="Not Set",t.style.color="var(--text-mute)",a.style.display="none"),n.removePasswordFlag=!1,n.selectedAllowedUsers=[];const s=e.allowed_users;if(s&&!s.includes("*")){const{data:e}=await c.from("profiles").select("id, full_name, avatar_url").in("id",s);n.selectedAllowedUsers=s.map((t=>{const a=e?.find((e=>e.id===t));return{id:t,name:a?.full_name||"Unknown",avatar:a?.avatar_url}}))}d("overlay-container").classList.add("active"),window.showOverlayView("room-settings"),window.setLoading(!1)},window.prepareRemovePassword=()=>{n.removePasswordFlag=!0,d("pass-status-label").innerText="Will be removed",d("pass-status-label").style.color="var(--danger)",d("edit-room-pass").value="",d("edit-room-pass").disabled=!0},window.saveRoomSettings=async e=>{if(!e||!e.isTrusted)return;if(n.processingAction)return;n.processingAction=!0;const t=d("edit-room-name").value.trim(),a=d("edit-room-visible").checked,s=d("edit-room-pass").value;let r=n.selectedAllowedUsers.length>0?n.selectedAllowedUsers.map((e=>e.id)):["*"];if(r.includes(n.user.id)||r.push(n.user.id),!t)return window.toast("Name required"),void(n.processingAction=!1);n.currentRoomData;const i=s.length>0,o=n.removePasswordFlag;window.setLoading(!0,"Saving...");const l={name:t,is_visible:a,allowed_users:r};o?l.has_password=!1:i&&(l.has_password=!0);const{error:u}=await c.from("rooms").update(l).eq("id",n.currentRoomId);if(u)return window.toast("Failed: "+u.message),window.setLoading(!1),void(n.processingAction=!1);if(o)await c.rpc("set_room_password",{p_room_id:n.currentRoomId,p_hash:null}),n.currentRoomData.has_password=!1;else if(i){const e=n.currentRoomData.salt,t=await y(s+e);await c.rpc("set_room_password",{p_room_id:n.currentRoomId,p_hash:t}),n.currentRoomData.has_password=!0}const{data:p}=await c.from("rooms").select("*").eq("id",n.currentRoomId).single();n.currentRoomData=p,d("chat-title").innerText=p.name,window.toast("Saved"),window.closeOverlay(),n.processingAction=!1,window.setLoading(!1)},window.deleteRoom=async()=>{if(!n.currentRoomId)return;window.setLoading(!0,"Deleting...");const{error:e}=await c.from("rooms").delete().eq("id",n.currentRoomId);if(e)return window.toast("Failed: "+e.message),void window.setLoading(!1);window.toast("Deleted"),n.currentRoomId=null,n.currentRoomData=null,window.closeOverlay(),window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.openVault=async(e,a,s,r)=>{if(!n.user)return window.toast("Please login first");window.setLoading(!0,"Decrypting..."),n.currentRoomPassword=s,n.chatChannel&&n.chatChannel.unsubscribe(),n.currentRoomId=e,n.lastRenderedDateLabel=null,n.oldestMessageTimestamp=null,n.hasMoreHistory=!0,n.isLoadingHistory=!1,d("chat-messages").innerHTML='<div id="chat-empty-state" style="inset:0;z-index:5;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;width:100%"><i data-lucide="message-circle" style="width:40px;height:40px;color:#d1d1d6;margin-bottom:12px"></i><div style="font-size:14px;font-weight:700;color:var(--text-main)">No messages yet</div></div>',d("chat-messages").onscroll=U;const i=s?s+e:e;try{await(o=i,l=r,new Promise(((e,t)=>{v.keyDerived=a=>{a.success?e(!0):t("Key derivation failed")},g.postMessage({type:"deriveKey",payload:{password:o,salt:l}})})))}catch(e){return window.setLoading(!1),window.toast("Key derivation failed")}var o,l;const{data:p}=await c.from("rooms").select("*").eq("id",e).single();n.currentRoomData=p;const m=p.is_direct;let w=a,y=p.avatar_url;if(m){const e=p.allowed_users?.find((e=>e!==n.user.id));if(e){let t=n.profileCache[e];if(!t){const{data:a}=await c.from("profiles").select("full_name, avatar_url").eq("id",e).single();t=a,a&&(n.profileCache[e]=a)}t&&(w=t.full_name,y=t.avatar_url)}}d("chat-title").innerText=w;const f=d("chat-avatar-display");y?f.innerHTML=`<img src="${y}">`:f.innerText=w.charAt(0).toUpperCase();const h=d("info-edit-btn");m||p.created_by!==n.user.id?h.style.display="none":h.style.display="flex",lucide.createIcons(),window.setLoading(!0,"Fetching History...");const{data:b}=await c.from("messages").select("*").eq("room_id",e).order("created_at",{ascending:!1}).limit(t.maxMessages);d("chat-input").style.display="block",d("send-btn").style.display="flex",window.nav("scr-chat"),u("connecting"),b&&b.length>0?(b.reverse(),b.length>0&&(n.oldestMessageTimestamp=b[0].created_at),window.setLoading(!0,"Decrypting..."),v.historyDecrypted=async e=>{const t=d("chat-messages");t.innerHTML="";let a=null;e.results.forEach((e=>{e.error||(t.insertAdjacentHTML("beforeend",D(e,a,m)),a=e)})),t.scrollTop=t.scrollHeight,M(),window.setLoading(!1)},g.postMessage({type:"decryptHistory",payload:{messages:b}})):(n.hasMoreHistory=!1,M(),window.setLoading(!1)),_(e),L(e)};window.sendMsg=async e=>{if(!e||!e.isTrusted)return;if(!n.user||!n.currentRoomId||n.processingAction||!n.isChatChannelReady)return;if(!(()=>{const e=Date.now();if(e-n.lastMessageTime<t.rateLimitMs){const a=t.rateLimitMs-(e-n.lastMessageTime);return d("chat-input-area").classList.add("rate-limited"),setTimeout((()=>d("chat-input-area").classList.remove("rate-limited")),a),!1}return!0})())return;n.processingAction=!0;const a=d("chat-input").value.trim();if(a){d("chat-input").value="",n.lastMessageTime=Date.now();try{const e=await(s=a,new Promise(((e,t)=>{v.encrypted=a=>{a.result?e(a.result):t("Encryption failed")};const a=(new Date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});g.postMessage({type:"encrypt",payload:{text:a+"|"+s}})})));await c.from("messages").insert([{room_id:n.currentRoomId,user_id:n.user.id,user_name:n.user.user_metadata?.full_name,content:e}])}catch(e){window.toast("Failed to send")}var s;n.processingAction=!1}else n.processingAction=!1},window.leaveChat=async()=>{window.setLoading(!0,"Leaving..."),n.chatChannel&&n.chatChannel.unsubscribe(),n.chatChannel=null,n.currentRoomId=null,n.currentRoomData=null,n.presenceChannel&&n.presenceChannel.unsubscribe(),n.presenceChannel=null,n.isPresenceSubscribed=!1,n.heartbeatInterval&&clearInterval(n.heartbeatInterval),n.heartbeatInterval=null,u("offline"),d("info-edit-btn")&&(d("info-edit-btn").style.display="none"),window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.handleLogin=async e=>{if(!e||!e.isTrusted)return;if(n.processingAction)return;n.processingAction=!0;const t=d("l-email").value,a=d("l-pass").value;if(!t||!a)return window.toast("Input missing"),void(n.processingAction=!1);window.setLoading(!0,"Signing In..."),localStorage.removeItem(s);const{error:r}=await c.auth.signInWithPassword({email:t,password:a});r?(window.toast(r.message),window.setLoading(!1)):(window.nav("scr-lobby"),window.loadRooms()),n.processingAction=!1},window.handleRegister=async e=>{if(!e||!e.isTrusted)return;if(n.processingAction)return;n.processingAction=!0;const a=d("r-name").value,s=d("r-email").value.trim().toLowerCase(),r=d("r-pass").value,i=d("r-avatar-url").value.trim()||n.selectedAvatar;if(!a||!s||r.length<8)return window.toast("Check inputs"),void(n.processingAction=!1);window.setLoading(!0,"Sending Code...");const[o,c]=await m(fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send",email:s})}));if(o){if(429===o.status)return window.toast("Rate limited"),n.processingAction=!1,void window.setLoading(!1);const e=await o.json();"Code sent"===e.message?(sessionStorage.setItem("temp_reg",JSON.stringify({n:a,em:s,p:r,avatar:i})),window.nav("scr-verify"),E(),window.setLoading(!1)):(window.toast(e.message||"Error"),window.setLoading(!1))}else window.toast("Network error"),window.setLoading(!1);n.processingAction=!1};const E=()=>{let e=t.verificationCodeExpiry;n.vTimer&&clearInterval(n.vTimer),n.vTimer=setInterval((()=>{e--,d("v-timer").innerText=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`,e<=0&&(clearInterval(n.vTimer),window.nav("scr-register"))}),1e3)};window.handleVerify=async e=>{if(!e||!e.isTrusted)return;if(n.processingAction)return;n.processingAction=!0;const a=d("v-code").value,r=JSON.parse(sessionStorage.getItem("temp_reg"));if(!r)return window.toast("Session expired"),void(n.processingAction=!1);window.setLoading(!0,"Verifying...");const i=await fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"verify",email:r.em,code:a})});if(429===i.status)return window.toast("Rate limited"),n.processingAction=!1,void window.setLoading(!1);const o=await i.json();if("Verified"===o.message){localStorage.removeItem(s);const{error:e}=await c.auth.signUp({email:r.em,password:r.p,options:{data:{full_name:r.n,avatar_url:r.avatar}}});e?(window.toast(e.message),window.setLoading(!1)):(window.nav("scr-lobby"),window.loadRooms())}else window.toast(o.message||"Wrong code"),window.setLoading(!1);n.processingAction=!1},window.handleCreate=async e=>{if(!e||!e.isTrusted)return;if(n.processingAction)return;n.processingAction=!0;const t="direct"===n.createType;let a,s=!0,r=null,i=null,o=null;if(t){if(r=d("c-target-user").value.trim(),!r)return window.toast("User ID required"),void(n.processingAction=!1);const{data:e,error:t}=await c.from("profiles").select("full_name").eq("id",r).single();if(t||!e)return window.toast("User not found"),void(n.processingAction=!1);a="Direct Message",s=!0}else if(a=d("c-name").value.trim(),i=d("c-avatar").value.trim()||null,o=d("c-pass").value,s=d("c-visible").checked,!a)return window.toast("Name required"),void(n.processingAction=!1);let l=["*"];t?l=[n.user.id,r]:n.selectedAllowedUsers.length>0&&(l=n.selectedAllowedUsers.map((e=>e.id)),l.includes(n.user.id)||l.push(n.user.id)),window.setLoading(!0,"Creating...");const u=(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("")})(),p={name:a,avatar_url:i,has_password:!!o,is_visible:s,salt:u,created_by:n.user.id,allowed_users:l,is_direct:t},{data:m,error:w}=await c.from("rooms").insert([p]).select();if(w)return window.toast("Error: "+w.message),n.processingAction=!1,void window.setLoading(!1);if(m&&m.length>0){const e=m[0];if(o){const t=await y(o+u);await c.rpc("set_room_password",{p_room_id:e.id,p_hash:t})}n.lastCreated=e,n.lastCreatedPass=o,d("s-id").innerText=e.id,window.nav("scr-success"),n.selectedAllowedUsers=[]}n.processingAction=!1,window.setLoading(!1)},window.submitGate=async e=>{if(!e||!e.isTrusted)return;const t=d("gate-pass").value,a=await y(t+n.pending.salt);window.setLoading(!0,"Verifying...");const{data:s}=await c.rpc("verify_room_password",{p_room_id:n.pending.id,p_hash:a});window.setLoading(!1),!0===s?window.openVault(n.pending.id,n.pending.name,t,n.pending.salt):window.toast("Access Denied")},window.handleLogout=async e=>{e&&e.isTrusted&&(window.setLoading(!0,"Leaving..."),n.heartbeatInterval&&clearInterval(n.heartbeatInterval),n.presenceChannel&&n.presenceChannel.unsubscribe(),n.chatChannel&&n.chatChannel.unsubscribe(),localStorage.setItem(s,"true"),n.user=null,await c.auth.signOut(),window.nav("scr-start"),window.setLoading(!1))},window.copySId=()=>{navigator.clipboard.writeText(n.lastCreated.id),window.toast("ID Copied")},window.enterCreated=()=>{window.openVault(n.lastCreated.id,n.lastCreated.name,n.lastCreatedPass,n.lastCreated.salt),n.lastCreatedPass=null},c.auth.onAuthStateChange((async(e,t)=>{if("true"===localStorage.getItem(s))return void(n.user=null);n.user=t?.user;const a=d("icon-plus-lobby"),r=document.querySelector(".screen.active")?.id;if(a&&(a.style.display="flex"),"SIGNED_IN"===e&&n.user){["scr-start","scr-login","scr-register","scr-verify"].includes(r)&&(window.nav("scr-lobby"),window.loadRooms(),window.forceClaimMaster()),S()}"SIGNED_OUT"===e&&(n.heartbeatInterval&&clearInterval(n.heartbeatInterval),n.presenceChannel&&n.presenceChannel.unsubscribe(),n.chatChannel&&n.chatChannel.unsubscribe(),localStorage.removeItem(s),window.nav("scr-start"))})),window.nav=(e,t=null)=>{const a=document.querySelector(".screen.active"),s=d(e);if(!s)return;"scr-create"===e&&(n.currentStep.create=1,n.selectedAllowedUsers=[],n.createType="group",C("create"),d("c-name").value="",d("c-target-user").value="",d("c-pass").value="",d("c-avatar").value="",document.querySelectorAll(".type-card").forEach((e=>e.classList.remove("selected"))),d("type-group").classList.add("selected")),"scr-register"===e&&(n.currentStep.reg=1,C("reg")),"scr-account"===e&&window.prepareAccountPage(),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("slide-left","slide-right"))),"left"===t?(a.classList.add("slide-left"),s.classList.remove("slide-right")):"right"===t?(a.classList.add("slide-right"),s.classList.remove("slide-left")):document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),s.classList.add("active"),lucide.createIcons();const r=d("icon-plus-lobby");r&&(r.style.display="flex"),"scr-lobby"===e&&S()},window.refreshLobby=async()=>{const e=Date.now();if(e-n.lastLobbyRefresh<1e4)return window.toast(`Wait ${Math.ceil((1e4-(e-n.lastLobbyRefresh))/1e3)}s`);n.lastLobbyRefresh=e,window.toast("Refreshing..."),await window.loadRooms()},window.loadRooms=async()=>{if(!n.user)return;window.setLoading(!0,"Fetching...");const{data:e,error:t}=await c.from("rooms").select("*").order("created_at",{ascending:!1});if(t)return window.toast("Failed to load rooms"),void window.setLoading(!1);const a=n.user.id,s=[];for(const t of e)if(t.is_direct&&t.allowed_users){const e=t.allowed_users.find((e=>e!==a));if(e)if(n.profileCache[e])s.push({...t,display_name:n.profileCache[e].full_name,display_avatar:n.profileCache[e].avatar_url});else{const{data:a}=await c.from("profiles").select("full_name, avatar_url").eq("id",e).single();a?(n.profileCache[e]=a,s.push({...t,display_name:a.full_name,display_avatar:a.avatar_url})):s.push({...t,display_name:"User",display_avatar:null})}else s.push({...t,display_name:"User",display_avatar:null})}else s.push({...t,display_name:t.name,display_avatar:t.avatar_url});n.allRooms=s,window.filterRooms(),window.setLoading(!1),S()},window.filterRooms=()=>{const e=d("search-bar").value.toLowerCase(),t=d("room-list"),a=(n.user,n.allRooms.filter((t=>{if(!t.is_direct&&!t.is_visible)return!1;return!!(t.display_name||t.name||"").toLowerCase().includes(e)})));0===a.length?t.innerHTML='<div style="text-align:center;padding:40px 20px;color:var(--text-mute)"><i data-lucide="folder" style="width:40px;height:40px;margin-bottom:12px;color:#d1d1d6"></i><div style="font-size:14px;font-weight:700;color:var(--text-main)">No groups yet</div></div>':t.innerHTML=a.map((e=>`\n            <div class="room-card" onclick="window.joinAttempt('${e.id}')">\n            <div class="chat-avatar" style="width:36px;height:36px;margin-right:10px;font-size:13px">${e.display_avatar?`<img src="${e.display_avatar}">`:(e.display_name||"G").charAt(0)}</div>\n            <span class="room-name">${l(e.display_name)}</span>\n            <span class="room-icon">${e.is_direct?'<i data-lucide="user" style="width:14px;height:14px"></i>':""}${e.has_password?'<i data-lucide="lock" style="width:14px;height:14px"></i>':""}</span>\n            </div>`)).join(""),lucide.createIcons()},window.joinAttempt=async e=>{window.setLoading(!0,"Checking...");const{data:t}=await c.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),window.toast("Access denied");const{data:a,error:s}=await c.from("rooms").select("*").eq("id",e).single();if(window.setLoading(!1),s||!a)return window.toast("Not found");n.pending={id:a.id,name:a.name,salt:a.salt},n.currentRoomData=a,a.has_password?window.nav("scr-gate"):window.openVault(a.id,a.name,null,a.salt)},window.joinPrivate=async()=>{if(!n.user)return window.toast("Login required");const e=d("join-id").value.trim();if(!e)return;window.setLoading(!0,"Checking...");const{data:t}=await c.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),window.toast("Access denied or not found");const{data:a}=await c.from("rooms").select("*").eq("id",e).single();window.setLoading(!1),a?(n.pending={id:a.id,name:a.name,salt:a.salt},n.currentRoomData=a,a.has_password?window.nav("scr-gate"):window.openVault(a.id,a.name,null,a.salt)):window.toast("Not found")};(async()=>{if(!navigator.onLine)return void d("offline-screen").classList.add("active");if("true"===localStorage.getItem(s))return n.user=null,window.nav("scr-start"),window.setLoading(!1),void T();const[e,t]=await m(c.auth.getUser());if(t)return console.error("Session validation failed:",t),await c.auth.signOut(),window.nav("scr-start"),window.setLoading(!1),void T();const a=e?.data?.user;if(a){n.user=a;if(await new Promise((e=>{let t=!1;const a=e=>{"PONG_MASTER"===e.data.type&&(t=!0)};o.addEventListener("message",a),o.postMessage({type:"PING_MASTER"}),setTimeout((()=>{o.removeEventListener("message",a),e(t)}),300)}))){d("block-overlay").classList.add("active"),lucide.createIcons(),window.nav("scr-lobby"),window.loadRooms()}else window.forceClaimMaster(),window.nav("scr-lobby"),window.loadRooms()}lucide.createIcons(),window.setLoading(!1),T()})()}
