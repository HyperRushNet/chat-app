// assets/startChatAppFn.min.js | GH: HyperRushNet | 2026 | MIT License
import{createClient}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";export function startChatApp(e={}){const t={supabaseUrl:e.supabaseUrl||"https://fahbqdajxnhswevdagdn.supabase.co",supabaseKey:e.supabaseKey||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhaGJxZGFqeG5oc3dldmRhZ2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTEyODEsImV4cCI6MjA4NjEyNzI4MX0.UPgPxyaWBULjH4jL8UaSr6bJXTsFWWJRIYodHmXeVTI",mailApi:e.mailApi||"https://vercel-serverless-gray-sigma.vercel.app/api/mailAPI",maxUsers:e.maxUsers||475,maxMessages:e.maxMessages||15,historyLoadLimit:e.historyLoadLimit||10,rateLimitMs:e.rateLimitMs||1e3,presenceHeartbeatMs:e.presenceHeartbeatMs||1e4,reconnectDebounceMs:e.reconnectDebounceMs||3e3,verificationCodeExpiry:e.verificationCodeExpiry||600};lucide.createIcons();const s={user:null,currentRoomId:null,chatChannel:null,presenceChannel:null,allRooms:[],vTimer:null,lastRenderedDateLabel:null,lastKnownOnlineCount:null,heartbeatInterval:null,uptimeInterval:null,sessionStartTime:null,isPresenceSubscribed:!1,lastReconnectAttempt:0,roomGuestStatus:{},pending:null,lastCreated:null,lastCreatedPass:null,isMasterTab:!1,tabId:sessionStorage.getItem("hrn_tab_id")||(sessionStorage.setItem("hrn_tab_id",crypto.randomUUID()),sessionStorage.getItem("hrn_tab_id")),processingAction:!1,serverFull:!1,isLoadingHistory:!1,oldestMessageTimestamp:null,hasMoreHistory:!0,lastMessageTime:0,isConnecting:!1},n="hrn_flag_force_logout",a="hrn_flag_guest_name",r="hrn_flag_guest_id";let i=[],o=!1;const c=new BroadcastChannel("hrn_tab_sync"),l=createClient(t.supabaseUrl,t.supabaseKey,{auth:{persistSession:!0,autoRefreshToken:!0},realtime:{params:{eventsPerSecond:10}}}),d=e=>{const t=document.createElement("p");return t.textContent=e,t.innerHTML},u=e=>document.getElementById(e),m=e=>{"number"==typeof e&&(s.lastKnownOnlineCount=e);const t="number"==typeof e?e:"--";document.querySelectorAll(".live-count").forEach((e=>{e.innerText!==t&&(e.innerText=t)}));const n=u("hub-online-count");n&&n.innerText!==t&&(n.innerText=t)},w=()=>{if(!s.sessionStartTime)return;const e=Math.floor((Date.now()-s.sessionStartTime)/1e3),t=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0"),a=u("hub-uptime");a&&(a.innerText=`${t}:${n}`)},p=()=>{if(o||0===i.length)return;o=!0;const e=i.shift(),t=u("toast-container"),s=document.createElement("div");s.className="toast-item",s.innerText=e,s.onclick=()=>{s.style.opacity="0",setTimeout((()=>{s.remove(),o=!1,p()}),400)},t.appendChild(s),setTimeout((()=>{s.parentNode&&(s.style.opacity="0",setTimeout((()=>{s.parentNode&&s.remove(),o=!1,p()}),400))}),3e3)};window.toast=e=>{i.push(e),p()},window.setLoading=(e,t=null)=>{const s=u("loader-overlay"),n=u("loader-text");e?s.classList.add("active"):s.classList.remove("active"),n.innerText=t||"Loading..."};const g=new Blob(["self.onmessage = async (e) => {\n    const { type, payload } = e.data;\n    const encoder = new TextEncoder();\n    const decoder = new TextDecoder();\n    try {\n      if (type === 'deriveKey') {\n        const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(payload.password), { name: 'PBKDF2' }, false, ['deriveKey']);\n        const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: encoder.encode(payload.salt), iterations: 300000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);\n        self.cryptoKey = key;\n        self.postMessage({ type: 'keyDerived', success: true });\n      } else if (type === 'encrypt') {\n        if (!self.cryptoKey) throw new Error(\"Key not derived\");\n        const iv = crypto.getRandomValues(new Uint8Array(12));\n        const encoded = encoder.encode(payload.text);\n        const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, self.cryptoKey, encoded);\n        const combined = new Uint8Array(iv.length + ciphertext.byteLength);\n        combined.set(iv, 0);\n        combined.set(new Uint8Array(ciphertext), iv.length);\n        const base64 = btoa(String.fromCharCode(...combined));\n        self.postMessage({ type: 'encrypted', result: base64 });\n      } else if (type === 'decryptHistory') {\n        if (!self.cryptoKey) throw new Error(\"Key not derived\");\n        const results = [];\n        for (const m of payload.messages) {\n          try {\n            const binary = atob(m.content);\n            const bytes = new Uint8Array(binary.length);\n            for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n            const iv = bytes.slice(0, 12);\n            const ciphertext = bytes.slice(12);\n            const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n            const text = decoder.decode(decrypted);\n            const parts = text.split('|');\n            results.push({ id: m.id, time: parts[0], text: parts.slice(1).join('|'), user_id: m.user_id, user_name: m.user_name, created_at: m.created_at });\n          } catch (err) {\n            results.push({ id: m.id, error: true });\n          }\n        }\n        self.postMessage({ type: 'historyDecrypted', results });\n      } else if (type === 'decryptSingle') {\n        if (!self.cryptoKey) throw new Error(\"Key not derived\");\n        try {\n          const binary = atob(payload.content);\n          const bytes = new Uint8Array(binary.length);\n          for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n          const iv = bytes.slice(0, 12);\n          const ciphertext = bytes.slice(12);\n          const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n          const text = decoder.decode(decrypted);\n          const parts = text.split('|');\n          self.postMessage({ type: 'singleDecrypted', result: { time: parts[0], text: parts.slice(1).join('|') } });\n        } catch(e) {\n          self.postMessage({ type: 'singleDecrypted', error: e.message });\n        }\n      }\n    } catch (error) {\n      self.postMessage({ type: 'error', message: error.message });\n    }\n  };"],{type:"application/javascript"}),y=new Worker(URL.createObjectURL(g)),v={};y.onmessage=e=>{const{type:t}=e.data;v[t]&&(v[t](e.data),delete v[t])};const h=async e=>{const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")},f=e=>new Promise(((t,s)=>{v.encrypted=e=>{e.result?t(e.result):s("Encryption failed")};const n=(new Date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});y.postMessage({type:"encrypt",payload:{text:n+"|"+e}})})),b=async()=>{if(s.presenceChannel){try{await l.removeChannel(s.presenceChannel)}catch(e){}s.presenceChannel=null,s.isPresenceSubscribed=!1}if(s.chatChannel){try{await l.removeChannel(s.chatChannel)}catch(e){}s.chatChannel=null}},_=async()=>{if(!s.presenceChannel)return;const e=s.presenceChannel.presenceState(),n=Object.values(e).flat(),a=new Set(n.map((e=>e.user_id)));m(a.size),a.size>t.maxUsers?s.serverFull||(s.serverFull=!0,u("capacity-overlay").classList.add("active"),b()):s.serverFull=!1},I=async(e=!1)=>{if(!s.isMasterTab||!s.user)return;const n=Date.now();if(!e&&s.isConnecting)return;if(!e&&n-s.lastReconnectAttempt<t.reconnectDebounceMs)return;if(s.lastReconnectAttempt=n,s.isConnecting=!0,s.isPresenceSubscribed=!1,s.presenceChannel)try{await l.removeChannel(s.presenceChannel)}catch(e){}m(null);const a=s.user.id;s.presenceChannel=l.channel("online-users",{config:{presence:{key:a}}}),s.presenceChannel.on("presence",{event:"sync"},(()=>{s.presenceChannel&&_()})).subscribe((async(e,n)=>{if("SUBSCRIBED"===e){if(!s.presenceChannel)return;s.isPresenceSubscribed=!0,s.isConnecting=!1,_(),await s.presenceChannel.track({user_id:a,online_at:(new Date).toISOString()}),_(),s.heartbeatInterval&&clearInterval(s.heartbeatInterval),s.heartbeatInterval=setInterval((async()=>{s.presenceChannel&&s.isMasterTab&&!s.serverFull&&await s.presenceChannel.track({user_id:a,online_at:(new Date).toISOString()})}),t.presenceHeartbeatMs),setTimeout((()=>{null===s.lastKnownOnlineCount&&s.isPresenceSubscribed&&!s.serverFull&&_()}),2e3)}else"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||(s.isPresenceSubscribed=!1,s.isConnecting=!1,m(null))}))},L=()=>{setInterval((()=>{if(!navigator.onLine)return u("offline-screen").classList.add("active"),s.isPresenceSubscribed=!1,void m(null);if(u("offline-screen").classList.remove("active"),!s.user||!s.isMasterTab)return;if(s.currentRoomId)return;const e=l.realtime.connectionState();"disconnected"!==e&&"stopped"!==e||s.isConnecting||I(!0)}),5e3)};window.retryConnection=()=>{u("capacity-overlay").classList.remove("active"),s.serverFull=!1,I(!0)},window.handlePrivateToggle=()=>{const e=u("c-private").checked;u("c-pass").placeholder=e?"Passkey (Required)":"Passkey (Optional)"},window.forceClaimMaster=()=>{s.isMasterTab||(s.isMasterTab=!0,c.postMessage({type:"CLAIM_MASTER",id:s.tabId}),u("block-overlay").classList.remove("active"),"true"!==localStorage.getItem(n)&&s.user&&I(!0))},window.closeTabAttempt=()=>{window.open("","_self"),window.close()},c.onmessage=e=>{if("CLAIM_MASTER"===e.data.type&&e.data.id!==s.tabId&&s.isMasterTab){b(),s.heartbeatInterval&&clearInterval(s.heartbeatInterval),s.heartbeatInterval=null,s.isPresenceSubscribed=!1,s.isMasterTab=!1,m(null);const e=u("block-overlay");e.innerHTML='\n          <i data-lucide="log-out" style="width:48px;height:48px;margin-bottom:24px;color:var(--danger)"></i>\n          <h1 class="title">Session Moved</h1>\n          <p class="subtitle" style="margin-bottom:48px">You switched to a new tab.</p>\n          <button class="btn btn-accent" onclick="window.forceClaimMaster()">Use Here</button>\n        ',e.classList.add("active"),lucide.createIcons()}"PING_MASTER"===e.data.type&&s.isMasterTab&&c.postMessage({type:"PONG_MASTER"})},window.addEventListener("beforeunload",(()=>{c.postMessage({type:"CLAIM_MASTER",id:s.tabId})}));window.showGuestInfo=()=>{u("overlay-container").classList.add("active"),window.showOverlayView("guest-info"),lucide.createIcons()},window.openHub=()=>{u("overlay-container").classList.add("active"),window.showOverlayView("hub"),lucide.createIcons()},window.closeOverlay=()=>u("overlay-container").classList.remove("active"),window.showOverlayView=e=>{const t=document.querySelector(".panel-card");if(!t)return;t.querySelectorAll(".view-content").forEach((e=>e.classList.remove("active")));const s=u(`view-${e}`);s&&(s.classList.add("active"),lucide.createIcons())},window.prepareMyAccount=()=>{if(!s.user)return;const e=s.user.is_anonymous;u("my-acc-name").innerText=s.user.user_metadata?.full_name||"User",u("my-acc-id").innerText=s.user.id,u("my-acc-email").innerText=e?"Guest Mode":s.user.email||"No email",u("my-acc-type").innerText=e?"Guest Account":"Full Account",u("my-acc-type").style.color=e?"var(--warning)":"var(--success)",window.showOverlayView("my-account")},window.inspectUser=async e=>{if(e===s.user?.id)return window.prepareMyAccount();window.setLoading(!0,"Fetching info...");const{data:t,error:n}=await l.from("profiles").select("id, full_name, updated_at, is_guest").eq("id",e).single();if(window.setLoading(!1),n||!t)return window.toast("User not found");u("qv-user-name").innerText=t.full_name,u("qv-user-avatar").innerText=t.full_name.charAt(0).toUpperCase(),u("qv-user-id").innerText=t.id,u("qv-full-name").innerText=t.full_name;const a=u("qv-status");a.innerText=t.is_guest?"Guest":"Registered",a.style.color=t.is_guest?"var(--warning)":"var(--success)";const r=new Date(t.updated_at);u("qv-user-date").innerText=r.toLocaleDateString("en-GB"),window.showOverlayView("quick-view-user"),u("overlay-container").classList.add("active")};window.nav=(e,t=null)=>{const n=document.querySelector(".screen.active"),r=u(e);if(!r)return;"scr-guest"===e&&(()=>{const e=localStorage.getItem(a),t=u("g-name"),s=document.querySelector(".input-lock-icon");e?(t.value=e,t.disabled=!0,t.placeholder="Identity Locked",s&&(s.style.display="block")):(t.value="",t.disabled=!1,t.placeholder="Enter Name (Permanent)",s&&(s.style.display="none")),lucide.createIcons()})(),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("slide-left","slide-right"))),"left"===t?(n.classList.add("slide-left"),r.classList.remove("slide-right")):"right"===t?(n.classList.add("slide-right"),r.classList.remove("slide-left")):document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),r.classList.add("active"),lucide.createIcons();const i=u("icon-plus-lobby");i&&(i.style.display=s.user?.is_anonymous&&"scr-lobby"===e?"none":"flex")},window.loadRooms=async()=>{if(!s.user)return;window.setLoading(!0,"Fetching Rooms...");const{data:e}=await l.from("rooms").select("*").eq("is_private",!1).order("created_at",{ascending:!1});s.allRooms=e||[],window.filterRooms(),window.setLoading(!1)},window.filterRooms=()=>{const e=u("search-bar").value.toLowerCase(),t=u("room-list"),n=s.allRooms.filter((t=>t.name.toLowerCase().includes(e)));0===n.length?t.innerHTML='\n        <div class="empty-state">\n          <i data-lucide="folder" class="empty-state-icon"></i>\n          <div class="empty-state-title">No groups yet</div>\n          <div class="empty-state-sub">Create one to start chatting.</div>\n        </div>\n      ':t.innerHTML=n.map((e=>`\n        <div class="room-card" onclick="window.joinAttempt('${e.id}')">\n          <span class="room-name">${d(e.name)}</span>\n          <span class="room-icon">\n            <i data-lucide="${e.has_password?"lock":"chevron-right"}" style="width:18px;height:18px;color:var(--text-mute)"></i>\n          </span>\n        </div>\n      `)).join(""),lucide.createIcons()},window.joinAttempt=async e=>{if(s.serverFull)return window.toast("Network is full");window.setLoading(!0,"Joining Room...");const{data:t,error:n}=await l.from("rooms").select("*").eq("id",e).single();if(window.setLoading(!1),n||!t)return window.toast("Room not found");t.has_password?(s.pending={id:t.id,name:t.name,salt:t.salt},window.nav("scr-gate")):window.openVault(t.id,t.name,null,t.salt)},window.joinPrivate=async()=>{if(s.serverFull)return window.toast("Network is full");if(!s.user)return window.toast("Login required");const e=u("join-id").value.trim();if(!e)return;window.setLoading(!0,"Searching Room...");const{data:t}=await l.from("rooms").select("*").eq("id",e).single();window.setLoading(!1),t?t.has_password?(s.pending={id:t.id,name:t.name,salt:t.salt},window.nav("scr-gate")):window.openVault(t.id,t.name,null,t.salt):window.toast("Not found")};const S=e=>{const t=new Date,s=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=Math.round((s-n)/864e5);return 0===a?"Today":1===a?"Yesterday":a<7?e.toLocaleDateString("en-GB",{weekday:"long"}):e.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})},T=e=>{let t=d(e);return t=t.replace(/(https?:\/\/[^\s]+)/g,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer" class="chat-link">${e}</a>`)),t},M=()=>{const e=u("chat-messages"),t=u("chat-empty-state"),s=e.querySelector(".msg");t&&(t.style.display=s?"none":"flex")},C=(e,t=!1)=>{let n="";const a=new Date(e.created_at),r=S(a);t||r===s.lastRenderedDateLabel?t&&(n+=`<div class="date-divider"><span class="date-label">${r}</span></div>`,s.lastRenderedDateLabel=r):(n+=`<div class="date-divider"><span class="date-label">${r}</span></div>`,s.lastRenderedDateLabel=r);const i=s.roomGuestStatus[e.user_id]||!1,o=(i&&e.user_name,e.user_name),c=i?'<span class="guest-pill">Guest</span>':"",l=T(e.text);return n+=`\n      <div class="msg ${e.user_id===s.user?.id?"me":""}" data-time="${e.created_at}">\n        <span class="msg-user" onclick="window.inspectUser('${e.user_id}')">${d(o)} ${c}</span>\n        <div>${l}</div>\n        <span class="msg-time">${d(e.time)}</span>\n      </div>`,n},A=()=>{const e=u("chat-messages");e&&e.scrollTop<50&&!s.isLoadingHistory&&s.hasMoreHistory&&R()},x=async e=>{if(!e||0===e.length)return;const t=[...new Set(e)],{data:n,error:a}=await l.from("profiles").select("id, full_name, is_guest").in("id",t);n&&n.forEach((e=>{s.roomGuestStatus[e.id]=e.is_guest}))},R=async()=>{if(!s.oldestMessageTimestamp||!s.currentRoomId)return;s.isLoadingHistory=!0;const e=u("chat-messages"),n=e.scrollHeight;e.insertAdjacentHTML("afterbegin",'<div id="history-loader" class="history-loader">Loading...</div>');const{data:a,error:r}=await l.from("messages").select("*").eq("room_id",s.currentRoomId).lt("created_at",s.oldestMessageTimestamp).order("created_at",{ascending:!1}).limit(t.historyLoadLimit);if(u("history-loader")?.remove(),r||!a||0===a.length)return s.hasMoreHistory=!1,void(s.isLoadingHistory=!1);a.reverse(),v.historyDecrypted=async t=>{const a=t.results.filter((e=>!e.error));if(a.length>0){s.oldestMessageTimestamp=a[0].created_at;const t=a.map((e=>e.user_id));await x(t);const r=S(new Date(a[a.length-1].created_at)),i=e.querySelector(".msg");let o=null;if(i){const e=i.getAttribute("data-time");e&&(o=S(new Date(e)))}let c="",l=null;if(a.forEach(((e,t)=>{const n=S(new Date(e.created_at));n!==l&&(t===a.length-1&&n===o||(c+=`<div class="date-divider"><span class="date-label">${n}</span></div>`),l=n);const r=s.roomGuestStatus[e.user_id]||!1,i=(r&&e.user_name,e.user_name),u=r?'<span class="guest-pill">Guest</span>':"",m=T(e.text);c+=`\n            <div class="msg ${e.user_id===s.user?.id?"me":""}" data-time="${e.created_at}">\n              <span class="msg-user" onclick="window.inspectUser('${e.user_id}')">${d(i)} ${u}</span>\n              <div>${m}</div>\n              <span class="msg-time">${d(e.time)}</span>\n            </div>`})),r===o){const t=e.querySelector(".date-divider");t&&t.remove()}e.insertAdjacentHTML("afterbegin",c);const u=e.scrollHeight;e.scrollTop=u-n}s.isLoadingHistory=!1},y.postMessage({type:"decryptHistory",payload:{messages:a}})};window.openVault=async(e,n,a,r)=>{if(!s.user)return window.toast("Please login first");window.setLoading(!0,"Deriving Key..."),s.chatChannel&&await l.removeChannel(s.chatChannel),s.currentRoomId=e,s.lastRenderedDateLabel=null,s.roomGuestStatus={},s.oldestMessageTimestamp=null,s.hasMoreHistory=!0,s.isLoadingHistory=!1,u("chat-title").innerText=n,u("chat-messages").innerHTML='<div id="chat-empty-state" class="empty-state"><i data-lucide="message-circle" class="empty-state-icon"></i><div class="empty-state-title">No messages yet</div><div class="empty-state-sub">Be the first to say something.</div></div>',u("chat-messages").onscroll=A;const i=u("icon-copy-chat"),o=u("icon-check-chat");i&&(i.style.display="block"),o&&(o.style.display="none");const c=a?a+e:e;try{await(d=c,m=r,new Promise(((e,t)=>{v.keyDerived=s=>{s.success?e(!0):t("Key derivation failed")},y.postMessage({type:"deriveKey",payload:{password:d,salt:m}})})))}catch(e){return window.setLoading(!1),window.toast("Key derivation failed")}var d,m;window.setLoading(!0,"Fetching History...");const{data:w}=await l.from("messages").select("*").eq("room_id",e).order("created_at",{ascending:!1}).limit(t.maxMessages),p=s.user.is_anonymous,g=u("guest-info-chat");g&&(g.style.display=p?"flex":"none"),u("chat-input").style.display=p?"none":"block",u("guest-replies").style.display=p?"flex":"none",u("send-btn").style.display=p?"none":"flex",window.nav("scr-chat"),w&&w.length>0?(w.reverse(),w.length>0&&(s.oldestMessageTimestamp=w[0].created_at),window.setLoading(!0,"Decrypting..."),v.historyDecrypted=async e=>{const t=u("chat-messages");t.innerHTML="";const s=e.results.map((e=>e.user_id));await x(s),e.results.forEach((e=>{e.error||t.insertAdjacentHTML("beforeend",C(e))})),t.scrollTop=t.scrollHeight,M(),window.setLoading(!1)},y.postMessage({type:"decryptHistory",payload:{messages:w}})):(s.hasMoreHistory=!1,M(),window.setLoading(!1)),s.chatChannel=l.channel(`room_chat_${e}`,{config:{broadcast:{self:!0}}}),s.chatChannel.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${e}`},(async e=>{const t=e.new;t&&s.currentRoomId&&(v.singleDecrypted=async e=>{if(e.result){await x([t.user_id]);const s={...t,time:e.result.time,text:e.result.text},n=u("chat-messages");n.insertAdjacentHTML("beforeend",C(s)),n.scrollTop=n.scrollHeight,M()}},y.postMessage({type:"decryptSingle",payload:{content:t.content}}))})).subscribe()};const D=()=>{const e=Date.now();if(e-s.lastMessageTime<t.rateLimitMs){const n=t.rateLimitMs-(e-s.lastMessageTime);return u("chat-input-area").classList.add("rate-limited"),setTimeout((()=>{u("chat-input-area").classList.remove("rate-limited")}),n),!1}return!0};window.sendMsg=async e=>{if(!e||!e.isTrusted)return;if(!s.user||!s.currentRoomId)return;if(s.processingAction)return;if(!D())return;s.processingAction=!0;const t=u("chat-input").value.trim();if(t){u("chat-input").value="",s.lastMessageTime=Date.now();try{const e=await f(t);await l.from("messages").insert([{room_id:s.currentRoomId,user_id:s.user.id,user_name:s.user.user_metadata?.full_name,content:e}])}catch(e){window.toast("Failed to send")}s.processingAction=!1}else s.processingAction=!1},window.sendGuestReply=async(e,t)=>{if(e&&e.isTrusted&&s.user&&s.currentRoomId&&!s.processingAction&&D()){s.processingAction=!0,s.lastMessageTime=Date.now();try{const e=await f(t);await l.from("messages").insert([{room_id:s.currentRoomId,user_id:s.user.id,user_name:s.user.user_metadata?.full_name,content:e}])}catch(e){}s.processingAction=!1}},window.leaveChat=async()=>{window.setLoading(!0,"Leaving Room..."),s.chatChannel&&await l.removeChannel(s.chatChannel),s.chatChannel=null,s.currentRoomId=null,s.roomGuestStatus={},window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.handleLogin=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;s.processingAction=!0;const t=u("l-email").value,a=u("l-pass").value;if(!t||!a)return window.toast("Input missing"),void(s.processingAction=!1);window.setLoading(!0,"Signing In..."),localStorage.removeItem(n);const{error:r}=await l.auth.signInWithPassword({email:t,password:a});r&&(window.toast(r.message),window.setLoading(!1)),s.processingAction=!1},window.handleRegister=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;s.processingAction=!0;const n=u("r-name").value,a=u("r-email").value.trim().toLowerCase(),r=u("r-pass").value;if(!n||!a||r.length<8)return window.toast("Check inputs"),void(s.processingAction=!1);window.setLoading(!0,"Sending Code...");const[i,o]=await(async e=>{try{return[await e,null]}catch(e){return[null,e]}})(fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send",email:a})}));if(i){if(429===i.status)return window.toast("Too many attempts. Wait a minute."),s.processingAction=!1,void window.setLoading(!1);const e=await i.json();"Code sent"===e.message?(sessionStorage.setItem("temp_reg",JSON.stringify({n:n,em:a,p:r})),window.nav("scr-verify"),E(),window.setLoading(!1)):(window.toast(e.message||"Mail error"),window.setLoading(!1))}else window.toast("Network error"),window.setLoading(!1);s.processingAction=!1};const E=()=>{let e=t.verificationCodeExpiry;s.vTimer&&clearInterval(s.vTimer),s.vTimer=setInterval((()=>{e--,u("v-timer").innerText=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`,e<=0&&(clearInterval(s.vTimer),window.nav("scr-register"))}),1e3)};window.handleVerify=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;s.processingAction=!0;const a=u("v-code").value,r=JSON.parse(sessionStorage.getItem("temp_reg"));if(!r)return window.toast("Session expired"),void(s.processingAction=!1);window.setLoading(!0,"Verifying Code...");const i=await fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"verify",email:r.em,code:a})});if(429===i.status)return window.toast("Too many attempts."),s.processingAction=!1,void window.setLoading(!1);const o=await i.json();if("Verified"===o.message){localStorage.removeItem(n);const{error:e}=await l.auth.signUp({email:r.em,password:r.p,options:{data:{full_name:r.n}}});e&&(window.toast(e.message),window.setLoading(!1))}else window.toast(o.message||"Wrong code"),window.setLoading(!1);s.processingAction=!1},window.handleGuestLogin=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;let t=u("g-name").value.trim();const n=localStorage.getItem(a);if(n)t=n;else if(!t)return window.toast("Please enter a name.");n?await k(t):(window.openHub(),window.showOverlayView("guest-warn"))},window.confirmGuestLoginAction=async e=>{if(!e||!e.isTrusted)return;const t=u("g-name").value.trim();t&&await k(t)};const k=async e=>{window.closeOverlay(),window.setLoading(!0,"Initializing..."),localStorage.removeItem(n);const{data:{user:t}}=await l.auth.getUser();if(t&&t.is_anonymous){const n=t.user_metadata?.full_name;return n&&n===e?s.user=t:(await l.auth.updateUser({data:{full_name:e}}),s.user=t,s.user.user_metadata=s.user.user_metadata||{},s.user.user_metadata.full_name=e),await l.from("profiles").upsert({id:s.user.id,full_name:e,is_guest:!0}),localStorage.setItem(r,s.user.id),localStorage.setItem(a,e),window.nav("scr-lobby"),window.loadRooms(),window.forceClaimMaster(),void window.setLoading(!1)}const{data:i,error:o}=await l.auth.signInAnonymously();if(o)return window.toast(o.message),void window.setLoading(!1);i.user&&(await l.auth.updateUser({data:{full_name:e}}),await l.from("profiles").upsert({id:i.user.id,full_name:e,is_guest:!0}),s.user=i.user,s.user.user_metadata=s.user.user_metadata||{},s.user.user_metadata.full_name=e,localStorage.setItem(r,s.user.id),localStorage.setItem(a,e),window.nav("scr-lobby"),window.loadRooms(),window.forceClaimMaster()),window.setLoading(!1)};window.handleCreate=async e=>{if(!e||!e.isTrusted)return;if(s.serverFull)return window.toast("Network full");if(s.user?.is_anonymous)return window.toast("Guests cannot create rooms");if(s.processingAction)return;s.processingAction=!0;const t=u("c-name").value,n=u("c-pass").value,a=u("c-private").checked;if(a&&!n)return window.toast("Private rooms require a password"),void(s.processingAction=!1);if(!t)return window.toast("Name required"),void(s.processingAction=!1);window.setLoading(!0,"Deploying Room...");const r=(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("")})(),{data:i,error:o}=await l.from("rooms").insert([{name:t,has_password:!!n,is_private:a,salt:r,created_by:s.user.id}]).select();if(o)return window.toast("Error: "+o.message),s.processingAction=!1,void window.setLoading(!1);if(i&&i.length>0){const e=i[0];if(n){const t=await h(n+r);await l.rpc("set_room_password",{p_room_id:e.id,p_hash:t})}s.lastCreated=e,s.lastCreatedPass=n,u("s-id").innerText=e.id,window.nav("scr-success")}s.processingAction=!1,window.setLoading(!1)},window.submitGate=async e=>{if(!e||!e.isTrusted)return;const t=u("gate-pass").value,n=await h(t+s.pending.salt);window.setLoading(!0,"Verifying Access...");const{data:a,error:r}=await l.rpc("verify_room_password",{p_room_id:s.pending.id,p_hash:n});window.setLoading(!1),!0===a?window.openVault(s.pending.id,s.pending.name,t,s.pending.salt):window.toast("Access Denied")},window.handleLogout=async e=>{e&&e.isTrusted&&(window.setLoading(!0,"Switching Account..."),await b(),s.heartbeatInterval&&clearInterval(s.heartbeatInterval),s.uptimeInterval&&clearInterval(s.uptimeInterval),s.uptimeInterval=null,s.sessionStartTime=null,s.user&&s.user.is_anonymous?(localStorage.setItem(r,s.user.id),localStorage.setItem(a,s.user.user_metadata?.full_name),s.user=null,s.isMasterTab=!1,localStorage.setItem(n,"true"),window.nav("scr-start"),window.toast("Session saved.")):(localStorage.setItem(n,"true"),s.user=null,localStorage.removeItem(r),localStorage.removeItem(a),await l.auth.signOut(),window.nav("scr-start")),window.setLoading(!1))},window.copyId=()=>{navigator.clipboard.writeText(s.currentRoomId);const e=u("icon-copy-chat"),t=u("icon-check-chat");e.style.display="none",t.style.display="block",setTimeout((()=>{e.style.display="block",t.style.display="none"}),2e3)},window.copySId=()=>{navigator.clipboard.writeText(s.lastCreated.id),window.toast("ID Copied")},window.enterCreated=()=>{const e=s.lastCreatedPass;window.openVault(s.lastCreated.id,s.lastCreated.name,e,s.lastCreated.salt),s.lastCreatedPass=null};let H=0,P=0;document.addEventListener("touchstart",(e=>H=e.changedTouches[0].screenX),!1),document.addEventListener("touchend",(e=>{P=e.changedTouches[0].screenX;const t=document.querySelector(".screen.active");if(!t)return;const s=P-H;"scr-start"===t.id&&s<-50?window.nav("scr-guest","left"):"scr-guest"===t.id&&s>50&&window.nav("scr-start","right")}),!1),window.addEventListener("online",(()=>{u("offline-screen").classList.remove("active"),window.toast("Back online"),s.user&&s.isMasterTab&&I(!0)})),window.addEventListener("offline",(()=>{u("offline-screen").classList.add("active"),m(null),window.toast("Connection lost")})),l.auth.onAuthStateChange((async(e,t)=>{if("true"===localStorage.getItem(n))return void(s.user=null);s.user=t?.user;const i=u("icon-plus-lobby"),o=document.querySelector(".screen.active")?.id;if(i&&(i.style.display=s.user?.is_anonymous&&"scr-lobby"===o?"none":"flex"),"SIGNED_IN"===e&&s.user){localStorage.setItem(r,s.user.id),s.user.user_metadata?.full_name&&localStorage.setItem(a,s.user.user_metadata.full_name),s.sessionStartTime=Date.now(),s.uptimeInterval&&clearInterval(s.uptimeInterval),s.uptimeInterval=setInterval(w,1e3);["scr-start","scr-login","scr-register","scr-verify"].includes(o)&&(window.nav("scr-lobby"),window.loadRooms(),window.forceClaimMaster())}"SIGNED_OUT"===e&&(s.heartbeatInterval&&clearInterval(s.heartbeatInterval),s.uptimeInterval&&clearInterval(s.uptimeInterval),s.uptimeInterval=null,s.sessionStartTime=null,await b(),localStorage.removeItem(r),localStorage.removeItem(a),localStorage.removeItem(n),window.nav("scr-start"))}));(async()=>{if(navigator.onLine||u("offline-screen").classList.add("active"),"true"===localStorage.getItem(n))return s.user=null,window.nav("scr-start"),window.setLoading(!1),void L();const{data:{session:e}}=await l.auth.getSession();if(e){s.user=e.user,localStorage.setItem(r,s.user.id),s.user.user_metadata?.full_name&&localStorage.setItem(a,s.user.user_metadata.full_name);if(await new Promise((e=>{let t=!1;const s=e=>{"PONG_MASTER"===e.data.type&&(t=!0)};c.addEventListener("message",s),c.postMessage({type:"PING_MASTER"}),setTimeout((()=>{c.removeEventListener("message",s),e(t)}),300)}))){u("block-overlay").classList.add("active"),lucide.createIcons(),window.nav("scr-lobby"),window.loadRooms()}else window.forceClaimMaster(),window.nav("scr-lobby"),window.loadRooms();s.sessionStartTime=Date.now(),s.uptimeInterval&&clearInterval(s.uptimeInterval),s.uptimeInterval=setInterval(w,1e3)}else u("guest-swipe-hint").style.display="flex";lucide.createIcons(),window.setLoading(!1),L()})()}
