// assets/startChatAppFn.min.js | GH: HyperRushNet | 2026 | MIT License
import{createClient}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";export function startChatApp(e={}){const t={supabaseUrl:e.supabaseUrl||"https://fahbqdajxnhswevdagdn.supabase.co",supabaseKey:e.supabaseKey||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhaGJxZGFqeG5oc3dldmRhZ2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTEyODEsImV4cCI6MjA4NjEyNzI4MX0.UPgPxyaWBULjH4jL8UaSr6bJXTsFWWJRIYodHmXeVTI",mailApi:e.mailApi||"https://vercel-serverless-gray-sigma.vercel.app/api/mailAPI",maxUsers:e.maxUsers||475,maxMessages:e.maxMessages||15,historyLoadLimit:e.historyLoadLimit||10,rateLimitMs:e.rateLimitMs||1e3,presenceHeartbeatMs:e.presenceHeartbeatMs||1e4,reconnectDebounceMs:e.reconnectDebounceMs||3e3,verificationCodeExpiry:e.verificationCodeExpiry||600};lucide.createIcons();const s={user:null,currentRoomId:null,chatChannel:null,presenceChannel:null,allRooms:[],vTimer:null,lastRenderedDateLabel:null,lastKnownOnlineCount:null,heartbeatInterval:null,uptimeInterval:null,sessionStartTime:null,isPresenceSubscribed:!1,lastReconnectAttempt:0,roomGuestStatus:{},pending:null,lastCreated:null,lastCreatedPass:null,isMasterTab:!1,tabId:sessionStorage.getItem("hrn_tab_id")||(sessionStorage.setItem("hrn_tab_id",crypto.randomUUID()),sessionStorage.getItem("hrn_tab_id")),processingAction:!1,serverFull:!1,isLoadingHistory:!1,oldestMessageTimestamp:null,hasMoreHistory:!0,lastMessageTime:0,isConnecting:!1,isChatChannelReady:!1,currentRoomAccessType:null,currentRoomData:null,selectedAllowedUsers:[]},n="hrn_flag_force_logout",a="hrn_flag_guest_name",o="hrn_flag_guest_id";let i=[],r=!1;const c=new BroadcastChannel("hrn_tab_sync"),l=createClient(t.supabaseUrl,t.supabaseKey,{auth:{persistSession:!0,autoRefreshToken:!1},realtime:{params:{eventsPerSecond:10}}}),d=e=>{const t=document.createElement("p");return t.textContent=e,t.innerHTML},u=e=>document.getElementById(e),m=e=>{"number"==typeof e&&(s.lastKnownOnlineCount=e);const t="number"==typeof e?e:"--";document.querySelectorAll(".live-count").forEach((e=>{e.innerText!==t.toString()&&(e.innerText=t)}));const n=u("hub-online-count");n&&n.innerText!==t.toString()&&(n.innerText=t)},w=()=>{if(!s.sessionStartTime)return;const e=Math.floor((Date.now()-s.sessionStartTime)/1e3),t=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0"),a=u("hub-uptime");a&&(a.innerText=`${t}:${n}`)},p=()=>{if(r||0===i.length)return;r=!0;const e=i.shift(),t=u("toast-container"),s=document.createElement("div");s.className="toast-item",s.innerText=e,s.onclick=()=>{s.style.opacity="0",setTimeout((()=>{s.remove(),r=!1,p()}),400)},t.appendChild(s),setTimeout((()=>{s.parentNode&&(s.style.opacity="0",setTimeout((()=>{s.parentNode&&s.remove(),r=!1,p()}),400))}),3e3)};window.toast=e=>{i.push(e),p()},window.setLoading=(e,t=null)=>{const s=u("loader-overlay"),n=u("loader-text");e?s.classList.add("active"):s.classList.remove("active"),n.innerText=t||"Loading..."};const g=async e=>{try{return[await e,null]}catch(e){return[null,e]}},y=new Blob(["self.onmessage = async (e) => {\n    const { type, payload } = e.data;\n    const encoder = new TextEncoder();\n    const decoder = new TextDecoder();\n    try {\n      if (type === 'deriveKey') {\n        const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(payload.password), { name: 'PBKDF2' }, false, ['deriveKey']);\n        const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: encoder.encode(payload.salt), iterations: 300000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);\n        self.cryptoKey = key;\n        self.postMessage({ type: 'keyDerived', success: true });\n      } else if (type === 'encrypt') {\n        if (!self.cryptoKey) throw new Error(\"Key not derived\");\n        const iv = crypto.getRandomValues(new Uint8Array(12));\n        const encoded = encoder.encode(payload.text);\n        const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, self.cryptoKey, encoded);\n        const combined = new Uint8Array(iv.length + ciphertext.byteLength);\n        combined.set(iv, 0);\n        combined.set(new Uint8Array(ciphertext), iv.length);\n        const base64 = btoa(String.fromCharCode(...combined));\n        self.postMessage({ type: 'encrypted', result: base64 });\n      } else if (type === 'decryptHistory') {\n        if (!self.cryptoKey) throw new Error(\"Key not derived\");\n        const results = [];\n        for (const m of payload.messages) {\n          try {\n            const binary = atob(m.content);\n            const bytes = new Uint8Array(binary.length);\n            for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n            const iv = bytes.slice(0, 12);\n            const ciphertext = bytes.slice(12);\n            const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n            const text = decoder.decode(decrypted);\n            const parts = text.split('|');\n            results.push({ id: m.id, time: parts[0], text: parts.slice(1).join('|'), user_id: m.user_id, user_name: m.user_name, created_at: m.created_at });\n          } catch (err) {\n            results.push({ id: m.id, error: true });\n          }\n        }\n        self.postMessage({ type: 'historyDecrypted', results });\n      } else if (type === 'decryptSingle') {\n        if (!self.cryptoKey) throw new Error(\"Key not derived\");\n        try {\n          const binary = atob(payload.content);\n          const bytes = new Uint8Array(binary.length);\n          for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);\n          const iv = bytes.slice(0, 12);\n          const ciphertext = bytes.slice(12);\n          const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, self.cryptoKey, ciphertext);\n          const text = decoder.decode(decrypted);\n          const parts = text.split('|');\n          self.postMessage({ type: 'singleDecrypted', result: { time: parts[0], text: parts.slice(1).join('|') } });\n        } catch(e) {\n          self.postMessage({ type: 'singleDecrypted', error: e.message });\n        }\n      }\n    } catch (error) {\n      self.postMessage({ type: 'error', message: error.message });\n    }\n  };"],{type:"application/javascript"}),v=new Worker(URL.createObjectURL(y)),h={};v.onmessage=e=>{const{type:t}=e.data;h[t]&&(h[t](e.data),delete h[t])};const f=async e=>{const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")},b=e=>new Promise(((t,s)=>{h.encrypted=e=>{e.result?t(e.result):s("Encryption failed")};const n=(new Date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});v.postMessage({type:"encrypt",payload:{text:n+"|"+e}})})),_=async()=>{s.presenceChannel&&(s.presenceChannel.unsubscribe(),s.presenceChannel=null,s.isPresenceSubscribed=!1),s.chatChannel&&(s.chatChannel.unsubscribe(),s.chatChannel=null)},L=async()=>{if(!s.presenceChannel)return;const e=s.presenceChannel.presenceState(),n=Object.values(e).flat(),a=new Set(n.map((e=>e.user_id)));m(a.size),a.size>t.maxUsers?s.serverFull||(s.serverFull=!0,u("capacity-overlay").classList.add("active"),_()):s.serverFull=!1},I=async(e=!1)=>{if(!s.isMasterTab||!s.user)return;const n=Date.now();if(!e&&s.isConnecting)return;if(!e&&n-s.lastReconnectAttempt<t.reconnectDebounceMs)return;s.lastReconnectAttempt=n,s.isConnecting=!0,s.isPresenceSubscribed=!1,s.presenceChannel&&(s.presenceChannel.unsubscribe(),s.presenceChannel=null),m(null);const a=s.user.id;s.presenceChannel=l.channel("online-users",{config:{presence:{key:a}}}),s.presenceChannel.on("presence",{event:"sync"},(()=>{s.presenceChannel&&L()})).subscribe((async(e,n)=>{if("SUBSCRIBED"===e){if(!s.presenceChannel)return;s.isPresenceSubscribed=!0,s.isConnecting=!1,L(),await s.presenceChannel.track({user_id:a,online_at:(new Date).toISOString()}),L(),s.heartbeatInterval&&clearInterval(s.heartbeatInterval),s.heartbeatInterval=setInterval((async()=>{s.presenceChannel&&s.isMasterTab&&!s.serverFull&&await s.presenceChannel.track({user_id:a,online_at:(new Date).toISOString()})}),t.presenceHeartbeatMs),setTimeout((()=>{null===s.lastKnownOnlineCount&&s.isPresenceSubscribed&&!s.serverFull&&L()}),2e3)}else"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||(s.isPresenceSubscribed=!1,s.isConnecting=!1,m(null))}))},S=()=>{setInterval((()=>{if(!navigator.onLine)return u("offline-screen").classList.add("active"),s.isPresenceSubscribed=!1,void m(null);if(u("offline-screen").classList.remove("active"),!s.user||!s.isMasterTab)return;if(s.currentRoomId)return;const e=l.realtime.connectionState();"disconnected"!==e&&"stopped"!==e||s.isConnecting||I(!0),null!==s.lastKnownOnlineCount||!s.isPresenceSubscribed||s.isConnecting||s.serverFull||setTimeout((()=>{null!==s.lastKnownOnlineCount||!s.isPresenceSubscribed||s.isConnecting||s.serverFull||L()}),1e3)}),5e3)};window.retryConnection=()=>{u("capacity-overlay").classList.remove("active"),s.serverFull=!1,I(!0)},window.handlePrivateToggle=()=>{const e=u("c-private").checked;u("c-pass").placeholder=e?"Passkey (Required)":"Passkey (Optional)"},window.handleAccessToggle=(e=!0)=>{const t=e?"c":"edit-room",s=u(`${t}-restricted-view`);u(`${t}-access-everyone`).checked?s.style.display="none":s.style.display="block"},window.forceClaimMaster=()=>{s.isMasterTab||(s.isMasterTab=!0,c.postMessage({type:"CLAIM_MASTER",id:s.tabId}),u("block-overlay").classList.remove("active"),"true"!==localStorage.getItem(n)&&s.user&&I(!0))},window.closeTabAttempt=()=>{window.open("","_self"),window.close()},c.onmessage=e=>{if("CLAIM_MASTER"===e.data.type&&e.data.id!==s.tabId&&s.isMasterTab){_(),s.heartbeatInterval&&clearInterval(s.heartbeatInterval),s.heartbeatInterval=null,s.isPresenceSubscribed=!1,s.isMasterTab=!1,m(null);const e=u("block-overlay");e.innerHTML='\n          <i data-lucide="log-out" style="width:48px;height:48px;margin-bottom:24px;color:var(--danger)"></i>\n          <h1 class="title">Session Moved</h1>\n          <p class="subtitle" style="margin-bottom:48px">You switched to a new tab.</p>\n          <button class="btn btn-accent" onclick="window.forceClaimMaster()">Use Here</button>\n        ',e.classList.add("active"),lucide.createIcons()}"PING_MASTER"===e.data.type&&s.isMasterTab&&c.postMessage({type:"PONG_MASTER"})},window.addEventListener("beforeunload",(()=>{c.postMessage({type:"CLAIM_MASTER",id:s.tabId})}));window.showGuestInfo=()=>{u("overlay-container").classList.add("active"),window.showOverlayView("guest-info"),lucide.createIcons()},window.openHub=()=>{u("overlay-container").classList.add("active"),window.showOverlayView("hub"),lucide.createIcons()},window.closeOverlay=()=>u("overlay-container").classList.remove("active"),window.showOverlayView=e=>{const t=document.querySelector(".panel-card");if(!t)return;t.querySelectorAll(".view-content").forEach((e=>e.classList.remove("active")));const s=u(`view-${e}`);s&&(s.classList.add("active"),lucide.createIcons())},window.prepareMyAccount=()=>{if(!s.user)return;const e=s.user.is_anonymous;u("my-acc-name").innerText=s.user.user_metadata?.full_name||"User",u("my-acc-id").innerText=s.user.id,u("my-acc-email").innerText=e?"Guest Mode":s.user.email||"No email",u("my-acc-type").innerText=e?"Guest Account":"Full Account",u("my-acc-type").style.color=e?"var(--warning)":"var(--success)",window.showOverlayView("my-account")},window.inspectUser=async e=>{if(e===s.user?.id)return window.prepareMyAccount();window.setLoading(!0,"Fetching info...");const{data:t,error:n}=await l.from("profiles").select("id, full_name, updated_at, is_guest").eq("id",e).single();if(window.setLoading(!1),n||!t)return window.toast("User not found");u("qv-user-name").innerText=t.full_name,u("qv-user-avatar").innerText=t.full_name.charAt(0).toUpperCase(),u("qv-user-id").innerText=t.id,u("qv-full-name").innerText=t.full_name;const a=u("qv-status");a.innerText=t.is_guest?"Guest":"Registered",a.style.color=t.is_guest?"var(--warning)":"var(--success)";const o=new Date(t.updated_at);u("qv-user-date").innerText=o.toLocaleDateString("en-GB"),window.showOverlayView("quick-view-user"),u("overlay-container").classList.add("active")};window.nav=(e,t=null)=>{const n=document.querySelector(".screen.active"),o=u(e);if(!o)return;"scr-guest"===e&&(()=>{const e=localStorage.getItem(a),t=u("g-name"),s=document.querySelector(".input-lock-icon");e?(t.value=e,t.disabled=!0,t.placeholder="Identity Locked",s&&(s.style.display="block")):(t.value="",t.disabled=!1,t.placeholder="Enter Name (Permanent)",s&&(s.style.display="none")),lucide.createIcons()})(),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("slide-left","slide-right"))),"left"===t?(n.classList.add("slide-left"),o.classList.remove("slide-right")):"right"===t?(n.classList.add("slide-right"),o.classList.remove("slide-left")):document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".screen").forEach((e=>e.classList.remove("active"))),o.classList.add("active"),lucide.createIcons();const i=u("icon-plus-lobby");i&&(i.style.display=s.user?.is_anonymous&&"scr-lobby"===e?"none":"flex")},window.loadRooms=async()=>{if(!s.user)return;window.setLoading(!0,"Fetching accessible rooms...");const{data:e,error:t}=await l.from("rooms").select("*").order("created_at",{ascending:!1});if(t)return window.toast("Failed to load rooms"),void window.setLoading(!1);const n=[];for(const t of e||[]){const{data:e}=await l.rpc("can_access_room",{p_room_id:t.id});e&&n.push(t)}s.allRooms=n,window.filterRooms(),window.setLoading(!1)},window.filterRooms=()=>{const e=u("search-bar").value.toLowerCase(),t=u("room-list"),n=s.allRooms.filter((t=>t.name.toLowerCase().includes(e)));0===n.length?t.innerHTML='\n        <div class="empty-state">\n          <i data-lucide="folder" class="empty-state-icon"></i>\n          <div class="empty-state-title">No groups yet</div>\n          <div class="empty-state-sub">Create one or get invited.</div>\n        </div>\n      ':t.innerHTML=n.map((e=>`\n        <div class="room-card" onclick="window.joinAttempt('${e.id}')">\n          <span class="room-name">${d(e.name)}</span>\n          <span class="room-icon">\n            <i data-lucide="${e.has_password?"lock":"chevron-right"}" style="width:18px;height:18px;color:var(--text-mute)"></i>\n          </span>\n        </div>\n      `)).join(""),lucide.createIcons()},window.joinAttempt=async e=>{if(s.serverFull)return window.toast("Network is full");window.setLoading(!0,"Checking access...");const{data:t}=await l.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),window.toast("Access denied — you are not on the allowed list");const{data:n,error:a}=await l.from("rooms").select("*").eq("id",e).single();if(window.setLoading(!1),a||!n)return window.toast("Room not found");s.pending={id:n.id,name:n.name,salt:n.salt},s.currentRoomData=n,n.has_password?window.nav("scr-gate"):window.openVault(n.id,n.name,null,n.salt)},window.joinPrivate=async()=>{if(s.serverFull)return window.toast("Network is full");if(!s.user)return window.toast("Login required");const e=u("join-id").value.trim();if(!e)return;window.setLoading(!0,"Checking access...");const{data:t}=await l.rpc("can_access_room",{p_room_id:e});if(!t)return window.setLoading(!1),window.toast("Access denied — not allowed");const{data:n}=await l.from("rooms").select("*").eq("id",e).single();window.setLoading(!1),n?(s.pending={id:n.id,name:n.name,salt:n.salt},s.currentRoomData=n,n.has_password?window.nav("scr-gate"):window.openVault(n.id,n.name,null,n.salt)):window.toast("Not found")};const T=e=>{const t=new Date,s=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=Math.round((s-n)/864e5);return 0===a?"Today":1===a?"Yesterday":a<7?e.toLocaleDateString("en-GB",{weekday:"long"}):e.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})},C=e=>{let t=d(e);return t=t.replace(/(https?:\/\/[^\s]+)/g,(e=>{const t=e.replace(/[<>"']/g,"");return`<a href="${t}" target="_blank" rel="noopener noreferrer" class="chat-link">${t}</a>`})),t},A=()=>{const e=u("chat-messages"),t=u("chat-empty-state"),s=e.querySelector(".msg");t&&(t.style.display=s?"none":"flex")},M=(e,t=!1)=>{let n="";const a=new Date(e.created_at),o=T(a);t||o===s.lastRenderedDateLabel?t&&(n+=`<div class="date-divider"><span class="date-label">${o}</span></div>`,s.lastRenderedDateLabel=o):(n+=`<div class="date-divider"><span class="date-label">${o}</span></div>`,s.lastRenderedDateLabel=o);const i=s.roomGuestStatus[e.user_id]||!1,r=(i&&e.user_name,e.user_name),c=i?'<span class="guest-pill">Guest</span>':"",l=C(e.text);return n+=`\n      <div class="msg ${e.user_id===s.user?.id?"me":""}" data-time="${e.created_at}">\n        <span class="msg-user" onclick="window.inspectUser('${e.user_id}')">${d(r)} ${c}</span>\n        <div>${l}</div>\n        <span class="msg-time">${d(e.time)}</span>\n      </div>`,n},R=()=>{const e=u("chat-messages");e&&e.scrollTop<50&&!s.isLoadingHistory&&s.hasMoreHistory&&D()},x=async e=>{if(!e||0===e.length)return;const t=[...new Set(e)],{data:n,error:a}=await l.from("profiles").select("id, full_name, is_guest").in("id",t);n&&n.forEach((e=>{s.roomGuestStatus[e.id]=e.is_guest}))},D=async()=>{if(!s.oldestMessageTimestamp||!s.currentRoomId)return;s.isLoadingHistory=!0;const e=u("chat-messages"),n=e.scrollHeight;e.insertAdjacentHTML("afterbegin",'<div id="history-loader" class="history-loader">Loading...</div>');const{data:a,error:o}=await l.from("messages").select("*").eq("room_id",s.currentRoomId).lt("created_at",s.oldestMessageTimestamp).order("created_at",{ascending:!1}).limit(t.historyLoadLimit);if(u("history-loader")?.remove(),o||!a||0===a.length)return s.hasMoreHistory=!1,void(s.isLoadingHistory=!1);a.reverse(),h.historyDecrypted=async t=>{const a=t.results.filter((e=>!e.error));if(a.length>0){s.oldestMessageTimestamp=a[0].created_at;const t=a.map((e=>e.user_id));await x(t);const o=T(new Date(a[a.length-1].created_at)),i=e.querySelector(".msg");let r=null;if(i){const e=i.getAttribute("data-time");e&&(r=T(new Date(e)))}let c="",l=null;if(a.forEach(((e,t)=>{const n=T(new Date(e.created_at));n!==l&&(t===a.length-1&&n===r||(c+=`<div class="date-divider"><span class="date-label">${n}</span></div>`),l=n);const o=s.roomGuestStatus[e.user_id]||!1,i=(o&&e.user_name,e.user_name),u=o?'<span class="guest-pill">Guest</span>':"",m=C(e.text);c+=`\n            <div class="msg ${e.user_id===s.user?.id?"me":""}" data-time="${e.created_at}">\n              <span class="msg-user" onclick="window.inspectUser('${e.user_id}')">${d(i)} ${u}</span>\n              <div>${m}</div>\n              <span class="msg-time">${d(e.time)}</span>\n            </div>`})),o===r){const t=e.querySelector(".date-divider");t&&t.remove()}e.insertAdjacentHTML("afterbegin",c);const u=e.scrollHeight;e.scrollTop=u-n}s.isLoadingHistory=!1},v.postMessage({type:"decryptHistory",payload:{messages:a}})};window.openVault=async(e,n,a,o)=>{if(!s.user)return window.toast("Please login first");window.setLoading(!0,"Deriving Key..."),s.chatChannel&&s.chatChannel.unsubscribe(),s.currentRoomId=e,s.lastRenderedDateLabel=null,s.roomGuestStatus={},s.oldestMessageTimestamp=null,s.hasMoreHistory=!0,s.isLoadingHistory=!1,u("chat-title").innerText=n,u("chat-messages").innerHTML='<div id="chat-empty-state" class="empty-state"><i data-lucide="message-circle" class="empty-state-icon"></i><div class="empty-state-title">No messages yet</div><div class="empty-state-sub">Be the first to say something.</div></div>',u("chat-messages").onscroll=R;const i=u("icon-copy-chat"),r=u("icon-check-chat");i&&(i.style.display="block"),r&&(r.style.display="none");const c=a?a+e:e;try{await(d=c,m=o,new Promise(((e,t)=>{h.keyDerived=s=>{s.success?e(!0):t("Key derivation failed")},v.postMessage({type:"deriveKey",payload:{password:d,salt:m}})})))}catch(e){return window.setLoading(!1),window.toast("Key derivation failed")}var d,m;const{data:w}=await l.from("rooms").select("*").eq("id",e).single();s.currentRoomData=w;const p=w&&w.created_by===s.user.id,g=u("room-settings-icon");g&&(g.style.display=p?"block":"none"),window.setLoading(!0,"Fetching History...");const{data:y}=await l.from("messages").select("*").eq("room_id",e).order("created_at",{ascending:!1}).limit(t.maxMessages),f=s.user.is_anonymous,b=u("guest-info-chat");b&&(b.style.display=f?"flex":"none"),u("chat-input").style.display=f?"none":"block",u("guest-replies").style.display=f?"flex":"none",u("send-btn").style.display=f?"none":"flex",window.nav("scr-chat"),y&&y.length>0?(y.reverse(),y.length>0&&(s.oldestMessageTimestamp=y[0].created_at),window.setLoading(!0,"Decrypting..."),h.historyDecrypted=async e=>{const t=u("chat-messages");t.innerHTML="";const s=e.results.map((e=>e.user_id));await x(s),e.results.forEach((e=>{e.error||t.insertAdjacentHTML("beforeend",M(e))})),t.scrollTop=t.scrollHeight,A(),window.setLoading(!1)},v.postMessage({type:"decryptHistory",payload:{messages:y}})):(s.hasMoreHistory=!1,A(),window.setLoading(!1)),s.chatChannel=l.channel(`room_chat_${e}`,{config:{broadcast:{self:!0}}}),s.chatChannel.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${e}`},(async e=>{const t=e.new;t&&s.currentRoomId&&(h.singleDecrypted=async e=>{if(e.result){await x([t.user_id]);const s={...t,time:e.result.time,text:e.result.text},n=u("chat-messages");n.insertAdjacentHTML("beforeend",M(s)),n.scrollTop=n.scrollHeight,A()}},v.postMessage({type:"decryptSingle",payload:{content:t.content}}))})).subscribe((e=>{"SUBSCRIBED"===e?s.isChatChannelReady=!0:"CLOSED"!==e&&"CHANNEL_ERROR"!==e&&"TIMED_OUT"!==e||(s.isChatChannelReady=!1)}))};const k=()=>{const e=Date.now();if(e-s.lastMessageTime<t.rateLimitMs){const n=t.rateLimitMs-(e-s.lastMessageTime);return u("chat-input-area").classList.add("rate-limited"),setTimeout((()=>{u("chat-input-area").classList.remove("rate-limited")}),n),!1}return!0};window.sendMsg=async e=>{if(!e||!e.isTrusted)return;if(!s.user||!s.currentRoomId)return;if(s.processingAction)return;if(!s.isChatChannelReady)return void window.toast("Connection not ready yet – please wait a moment");if(!k())return;s.processingAction=!0;const t=u("chat-input").value.trim();if(t){u("chat-input").value="",s.lastMessageTime=Date.now();try{const e=await b(t);await l.from("messages").insert([{room_id:s.currentRoomId,user_id:s.user.id,user_name:s.user.user_metadata?.full_name,content:e}])}catch(e){window.toast("Failed to send")}s.processingAction=!1}else s.processingAction=!1},window.sendGuestReply=async(e,t)=>{if(e&&e.isTrusted&&s.user&&s.currentRoomId&&!s.processingAction)if(s.isChatChannelReady){if(k()){s.processingAction=!0,s.lastMessageTime=Date.now();try{const e=await b(t);await l.from("messages").insert([{room_id:s.currentRoomId,user_id:s.user.id,user_name:s.user.user_metadata?.full_name,content:e}])}catch(e){}s.processingAction=!1}}else window.toast("Connection not ready yet – please wait a moment")},window.leaveChat=async()=>{window.setLoading(!0,"Leaving Room..."),s.chatChannel&&s.chatChannel.unsubscribe(),s.chatChannel=null,s.currentRoomId=null,s.roomGuestStatus={},s.currentRoomAccessType=null,s.currentRoomData=null;const e=u("room-settings-icon");e&&(e.style.display="none"),window.nav("scr-lobby"),window.loadRooms(),window.setLoading(!1)},window.handleLogin=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;s.processingAction=!0;const t=u("l-email").value,a=u("l-pass").value;if(!t||!a)return window.toast("Input missing"),void(s.processingAction=!1);window.setLoading(!0,"Signing In..."),localStorage.removeItem(n);const{error:o}=await l.auth.signInWithPassword({email:t,password:a});o?(window.toast(o.message),window.setLoading(!1)):await I(!0),s.processingAction=!1},window.handleRegister=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;s.processingAction=!0;const n=u("r-name").value,a=u("r-email").value.trim().toLowerCase(),o=u("r-pass").value;if(!n||!a||o.length<8)return window.toast("Check inputs"),void(s.processingAction=!1);window.setLoading(!0,"Sending Code...");const[i,r]=await g(fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send",email:a})}));if(i){if(429===i.status)return window.toast("Too many attempts. Wait a minute."),s.processingAction=!1,void window.setLoading(!1);const e=await i.json();"Code sent"===e.message?(sessionStorage.setItem("temp_reg",JSON.stringify({n:n,em:a,p:o})),window.nav("scr-verify"),E(),window.setLoading(!1)):(window.toast(e.message||"Mail error"),window.setLoading(!1))}else window.toast("Network error"),window.setLoading(!1);s.processingAction=!1};const E=()=>{let e=t.verificationCodeExpiry;s.vTimer&&clearInterval(s.vTimer),s.vTimer=setInterval((()=>{e--,u("v-timer").innerText=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`,e<=0&&(clearInterval(s.vTimer),window.nav("scr-register"))}),1e3)};window.handleVerify=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;s.processingAction=!0;const a=u("v-code").value,o=JSON.parse(sessionStorage.getItem("temp_reg"));if(!o)return window.toast("Session expired"),void(s.processingAction=!1);window.setLoading(!0,"Verifying Code...");const i=await fetch(t.mailApi,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"verify",email:o.em,code:a})});if(429===i.status)return window.toast("Too many attempts."),s.processingAction=!1,void window.setLoading(!1);const r=await i.json();if("Verified"===r.message){localStorage.removeItem(n);const{error:e}=await l.auth.signUp({email:o.em,password:o.p,options:{data:{full_name:o.n}}});e?(window.toast(e.message),window.setLoading(!1)):await I(!0)}else window.toast(r.message||"Wrong code"),window.setLoading(!1);s.processingAction=!1},window.handleGuestLogin=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;let t=u("g-name").value.trim();const n=localStorage.getItem(a);if(n)t=n;else if(!t)return window.toast("Please enter a name.");n?(await U(t),await I(!0)):(window.openHub(),window.showOverlayView("guest-warn"))},window.confirmGuestLoginAction=async e=>{if(!e||!e.isTrusted)return;const t=u("g-name").value.trim();t&&await U(t)};const U=async e=>{window.closeOverlay(),window.setLoading(!0,"Initializing..."),localStorage.removeItem(n);const{data:{user:t}}=await l.auth.getUser();let i;if(t&&t.is_anonymous){const s=t.user_metadata?.full_name;s&&s===e?i=t:(await l.auth.updateUser({data:{full_name:e}}),i=t,i.user_metadata=i.user_metadata||{},i.user_metadata.full_name=e)}else{const{data:e,error:t}=await l.auth.signInAnonymously();if(t)return window.toast(t.message||"Anonymous login failed"),void window.setLoading(!1);i=e.user,await new Promise((e=>setTimeout(e,1e3))),await l.auth.refreshSession();const s=await l.auth.getSession();i=s.data.session?.user||i}await l.auth.updateUser({data:{full_name:e}}),await l.from("profiles").upsert({id:i.id,full_name:e,is_guest:!0}),s.user=i,s.user.user_metadata=s.user.user_metadata||{},s.user.user_metadata.full_name=e,localStorage.setItem(o,s.user.id),localStorage.setItem(a,e),window.nav("scr-lobby"),window.loadRooms(),await new Promise((e=>setTimeout(e,800))),window.forceClaimMaster(),window.setLoading(!1),await I(!0)},H=e=>{const t=u(e);if(!t)return;const n=s.selectedAllowedUsers.filter((e=>e.id!==s.user.id));0!==n.length?(t.innerHTML=n.map((t=>`\n      <div class="user-chip">\n        <div class="user-chip-info">\n            <span class="user-chip-name">${d(t.name)}</span>\n            <span class="user-chip-id">${t.id.substring(0,8)}...</span>\n        </div>\n        <button class="user-chip-remove" onclick="window.removeAllowedUser('${t.id}', '${e}')">\n            <i data-lucide="x" class="w-14 h-14"></i>\n        </button>\n      </div>\n    `)).join(""),lucide.createIcons()):t.innerHTML='<div class="empty-state" style="padding:20px;"><div class="empty-state-sub">No users added yet.</div></div>'};window.removeAllowedUser=(e,t)=>{s.selectedAllowedUsers=s.selectedAllowedUsers.filter((t=>t.id!==e)),H(t)},window.searchUsersToAdd=async(e,t,n)=>{const a=u(e).value.trim(),o=u(t);if(o.innerHTML="",a.length<2)return;const{data:i,error:r}=await l.from("profiles").select("id, full_name").or(`full_name.ilike.%${a}%,id.eq.${a}`).limit(5);if(r||!i)return;const c=s.selectedAllowedUsers.map((e=>e.id)),m=i.filter((e=>!c.includes(e.id)&&e.id!==s.user.id));0!==m.length?(o.innerHTML=m.map((e=>`\n      <div class="search-result-item" onclick="window.addAllowedUser('${e.id}', '${d(e.full_name)}', '${t}', '${n}')">\n        <i data-lucide="user" class="w-14 h-14"></i>\n        <div class="search-result-info">\n            <span class="search-result-name">${d(e.full_name)}</span>\n            <span class="search-result-id">${e.id.substring(0,12)}...</span>\n        </div>\n        <i data-lucide="plus" class="w-14 h-14"></i>\n      </div>\n    `)).join(""),lucide.createIcons()):o.innerHTML='<div class="search-result-item" style="opacity:0.5">No users found</div>'},window.addAllowedUser=(e,t,n,a)=>{s.selectedAllowedUsers.find((t=>t.id===e))||(s.selectedAllowedUsers.push({id:e,name:t}),u(n).innerHTML="",H(a))},window.handleCreate=async e=>{if(!e||!e.isTrusted)return;if(s.serverFull)return window.toast("Network full");if(s.user?.is_anonymous)return window.toast("Guests cannot create rooms");if(s.processingAction)return;s.processingAction=!0;const t=u("c-name").value.trim(),n=u("c-pass").value,a=u("c-private").checked;let o=["*"];if(!u("c-access-everyone").checked&&(o=s.selectedAllowedUsers.map((e=>e.id)),o.includes(s.user.id)||o.push(s.user.id),0===o.length))return window.toast("Please select at least one user"),void(s.processingAction=!1);if(a&&!n)return window.toast("Private rooms require a password"),void(s.processingAction=!1);if(!t)return window.toast("Name required"),void(s.processingAction=!1);window.setLoading(!0,"Deploying Room...");const i=(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("")})(),{data:r,error:c}=await l.from("rooms").insert([{name:t,has_password:!!n,is_private:a,salt:i,created_by:s.user.id,allowed_users:o}]).select();if(c)return window.toast("Error: "+c.message),s.processingAction=!1,void window.setLoading(!1);if(r&&r.length>0){const e=r[0];if(n){const t=await f(n+i);await l.rpc("set_room_password",{p_room_id:e.id,p_hash:t})}s.lastCreated=e,s.lastCreatedPass=n,u("s-id").innerText=e.id,window.nav("scr-success")}s.processingAction=!1,window.setLoading(!1)},window.submitGate=async e=>{if(!e||!e.isTrusted)return;const t=u("gate-pass").value,n=await f(t+s.pending.salt);window.setLoading(!0,"Verifying Access...");const{data:a,error:o}=await l.rpc("verify_room_password",{p_room_id:s.pending.id,p_hash:n});window.setLoading(!1),!0===a?window.openVault(s.pending.id,s.pending.name,t,s.pending.salt):window.toast("Access Denied")},window.handleLogout=async e=>{e&&e.isTrusted&&(window.setLoading(!0,"Switching Account..."),s.heartbeatInterval&&clearInterval(s.heartbeatInterval),s.uptimeInterval&&clearInterval(s.uptimeInterval),s.uptimeInterval=null,s.sessionStartTime=null,s.presenceChannel&&s.presenceChannel.unsubscribe(),s.chatChannel&&s.chatChannel.unsubscribe(),s.user&&s.user.is_anonymous?(localStorage.setItem(o,s.user.id),localStorage.setItem(a,s.user.user_metadata?.full_name),s.user=null,s.isMasterTab=!1,window.nav("scr-start"),window.toast("Guest session saved. Refresh to restore.")):(localStorage.setItem(n,"true"),s.user=null,localStorage.removeItem(o),localStorage.removeItem(a),await l.auth.signOut(),window.nav("scr-start")),window.setLoading(!1))},window.copyId=()=>{navigator.clipboard.writeText(s.currentRoomId);const e=u("icon-copy-chat"),t=u("icon-check-chat");e.style.display="none",t.style.display="block",setTimeout((()=>{e.style.display="block",t.style.display="none"}),2e3)},window.copySId=()=>{navigator.clipboard.writeText(s.lastCreated.id),window.toast("ID Copied")},window.enterCreated=()=>{const e=s.lastCreatedPass;window.openVault(s.lastCreated.id,s.lastCreated.name,e,s.lastCreated.salt),s.lastCreatedPass=null};let $=0,P=0;document.addEventListener("touchstart",(e=>$=e.changedTouches[0].screenX),!1),document.addEventListener("touchend",(e=>{P=e.changedTouches[0].screenX;const t=document.querySelector(".screen.active");if(!t)return;const s=P-$;"scr-start"===t.id&&s<-50?window.nav("scr-guest","left"):"scr-guest"===t.id&&s>50&&window.nav("scr-start","right")}),!1),window.addEventListener("online",(()=>{u("offline-screen").classList.remove("active"),window.toast("Back online"),s.user&&s.isMasterTab&&I(!0)})),window.addEventListener("offline",(()=>{u("offline-screen").classList.add("active"),m(null),window.toast("Connection lost")})),l.auth.onAuthStateChange((async(e,t)=>{const i="true"===localStorage.getItem(n),r=localStorage.getItem(o);if(i&&r&&localStorage.removeItem(n),"true"===localStorage.getItem(n))return void(s.user=null);s.user=t?.user;const c=u("icon-plus-lobby"),l=document.querySelector(".screen.active")?.id;if(c&&(c.style.display=s.user?.is_anonymous&&"scr-lobby"===l?"none":"flex"),"SIGNED_IN"===e&&s.user){localStorage.setItem(o,s.user.id),s.user.user_metadata?.full_name&&localStorage.setItem(a,s.user.user_metadata.full_name),s.sessionStartTime=Date.now(),s.uptimeInterval&&clearInterval(s.uptimeInterval),s.uptimeInterval=setInterval(w,1e3);["scr-start","scr-login","scr-register","scr-verify"].includes(l)&&(window.nav("scr-lobby"),window.loadRooms(),window.forceClaimMaster())}"SIGNED_OUT"===e&&(s.heartbeatInterval&&clearInterval(s.heartbeatInterval),s.uptimeInterval&&clearInterval(s.uptimeInterval),s.uptimeInterval=null,s.sessionStartTime=null,s.presenceChannel&&s.presenceChannel.unsubscribe(),s.chatChannel&&s.chatChannel.unsubscribe(),r||(localStorage.removeItem(o),localStorage.removeItem(a)),localStorage.removeItem(n),window.nav("scr-start"))})),window.openRoomSettings=async()=>{if(!s.currentRoomId||!s.currentRoomData||s.currentRoomData.created_by!==s.user.id)return window.toast("You are not the owner of this room");window.setLoading(!0,"Loading room settings...");const e=s.currentRoomData;u("edit-room-name").value=e.name,u("edit-room-private").checked=e.is_private,u("edit-room-pass").value="";if(e.allowed_users.includes("*"))u("edit-room-access-everyone").checked=!0,u("edit-room-restricted-view").style.display="none",s.selectedAllowedUsers=[];else{u("edit-room-access-selected").checked=!0,u("edit-room-restricted-view").style.display="block";const t=e.allowed_users,{data:n}=await l.from("profiles").select("id, full_name").in("id",t);s.selectedAllowedUsers=t.map((e=>{const t=n?.find((t=>t.id===e));return{id:e,name:t?.full_name||"Unknown"}}))}H("edit-room-users-grid"),u("overlay-container").classList.add("active"),window.showOverlayView("room-settings"),window.setLoading(!1)},window.saveRoomSettings=async e=>{if(!e||!e.isTrusted)return;if(s.processingAction)return;s.processingAction=!0;const t=u("edit-room-name").value.trim(),n=u("edit-room-private").checked,a=u("edit-room-pass").value,o=u("edit-room-access-everyone").checked;if(!t)return window.toast("Room name is required"),void(s.processingAction=!1);let i=["*"];if(!o&&(i=s.selectedAllowedUsers.map((e=>e.id)),i.includes(s.user.id)||i.push(s.user.id),0===i.length))return window.toast("Select at least one user"),void(s.processingAction=!1);window.setLoading(!0,"Saving changes...");const r={name:t,is_private:n,allowed_users:i},{error:c}=await l.from("rooms").update(r).eq("id",s.currentRoomId);if(c)return window.toast("Failed to update room: "+c.message),window.setLoading(!1),void(s.processingAction=!1);if(a){const e=s.currentRoomData.salt,t=await f(a+e),{error:n}=await l.rpc("set_room_password",{p_room_id:s.currentRoomId,p_hash:t});n?window.toast("Failed to update password"):(await l.from("rooms").update({has_password:!0}).eq("id",s.currentRoomId),s.currentRoomData.has_password=!0)}const{data:d}=await l.from("rooms").select("*").eq("id",s.currentRoomId).single();s.currentRoomData=d,u("chat-title").innerText=d.name,window.toast("Room settings saved"),window.closeOverlay(),s.processingAction=!1,window.setLoading(!1)};(async()=>{if(!navigator.onLine)return void u("offline-screen").classList.add("active");if(localStorage.getItem(o)&&localStorage.removeItem(n),"true"===localStorage.getItem(n))return s.user=null,window.nav("scr-start"),window.setLoading(!1),void S();const[e,t]=await g(l.auth.getSession());if(t)return console.error("Failed to get session:",t),window.toast("Failed to get session"),window.nav("scr-start"),window.setLoading(!1),void S();const i=e.data.session;if(i){s.user=i.user,localStorage.setItem(o,s.user.id),s.user.user_metadata?.full_name&&localStorage.setItem(a,s.user.user_metadata.full_name);if(await new Promise((e=>{let t=!1;const s=e=>{"PONG_MASTER"===e.data.type&&(t=!0)};c.addEventListener("message",s),c.postMessage({type:"PING_MASTER"}),setTimeout((()=>{c.removeEventListener("message",s),e(t)}),300)}))){u("block-overlay").classList.add("active"),lucide.createIcons(),window.nav("scr-lobby"),window.loadRooms()}else window.forceClaimMaster(),window.nav("scr-lobby"),window.loadRooms();s.sessionStartTime=Date.now(),s.uptimeInterval&&clearInterval(s.uptimeInterval),s.uptimeInterval=setInterval(w,1e3),await I(!0)}else u("guest-swipe-hint").style.display="flex";lucide.createIcons(),window.setLoading(!1),S()})()}
